/*! For license information please see app.min.js.LICENSE.txt */
(()=>{var e={597:(e,t)=>{"use strict";var a=/; *([!#$%&'*+.^_`|~0-9A-Za-z-]+) *= *("(?:[\u000b\u0020\u0021\u0023-\u005b\u005d-\u007e\u0080-\u00ff]|\\[\u000b\u0020-\u00ff])*"|[!#$%&'*+.^_`|~0-9A-Za-z-]+) */g,i=/^[\u000b\u0020-\u007e\u0080-\u00ff]+$/,n=/^[!#$%&'*+.^_`|~0-9A-Za-z-]+$/,r=/\\([\u000b\u0020-\u00ff])/g,s=/([\\"])/g,o=/^[!#$%&'*+.^_`|~0-9A-Za-z-]+\/[!#$%&'*+.^_`|~0-9A-Za-z-]+$/;function c(e){var t=String(e);if(n.test(t))return t;if(t.length>0&&!i.test(t))throw new TypeError("invalid parameter value");return'"'+t.replace(s,"\\$1")+'"'}function l(e){this.parameters=Object.create(null),this.type=e}t.format=function(e){if(!e||"object"!=typeof e)throw new TypeError("argument obj is required");var t=e.parameters,a=e.type;if(!a||!o.test(a))throw new TypeError("invalid type");var i=a;if(t&&"object"==typeof t)for(var r,s=Object.keys(t).sort(),l=0;l<s.length;l++){if(r=s[l],!n.test(r))throw new TypeError("invalid parameter name");i+="; "+r+"="+c(t[r])}return i},t.parse=function(e){if(!e)throw new TypeError("argument string is required");var t="object"==typeof e?function(e){var t;if("function"==typeof e.getHeader?t=e.getHeader("content-type"):"object"==typeof e.headers&&(t=e.headers&&e.headers["content-type"]),"string"!=typeof t)throw new TypeError("content-type header is missing from object");return t}(e):e;if("string"!=typeof t)throw new TypeError("argument string is required to be a string");var i=t.indexOf(";"),n=-1!==i?t.slice(0,i).trim():t.trim();if(!o.test(n))throw new TypeError("invalid media type");var s=new l(n.toLowerCase());if(-1!==i){var c,m,u;for(a.lastIndex=i;m=a.exec(t);){if(m.index!==i)throw new TypeError("invalid parameter format");i+=m[0].length,c=m[1].toLowerCase(),34===(u=m[2]).charCodeAt(0)&&-1!==(u=u.slice(1,-1)).indexOf("\\")&&(u=u.replace(r,"$1")),s.parameters[c]=u}if(i!==t.length)throw new TypeError("invalid parameter format")}return s}},833:(e,t,a)=>{t.formatArgs=function(t){if(t[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+t[0]+(this.useColors?"%c ":" ")+"+"+e.exports.humanize(this.diff),!this.useColors)return;const a="color: "+this.color;t.splice(1,0,a,"color: inherit");let i=0,n=0;t[0].replace(/%[a-zA-Z%]/g,(e=>{"%%"!==e&&(i++,"%c"===e&&(n=i))})),t.splice(n,0,a)},t.save=function(e){try{e?t.storage.setItem("debug",e):t.storage.removeItem("debug")}catch(e){}},t.load=function(){let e;try{e=t.storage.getItem("debug")}catch(e){}return!e&&"undefined"!=typeof process&&"env"in process&&(e=process.env.DEBUG),e},t.useColors=function(){if("undefined"!=typeof window&&window.process&&("renderer"===window.process.type||window.process.__nwjs))return!0;if("undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))return!1;let e;return"undefined"!=typeof document&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||"undefined"!=typeof window&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||"undefined"!=typeof navigator&&navigator.userAgent&&(e=navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/))&&parseInt(e[1],10)>=31||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)},t.storage=function(){try{return localStorage}catch(e){}}(),t.destroy=(()=>{let e=!1;return()=>{e||(e=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})(),t.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"],t.log=console.debug||console.log||(()=>{}),e.exports=a(736)(t);const{formatters:i}=e.exports;i.j=function(e){try{return JSON.stringify(e)}catch(e){return"[UnexpectedJSONParseError]: "+e.message}}},736:(e,t,a)=>{e.exports=function(e){function t(e){let a,n,r,s=null;function o(...e){if(!o.enabled)return;const i=o,n=Number(new Date),r=n-(a||n);i.diff=r,i.prev=a,i.curr=n,a=n,e[0]=t.coerce(e[0]),"string"!=typeof e[0]&&e.unshift("%O");let s=0;e[0]=e[0].replace(/%([a-zA-Z%])/g,((a,n)=>{if("%%"===a)return"%";s++;const r=t.formatters[n];if("function"==typeof r){const t=e[s];a=r.call(i,t),e.splice(s,1),s--}return a})),t.formatArgs.call(i,e),(i.log||t.log).apply(i,e)}return o.namespace=e,o.useColors=t.useColors(),o.color=t.selectColor(e),o.extend=i,o.destroy=t.destroy,Object.defineProperty(o,"enabled",{enumerable:!0,configurable:!1,get:()=>null!==s?s:(n!==t.namespaces&&(n=t.namespaces,r=t.enabled(e)),r),set:e=>{s=e}}),"function"==typeof t.init&&t.init(o),o}function i(e,a){const i=t(this.namespace+(void 0===a?":":a)+e);return i.log=this.log,i}function n(e){return e.toString().substring(2,e.toString().length-2).replace(/\.\*\?$/,"*")}return t.debug=t,t.default=t,t.coerce=function(e){return e instanceof Error?e.stack||e.message:e},t.disable=function(){const e=[...t.names.map(n),...t.skips.map(n).map((e=>"-"+e))].join(",");return t.enable(""),e},t.enable=function(e){let a;t.save(e),t.namespaces=e,t.names=[],t.skips=[];const i=("string"==typeof e?e:"").split(/[\s,]+/),n=i.length;for(a=0;a<n;a++)i[a]&&("-"===(e=i[a].replace(/\*/g,".*?"))[0]?t.skips.push(new RegExp("^"+e.slice(1)+"$")):t.names.push(new RegExp("^"+e+"$")))},t.enabled=function(e){if("*"===e[e.length-1])return!0;let a,i;for(a=0,i=t.skips.length;a<i;a++)if(t.skips[a].test(e))return!1;for(a=0,i=t.names.length;a<i;a++)if(t.names[a].test(e))return!0;return!1},t.humanize=a(585),t.destroy=function(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")},Object.keys(e).forEach((a=>{t[a]=e[a]})),t.names=[],t.skips=[],t.formatters={},t.selectColor=function(e){let a=0;for(let t=0;t<e.length;t++)a=(a<<5)-a+e.charCodeAt(t),a|=0;return t.colors[Math.abs(a)%t.colors.length]},t.enable(t.load()),t}},251:(e,t)=>{t.L=function(e,t,a,i,n){var r,s,o=8*n-i-1,c=(1<<o)-1,l=c>>1,m=-7,u=a?n-1:0,d=a?-1:1,h=e[t+u];for(u+=d,r=h&(1<<-m)-1,h>>=-m,m+=o;m>0;r=256*r+e[t+u],u+=d,m-=8);for(s=r&(1<<-m)-1,r>>=-m,m+=i;m>0;s=256*s+e[t+u],u+=d,m-=8);if(0===r)r=1-l;else{if(r===c)return s?NaN:1/0*(h?-1:1);s+=Math.pow(2,i),r-=l}return(h?-1:1)*s*Math.pow(2,r-i)},t.M=function(e,t,a,i,n,r){var s,o,c,l=8*r-n-1,m=(1<<l)-1,u=m>>1,d=23===n?Math.pow(2,-24)-Math.pow(2,-77):0,h=i?0:r-1,p=i?1:-1,f=t<0||0===t&&1/t<0?1:0;for(t=Math.abs(t),isNaN(t)||t===1/0?(o=isNaN(t)?1:0,s=m):(s=Math.floor(Math.log(t)/Math.LN2),t*(c=Math.pow(2,-s))<1&&(s--,c*=2),(t+=s+u>=1?d/c:d*Math.pow(2,1-u))*c>=2&&(s++,c/=2),s+u>=m?(o=0,s=m):s+u>=1?(o=(t*c-1)*Math.pow(2,n),s+=u):(o=t*Math.pow(2,u-1)*Math.pow(2,n),s=0));n>=8;e[a+h]=255&o,h+=p,o/=256,n-=8);for(s=s<<n|o,l+=n;l>0;e[a+h]=255&s,h+=p,s/=256,l-=8);e[a+h-p]|=128*f}},864:(e,t)=>{"use strict";var a=/^ *([A-Za-z0-9][A-Za-z0-9!#$&^_-]{0,126})\/([A-Za-z0-9][A-Za-z0-9!#$&^_.+-]{0,126}) *$/;function i(e,t,a){this.type=e,this.subtype=t,this.suffix=a}t.qg=function(e){if(!e)throw new TypeError("argument string is required");if("string"!=typeof e)throw new TypeError("argument string is required to be a string");var t=a.exec(e.toLowerCase());if(!t)throw new TypeError("invalid media type");var n,r=t[1],s=t[2],o=s.lastIndexOf("+");return-1!==o&&(n=s.substr(o+1),s=s.substr(0,o)),new i(r,s,n)}},585:e=>{var t=1e3,a=60*t,i=60*a,n=24*i,r=7*n;function s(e,t,a,i){var n=t>=1.5*a;return Math.round(e/a)+" "+i+(n?"s":"")}e.exports=function(e,o){o=o||{};var c,l,m=typeof e;if("string"===m&&e.length>0)return function(e){if(!((e=String(e)).length>100)){var s=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(e);if(s){var o=parseFloat(s[1]);switch((s[2]||"ms").toLowerCase()){case"years":case"year":case"yrs":case"yr":case"y":return 315576e5*o;case"weeks":case"week":case"w":return o*r;case"days":case"day":case"d":return o*n;case"hours":case"hour":case"hrs":case"hr":case"h":return o*i;case"minutes":case"minute":case"mins":case"min":case"m":return o*a;case"seconds":case"second":case"secs":case"sec":case"s":return o*t;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return o;default:return}}}}(e);if("number"===m&&isFinite(e))return o.long?(c=e,(l=Math.abs(c))>=n?s(c,l,n,"day"):l>=i?s(c,l,i,"hour"):l>=a?s(c,l,a,"minute"):l>=t?s(c,l,t,"second"):c+" ms"):function(e){var r=Math.abs(e);return r>=n?Math.round(e/n)+"d":r>=i?Math.round(e/i)+"h":r>=a?Math.round(e/a)+"m":r>=t?Math.round(e/t)+"s":e+"ms"}(e);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(e))}},88:function(e,t,a){"use strict";var i=this&&this.__createBinding||(Object.create?function(e,t,a,i){void 0===i&&(i=a);var n=Object.getOwnPropertyDescriptor(t,a);n&&!("get"in n?!t.__esModule:n.writable||n.configurable)||(n={enumerable:!0,get:function(){return t[a]}}),Object.defineProperty(e,i,n)}:function(e,t,a,i){void 0===i&&(i=a),e[i]=t[a]}),n=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),r=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var a in e)"default"!==a&&Object.prototype.hasOwnProperty.call(e,a)&&i(t,e,a);return n(t,e),t},s=this&&this.__awaiter||function(e,t,a,i){return new(a||(a=Promise))((function(n,r){function s(e){try{c(i.next(e))}catch(e){r(e)}}function o(e){try{c(i.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof a?t:new a((function(e){e(t)}))).then(s,o)}c((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const o=r(a(233));let c=[];const l=new AudioContext,m=l.createGain();m.connect(l.destination);let u=null,d=null,h=0,p=0,f=document.getElementById("file"),g=document.getElementById("loading");f.onchange=()=>s(void 0,void 0,void 0,(function*(){var e;g.innerHTML="loading...",f.disabled=!0;try{if(!f.files)return;let t=f.files[0],a=yield t.arrayBuffer();const i=yield o.parseWebStream(yield t.stream());if(null==i||null==i.native||null==i.format||null==i.format.sampleRate)return void alert("failed to read audio data.");let n=null,r=null,s=null;if(null!=i.native.vorbis){const e=i.native.vorbis.find((e=>"LOOPSTART"===e.id.toUpperCase())),t=i.native.vorbis.find((e=>"LOOPLENGTH"===e.id.toUpperCase())),a=i.native.vorbis.find((e=>"LOOPEND"===e.id.toUpperCase()));void 0!==e&&(n=Number(e.value)),void 0!==t&&(r=Number(t.value)),void 0!==a&&(s=Number(a.value)),null==s&&null!=n&&null!=r&&(s=n+r),null==r&&null!=n&&null!=s&&(r=s-n)}let m=yield l.decodeAudioData(a);const u={file:t,metadata:i,loopStart:n,loopLength:r,loopEnd:s,title:i.common.title?i.common.title:t.name,artist:i.common.artist,arrayBuffer:m,id:p++};void 0===u.metadata.format.numberOfSamples&&(u.metadata.format.numberOfSamples=Math.ceil(u.metadata.format.duration*u.metadata.format.sampleRate)),c.push(u);let d=document.createElement("tr");{let e=document.createElement("td"),t=document.createElement("input");t.type="radio",t.name="selected",t.value=String(u.id),e.appendChild(t),d.appendChild(e)}{let e=document.createElement("td");e.innerText=u.title,d.appendChild(e)}{let e=document.createElement("td");e.innerText=y(u.metadata.format.duration),d.appendChild(e)}{let e=document.createElement("td");e.innerText=u.loopStart&&u.loopEnd?"Loop":"",d.appendChild(e)}{let t=document.createElement("td");t.innerText=null!==(e=u.artist)&&void 0!==e?e:"",d.appendChild(t)}{let e=document.createElement("td"),t=document.createElement("button");t.innerText="Remove",t.name="Remove",t.value=String(u.id),t.addEventListener("click",S),e.appendChild(t),d.appendChild(e)}document.getElementById("tbody").appendChild(d)}finally{f.disabled=!1,g.innerHTML=""}})),document.getElementById("button-play").onclick=()=>{let e=-1,t=document.getElementsByName("selected");for(let a=0;a<t.length;a++)if(t.item(a).checked){e=Number(t.item(a).value);break}if(-1===e)return void alert("not selected");if(d=c.find((t=>t.id==e)),!d)return void alert("file not found");if(T(),w(0),!u)return void alert("internal error (source is undefined)");"suspended"===l.state&&l.resume();let a=document.getElementById("sound-title");a&&(a.innerHTML="Title:"+d.title+(d.artist?" / "+d.artist:""));let i=document.getElementById("sound-loop-range");i&&(i.innerHTML="LoopRange:"+y(u.loopStart)+"-"+y(u.loopEnd))},document.getElementById("button-pause").onclick=()=>{"suspended"===l.state?l.resume():l.suspend()},document.getElementById("button-stop").onclick=()=>{T()};let k=document.getElementById("range-volume");k.oninput=()=>{m.gain.value=Number(k.value)};let b=document.getElementById("seekbar");function w(e){d&&(u=l.createBufferSource(),u.connect(m),u.buffer=d.arrayBuffer,u.start(0,e),h=l.currentTime-e,u.loop=!0,null!==d.loopStart&&null!==d.loopEnd&&(u.loopStart=d.loopStart/d.metadata.format.sampleRate,u.loopEnd=d.loopEnd/d.metadata.format.sampleRate,e>=u.loopEnd&&(u.loop=!1)))}function T(){u&&(u.stop(0),u.disconnect(),u=null)}function y(e){let t=Math.floor(e/3600),a=Math.floor(e/60%60),i=Math.floor(e%60),n=Math.floor(100*e)%100;return("0"+t).slice(-2)+":"+("0"+a).slice(-2)+":"+("0"+i).slice(-2)+"."+("0"+n).slice(-2)}function v(){if(!d||!u)return 0;let e=l.currentTime-h;if(null!==d.loopStart&&null!==d.loopEnd&&null!==d.loopLength&&!0===u.loop){let t=d.loopEnd/d.metadata.format.sampleRate;for(;e>t;)e-=d.loopLength/d.metadata.format.sampleRate}else if(!0===u.loop){let t=d.metadata.format.duration;for(;e>t;)e-=t}else e=Math.min(e,d.metadata.format.duration);return e}function S(e){c=c.filter((t=>t.id!=Number(e.target.value)));const t=document.getElementById("tbody");for(let a=0;a<t.children.length;a++)if(t.children[a].children[0].children[0].value==e.target.value){t.deleteRow(a);break}}b.onmouseup=e=>{if(!u||!d)return;const t=b,a=e.target.getBoundingClientRect(),i=(Math.max(Math.min(e.clientX-a.left,t.width-5),5)-5)/(t.width-10)*d.metadata.format.duration;T(),w(i)},setInterval((function(){const e=document.getElementById("seekbar"),t=e.getContext("2d");if(t&&(t.clearRect(0,0,e.width,e.height),t.fillStyle="rgb(230, 230, 230)",t.fillRect(0,0,e.width,e.height),t.fillStyle="rgb(255, 255, 255)",t.fillRect(5,5,e.width-10,e.height-10),u&&d)){null!==d.loopStart&&null!==d.loopEnd&&null!==d.loopLength&&(t.fillStyle="rgb(54, 132, 228)",t.fillRect((e.width-10)*(d.loopStart/d.metadata.format.numberOfSamples)+5,5,(e.width-10)*(d.loopLength/d.metadata.format.numberOfSamples),e.height-10));let a=v()/d.metadata.format.duration*(e.width-10);t.fillStyle="rgb(0, 0, 0)",t.fillRect(a,0,10,e.height),t.fillStyle="rgb(255, 255, 255)",t.fillRect(a+1,1,8,e.height-2)}}),50),setInterval((function(){if(u){const e=document.getElementById("sound-current-time");e&&(e.innerHTML="CurrentTime:"+y(v()))}}),100)},233:(e,t,a)=>{"use strict";a.r(t),a.d(t,{LyricsContentType:()=>he,TimestampFormat:()=>pe,orderTags:()=>wn,parseBlob:()=>fn,parseBuffer:()=>kn,parseFromTokenizer:()=>bn,parseWebStream:()=>gn,ratingToStars:()=>Tn,scanAppendingHeaders:()=>vn,selectCover:()=>yn});var i={};a.r(i),a.d(i,{AnsiStringType:()=>G,Float16_BE:()=>M,Float16_LE:()=>P,Float32_BE:()=>_,Float32_LE:()=>R,Float64_BE:()=>B,Float64_LE:()=>O,Float80_BE:()=>L,Float80_LE:()=>N,INT16_BE:()=>v,INT16_LE:()=>S,INT24_BE:()=>C,INT24_LE:()=>I,INT32_BE:()=>x,INT32_LE:()=>A,INT64_BE:()=>D,INT64_LE:()=>E,INT8:()=>y,IgnoreType:()=>U,StringType:()=>j,UINT16_BE:()=>g,UINT16_LE:()=>f,UINT24_BE:()=>b,UINT24_LE:()=>k,UINT32_BE:()=>T,UINT32_LE:()=>w,UINT64_BE:()=>F,UINT64_LE:()=>z,UINT8:()=>p,Uint8ArrayType:()=>$});class n extends Error{constructor(){super("End-Of-Stream")}}class r{constructor(){this.maxStreamReadSize=1048576,this.endOfStream=!1,this.peekQueue=[]}async peek(e,t,a){const i=await this.read(e,t,a);return this.peekQueue.push(e.subarray(t,t+i)),i}async read(e,t,a){if(0===a)return 0;let i=this.readFromPeekBuffer(e,t,a);if(i+=await this.readRemainderFromStream(e,t+i,a-i),0===i)throw new n;return i}readFromPeekBuffer(e,t,a){let i=a,n=0;for(;this.peekQueue.length>0&&i>0;){const a=this.peekQueue.pop();if(!a)throw new Error("peekData should be defined");const r=Math.min(a.length,i);e.set(a.subarray(0,r),t+n),n+=r,i-=r,r<a.length&&this.peekQueue.push(a.subarray(r))}return n}async readRemainderFromStream(e,t,a){let i=a,n=0;for(;i>0&&!this.endOfStream;){const a=Math.min(i,this.maxStreamReadSize),r=await this.readFromStream(e,t+n,a);if(0===r)break;n+=r,i-=r}return n}}class s extends r{constructor(e){super(),this.reader=e.getReader({mode:"byob"})}async readFromStream(e,t,a){if(this.endOfStream)throw new n;const i=await this.reader.read(new Uint8Array(a));return i.done&&(this.endOfStream=i.done),i.value?(e.set(i.value,t),i.value.byteLength):0}}class o{constructor(e){this.position=0,this.numBuffer=new Uint8Array(8),this.fileInfo=e?.fileInfo??{},this.onClose=e?.onClose}async readToken(e,t=this.position){const a=new Uint8Array(e.len);if(await this.readBuffer(a,{position:t})<e.len)throw new n;return e.get(a,0)}async peekToken(e,t=this.position){const a=new Uint8Array(e.len);if(await this.peekBuffer(a,{position:t})<e.len)throw new n;return e.get(a,0)}async readNumber(e){if(await this.readBuffer(this.numBuffer,{length:e.len})<e.len)throw new n;return e.get(this.numBuffer,0)}async peekNumber(e){if(await this.peekBuffer(this.numBuffer,{length:e.len})<e.len)throw new n;return e.get(this.numBuffer,0)}async ignore(e){if(void 0!==this.fileInfo.size){const t=this.fileInfo.size-this.position;if(e>t)return this.position+=t,t}return this.position+=e,e}async close(){await(this.onClose?.())}normalizeOptions(e,t){if(t&&void 0!==t.position&&t.position<this.position)throw new Error("`options.position` must be equal or greater than `tokenizer.position`");return t?{mayBeLess:!0===t.mayBeLess,offset:t.offset?t.offset:0,length:t.length?t.length:e.length-(t.offset?t.offset:0),position:t.position?t.position:this.position}:{mayBeLess:!1,offset:0,length:e.length,position:this.position}}}class c extends o{constructor(e,t){super(t),this.streamReader=e}async readBuffer(e,t){const a=this.normalizeOptions(e,t),i=a.position-this.position;if(i>0)return await this.ignore(i),this.readBuffer(e,t);if(i<0)throw new Error("`options.position` must be equal or greater than `tokenizer.position`");if(0===a.length)return 0;const r=await this.streamReader.read(e,a.offset,a.length);if(this.position+=r,(!t||!t.mayBeLess)&&r<a.length)throw new n;return r}async peekBuffer(e,t){const a=this.normalizeOptions(e,t);let i=0;if(a.position){const t=a.position-this.position;if(t>0){const n=new Uint8Array(a.length+t);return i=await this.peekBuffer(n,{mayBeLess:a.mayBeLess}),e.set(n.subarray(t),a.offset),i-t}if(t<0)throw new Error("Cannot peek from a negative offset in a stream")}if(a.length>0){try{i=await this.streamReader.peek(e,a.offset,a.length)}catch(e){if(t?.mayBeLess&&e instanceof n)return 0;throw e}if(!a.mayBeLess&&i<a.length)throw new n}return i}async ignore(e){const t=Math.min(256e3,e),a=new Uint8Array(t);let i=0;for(;i<e;){const n=e-i,r=await this.readBuffer(a,{length:Math.min(t,n)});if(r<0)return r;i+=r}return i}}class l extends o{constructor(e,t){super(t),this.uint8Array=e,this.fileInfo.size=this.fileInfo.size?this.fileInfo.size:e.length}async readBuffer(e,t){if(t?.position){if(t.position<this.position)throw new Error("`options.position` must be equal or greater than `tokenizer.position`");this.position=t.position}const a=await this.peekBuffer(e,t);return this.position+=a,a}async peekBuffer(e,t){const a=this.normalizeOptions(e,t),i=Math.min(this.uint8Array.length-a.position,a.length);if(!a.mayBeLess&&i<a.length)throw new n;return e.set(this.uint8Array.subarray(a.position,a.position+i),a.offset),i}close(){return super.close()}}function m(e,t){return new c(new s(e),t)}function u(e,t){return new l(e,t)}var d=a(251);function h(e){return new DataView(e.buffer,e.byteOffset)}const p={len:1,get:(e,t)=>h(e).getUint8(t),put:(e,t,a)=>(h(e).setUint8(t,a),t+1)},f={len:2,get:(e,t)=>h(e).getUint16(t,!0),put:(e,t,a)=>(h(e).setUint16(t,a,!0),t+2)},g={len:2,get:(e,t)=>h(e).getUint16(t),put:(e,t,a)=>(h(e).setUint16(t,a),t+2)},k={len:3,get(e,t){const a=h(e);return a.getUint8(t)+(a.getUint16(t+1,!0)<<8)},put(e,t,a){const i=h(e);return i.setUint8(t,255&a),i.setUint16(t+1,a>>8,!0),t+3}},b={len:3,get(e,t){const a=h(e);return(a.getUint16(t)<<8)+a.getUint8(t+2)},put(e,t,a){const i=h(e);return i.setUint16(t,a>>8),i.setUint8(t+2,255&a),t+3}},w={len:4,get:(e,t)=>h(e).getUint32(t,!0),put:(e,t,a)=>(h(e).setUint32(t,a,!0),t+4)},T={len:4,get:(e,t)=>h(e).getUint32(t),put:(e,t,a)=>(h(e).setUint32(t,a),t+4)},y={len:1,get:(e,t)=>h(e).getInt8(t),put:(e,t,a)=>(h(e).setInt8(t,a),t+1)},v={len:2,get:(e,t)=>h(e).getInt16(t),put:(e,t,a)=>(h(e).setInt16(t,a),t+2)},S={len:2,get:(e,t)=>h(e).getInt16(t,!0),put:(e,t,a)=>(h(e).setInt16(t,a,!0),t+2)},I={len:3,get(e,t){const a=k.get(e,t);return a>8388607?a-16777216:a},put(e,t,a){const i=h(e);return i.setUint8(t,255&a),i.setUint16(t+1,a>>8,!0),t+3}},C={len:3,get(e,t){const a=b.get(e,t);return a>8388607?a-16777216:a},put(e,t,a){const i=h(e);return i.setUint16(t,a>>8),i.setUint8(t+2,255&a),t+3}},x={len:4,get:(e,t)=>h(e).getInt32(t),put:(e,t,a)=>(h(e).setInt32(t,a),t+4)},A={len:4,get:(e,t)=>h(e).getInt32(t,!0),put:(e,t,a)=>(h(e).setInt32(t,a,!0),t+4)},z={len:8,get:(e,t)=>h(e).getBigUint64(t,!0),put:(e,t,a)=>(h(e).setBigUint64(t,a,!0),t+8)},E={len:8,get:(e,t)=>h(e).getBigInt64(t,!0),put:(e,t,a)=>(h(e).setBigInt64(t,a,!0),t+8)},F={len:8,get:(e,t)=>h(e).getBigUint64(t),put:(e,t,a)=>(h(e).setBigUint64(t,a),t+8)},D={len:8,get:(e,t)=>h(e).getBigInt64(t),put:(e,t,a)=>(h(e).setBigInt64(t,a),t+8)},M={len:2,get(e,t){return d.L(e,t,!1,10,this.len)},put(e,t,a){return d.M(e,a,t,!1,10,this.len),t+this.len}},P={len:2,get(e,t){return d.L(e,t,!0,10,this.len)},put(e,t,a){return d.M(e,a,t,!0,10,this.len),t+this.len}},_={len:4,get:(e,t)=>h(e).getFloat32(t),put:(e,t,a)=>(h(e).setFloat32(t,a),t+4)},R={len:4,get:(e,t)=>h(e).getFloat32(t,!0),put:(e,t,a)=>(h(e).setFloat32(t,a,!0),t+4)},B={len:8,get:(e,t)=>h(e).getFloat64(t),put:(e,t,a)=>(h(e).setFloat64(t,a),t+8)},O={len:8,get:(e,t)=>h(e).getFloat64(t,!0),put:(e,t,a)=>(h(e).setFloat64(t,a,!0),t+8)},L={len:10,get(e,t){return d.L(e,t,!1,63,this.len)},put(e,t,a){return d.M(e,a,t,!1,63,this.len),t+this.len}},N={len:10,get(e,t){return d.L(e,t,!0,63,this.len)},put(e,t,a){return d.M(e,a,t,!0,63,this.len),t+this.len}};class U{constructor(e){this.len=e}get(e,t){}}class ${constructor(e){this.len=e}get(e,t){return e.subarray(t,t+this.len)}}class j{constructor(e,t){this.len=e,this.encoding=t,this.textDecoder=new TextDecoder(t)}get(e,t){return this.textDecoder.decode(e.subarray(t,t+this.len))}}class G{constructor(e){this.len=e,this.textDecoder=new TextDecoder("windows-1252")}get(e,t=0){return this.textDecoder.decode(e.subarray(t,t+this.len))}}const X=Object.prototype.toString,W="[object Uint8Array]",H="[object ArrayBuffer]";function V(e,t,a){return!!e&&(e.constructor===t||X.call(e)===a)}function q(e){return V(e,Uint8Array,W)}const K={utf8:new globalThis.TextDecoder("utf8")};function Y(e,t="utf8"){return function(e){if(!function(e){return q(e)||function(e){return V(e,ArrayBuffer,H)}(e)}(e))throw new TypeError(`Expected \`Uint8Array\` or \`ArrayBuffer\`, got \`${typeof e}\``)}(e),K[t]??=new globalThis.TextDecoder(t),K[t].decode(e)}function Z(e){if("string"!=typeof e)throw new TypeError(`Expected \`string\`, got \`${typeof e}\``)}const J=new globalThis.TextEncoder;const Q=Array.from({length:256},((e,t)=>t.toString(16).padStart(2,"0")));function ee(e){!function(e){if(!q(e))throw new TypeError(`Expected \`Uint8Array\`, got \`${typeof e}\``)}(e);let t="";for(let a=0;a<e.length;a++)t+=Q[e[a]];return t}const te={0:0,1:1,2:2,3:3,4:4,5:5,6:6,7:7,8:8,9:9,a:10,b:11,c:12,d:13,e:14,f:15,A:10,B:11,C:12,D:13,E:14,F:15};function ae(e){if(Z(e),e.length%2!=0)throw new Error("Invalid Hex string length.");const t=e.length/2,a=new Uint8Array(t);for(let i=0;i<t;i++){const t=te[e[2*i]],n=te[e[2*i+1]];if(void 0===t||void 0===n)throw new Error("Invalid Hex character encountered at position "+2*i);a[i]=t<<4|n}return a}function ie(e){const{byteLength:t}=e;return 6===t?e.getUint16(0)*2**32+e.getUint32(2):5===t?e.getUint8(0)*2**32+e.getUint32(1):4===t?e.getUint32(0):3===t?65536*e.getUint8(0)+e.getUint16(1):2===t?e.getUint16(0):1===t?e.getUint8(0):void 0}function ne(e,t){const a=e.length,i=t.length;if(0===i)return-1;if(i>a)return-1;const n=a-i;for(let a=0;a<=n;a++){let n=!0;for(let r=0;r<i;r++)if(e[a+r]!==t[r]){n=!1;break}if(n)return a}return-1}const re={get:(e,t)=>127&e[t+3]|e[t+2]<<7|e[t+1]<<14|e[t]<<21,len:4},se=4100;async function oe(e){return(new le).fromBuffer(e)}function ce(e,t,a){a={offset:0,...a};for(const[i,n]of t.entries())if(a.mask){if(n!==(a.mask[i]&e[i+a.offset]))return!1}else if(n!==e[i+a.offset])return!1;return!0}class le{constructor(e){this.detectors=e?.customDetectors,this.fromTokenizer=this.fromTokenizer.bind(this),this.fromBuffer=this.fromBuffer.bind(this),this.parse=this.parse.bind(this)}async fromTokenizer(e){const t=e.position;for(const a of this.detectors||[]){const i=await a(e);if(i)return i;if(t!==e.position)return}return this.parse(e)}async fromBuffer(e){if(!(e instanceof Uint8Array||e instanceof ArrayBuffer))throw new TypeError(`Expected the \`input\` argument to be of type \`Uint8Array\` or \`ArrayBuffer\`, got \`${typeof e}\``);const t=e instanceof Uint8Array?e:new Uint8Array(e);if(t?.length>1)return this.fromTokenizer(u(t))}async fromBlob(e){return this.fromStream(e.stream())}async fromStream(e){const t=await m(e);try{return await this.fromTokenizer(t)}finally{await t.close()}}async toDetectionStream(e,t){const{sampleSize:a=se}=t;let i,r;const s=e.getReader({mode:"byob"});try{const{value:e,done:t}=await s.read(new Uint8Array(a));if(r=e,!t&&e)try{i=await this.fromBuffer(e.slice(0,a))}catch(e){if(!(e instanceof n))throw e;i=void 0}r=e}finally{s.releaseLock()}const o=new TransformStream({async start(e){e.enqueue(r)},transform(e,t){t.enqueue(e)}}),c=e.pipeThrough(o);return c.fileType=i,c}check(e,t){return ce(this.buffer,e,t)}checkString(e,t){return this.check((a=e,[...a].map((e=>e.charCodeAt(0)))),t);var a}async parse(e){if(this.buffer=new Uint8Array(se),void 0===e.fileInfo.size&&(e.fileInfo.size=Number.MAX_SAFE_INTEGER),this.tokenizer=e,await e.peekBuffer(this.buffer,{length:12,mayBeLess:!0}),this.check([66,77]))return{ext:"bmp",mime:"image/bmp"};if(this.check([11,119]))return{ext:"ac3",mime:"audio/vnd.dolby.dd-raw"};if(this.check([120,1]))return{ext:"dmg",mime:"application/x-apple-diskimage"};if(this.check([77,90]))return{ext:"exe",mime:"application/x-msdownload"};if(this.check([37,33]))return await e.peekBuffer(this.buffer,{length:24,mayBeLess:!0}),this.checkString("PS-Adobe-",{offset:2})&&this.checkString(" EPSF-",{offset:14})?{ext:"eps",mime:"application/eps"}:{ext:"ps",mime:"application/postscript"};if(this.check([31,160])||this.check([31,157]))return{ext:"Z",mime:"application/x-compress"};if(this.check([199,113]))return{ext:"cpio",mime:"application/x-cpio"};if(this.check([96,234]))return{ext:"arj",mime:"application/x-arj"};if(this.check([239,187,191]))return this.tokenizer.ignore(3),this.parse(e);if(this.check([71,73,70]))return{ext:"gif",mime:"image/gif"};if(this.check([73,73,188]))return{ext:"jxr",mime:"image/vnd.ms-photo"};if(this.check([31,139,8]))return{ext:"gz",mime:"application/gzip"};if(this.check([66,90,104]))return{ext:"bz2",mime:"application/x-bzip2"};if(this.checkString("ID3")){await e.ignore(6);const t=await e.readToken(re);return e.position+t>e.fileInfo.size?{ext:"mp3",mime:"audio/mpeg"}:(await e.ignore(t),this.fromTokenizer(e))}if(this.checkString("MP+"))return{ext:"mpc",mime:"audio/x-musepack"};if((67===this.buffer[0]||70===this.buffer[0])&&this.check([87,83],{offset:1}))return{ext:"swf",mime:"application/x-shockwave-flash"};if(this.check([255,216,255]))return this.check([247],{offset:3})?{ext:"jls",mime:"image/jls"}:{ext:"jpg",mime:"image/jpeg"};if(this.check([79,98,106,1]))return{ext:"avro",mime:"application/avro"};if(this.checkString("FLIF"))return{ext:"flif",mime:"image/flif"};if(this.checkString("8BPS"))return{ext:"psd",mime:"image/vnd.adobe.photoshop"};if(this.checkString("WEBP",{offset:8}))return{ext:"webp",mime:"image/webp"};if(this.checkString("MPCK"))return{ext:"mpc",mime:"audio/x-musepack"};if(this.checkString("FORM"))return{ext:"aif",mime:"audio/aiff"};if(this.checkString("icns",{offset:0}))return{ext:"icns",mime:"image/icns"};if(this.check([80,75,3,4])){try{for(;e.position+30<e.fileInfo.size;){await e.readBuffer(this.buffer,{length:30});const a=new DataView(this.buffer.buffer),i={compressedSize:a.getUint32(18,!0),uncompressedSize:a.getUint32(22,!0),filenameLength:a.getUint16(26,!0),extraFieldLength:a.getUint16(28,!0)};if(i.filename=await e.readToken(new j(i.filenameLength,"utf-8")),await e.ignore(i.extraFieldLength),"META-INF/mozilla.rsa"===i.filename)return{ext:"xpi",mime:"application/x-xpinstall"};if(i.filename.endsWith(".rels")||i.filename.endsWith(".xml"))switch(i.filename.split("/")[0]){case"_rels":default:break;case"word":return{ext:"docx",mime:"application/vnd.openxmlformats-officedocument.wordprocessingml.document"};case"ppt":return{ext:"pptx",mime:"application/vnd.openxmlformats-officedocument.presentationml.presentation"};case"xl":return{ext:"xlsx",mime:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"};case"visio":return{ext:"vsdx",mime:"application/vnd.visio"}}if(i.filename.startsWith("xl/"))return{ext:"xlsx",mime:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"};if(i.filename.startsWith("3D/")&&i.filename.endsWith(".model"))return{ext:"3mf",mime:"model/3mf"};if("mimetype"===i.filename&&i.compressedSize===i.uncompressedSize){let r=await e.readToken(new j(i.compressedSize,"utf-8"));switch(r=r.trim(),r){case"application/epub+zip":return{ext:"epub",mime:"application/epub+zip"};case"application/vnd.oasis.opendocument.text":return{ext:"odt",mime:"application/vnd.oasis.opendocument.text"};case"application/vnd.oasis.opendocument.spreadsheet":return{ext:"ods",mime:"application/vnd.oasis.opendocument.spreadsheet"};case"application/vnd.oasis.opendocument.presentation":return{ext:"odp",mime:"application/vnd.oasis.opendocument.presentation"}}}if(0===i.compressedSize){let s=-1;for(;s<0&&e.position<e.fileInfo.size;)await e.peekBuffer(this.buffer,{mayBeLess:!0}),s=ne(this.buffer,new Uint8Array([80,75,3,4])),await e.ignore(s>=0?s:this.buffer.length)}else await e.ignore(i.compressedSize)}}catch(o){if(!(o instanceof n))throw o}return{ext:"zip",mime:"application/zip"}}if(this.checkString("OggS")){await e.ignore(28);const c=new Uint8Array(8);return await e.readBuffer(c),ce(c,[79,112,117,115,72,101,97,100])?{ext:"opus",mime:"audio/opus"}:ce(c,[128,116,104,101,111,114,97])?{ext:"ogv",mime:"video/ogg"}:ce(c,[1,118,105,100,101,111,0])?{ext:"ogm",mime:"video/ogg"}:ce(c,[127,70,76,65,67])?{ext:"oga",mime:"audio/ogg"}:ce(c,[83,112,101,101,120,32,32])?{ext:"spx",mime:"audio/ogg"}:ce(c,[1,118,111,114,98,105,115])?{ext:"ogg",mime:"audio/ogg"}:{ext:"ogx",mime:"application/ogg"}}if(this.check([80,75])&&(3===this.buffer[2]||5===this.buffer[2]||7===this.buffer[2])&&(4===this.buffer[3]||6===this.buffer[3]||8===this.buffer[3]))return{ext:"zip",mime:"application/zip"};if(this.checkString("ftyp",{offset:4})&&96&this.buffer[8]){const l=new j(4,"latin1").get(this.buffer,8).replace("\0"," ").trim();switch(l){case"avif":case"avis":return{ext:"avif",mime:"image/avif"};case"mif1":return{ext:"heic",mime:"image/heif"};case"msf1":return{ext:"heic",mime:"image/heif-sequence"};case"heic":case"heix":return{ext:"heic",mime:"image/heic"};case"hevc":case"hevx":return{ext:"heic",mime:"image/heic-sequence"};case"qt":return{ext:"mov",mime:"video/quicktime"};case"M4V":case"M4VH":case"M4VP":return{ext:"m4v",mime:"video/x-m4v"};case"M4P":return{ext:"m4p",mime:"video/mp4"};case"M4B":return{ext:"m4b",mime:"audio/mp4"};case"M4A":return{ext:"m4a",mime:"audio/x-m4a"};case"F4V":return{ext:"f4v",mime:"video/mp4"};case"F4P":return{ext:"f4p",mime:"video/mp4"};case"F4A":return{ext:"f4a",mime:"audio/mp4"};case"F4B":return{ext:"f4b",mime:"audio/mp4"};case"crx":return{ext:"cr3",mime:"image/x-canon-cr3"};default:return l.startsWith("3g")?l.startsWith("3g2")?{ext:"3g2",mime:"video/3gpp2"}:{ext:"3gp",mime:"video/3gpp"}:{ext:"mp4",mime:"video/mp4"}}}if(this.checkString("MThd"))return{ext:"mid",mime:"audio/midi"};if(this.checkString("wOFF")&&(this.check([0,1,0,0],{offset:4})||this.checkString("OTTO",{offset:4})))return{ext:"woff",mime:"font/woff"};if(this.checkString("wOF2")&&(this.check([0,1,0,0],{offset:4})||this.checkString("OTTO",{offset:4})))return{ext:"woff2",mime:"font/woff2"};if(this.check([212,195,178,161])||this.check([161,178,195,212]))return{ext:"pcap",mime:"application/vnd.tcpdump.pcap"};if(this.checkString("DSD "))return{ext:"dsf",mime:"audio/x-dsf"};if(this.checkString("LZIP"))return{ext:"lz",mime:"application/x-lzip"};if(this.checkString("fLaC"))return{ext:"flac",mime:"audio/x-flac"};if(this.check([66,80,71,251]))return{ext:"bpg",mime:"image/bpg"};if(this.checkString("wvpk"))return{ext:"wv",mime:"audio/wavpack"};if(this.checkString("%PDF")){try{await e.ignore(1350);const m=10485760,u=new Uint8Array(Math.min(m,e.fileInfo.size));if(await e.readBuffer(u,{mayBeLess:!0}),-1!==ne(u,(new TextEncoder).encode("AIPrivateData")))return{ext:"ai",mime:"application/postscript"}}catch(d){if(!(d instanceof n))throw d}return{ext:"pdf",mime:"application/pdf"}}if(this.check([0,97,115,109]))return{ext:"wasm",mime:"application/wasm"};if(this.check([73,73])){const h=await this.readTiffHeader(!1);if(h)return h}if(this.check([77,77])){const f=await this.readTiffHeader(!0);if(f)return f}if(this.checkString("MAC "))return{ext:"ape",mime:"audio/ape"};if(this.check([26,69,223,163])){async function g(){const t=await e.peekNumber(p);let a=128,i=0;for(;!(t&a)&&0!==a;)++i,a>>=1;const n=new Uint8Array(i+1);return await e.readBuffer(n),n}async function k(){const e=await g(),t=await g();t[0]^=128>>t.length-1;const a=Math.min(6,t.length),i=new DataView(e.buffer),n=new DataView(t.buffer,t.length-a,a);return{id:ie(i),len:ie(n)}}async function b(t){for(;t>0;){const a=await k();if(17026===a.id)return(await e.readToken(new j(a.len))).replaceAll(/\00.*$/g,"");await e.ignore(a.len),--t}}const w=await k();switch(await b(w.len)){case"webm":return{ext:"webm",mime:"video/webm"};case"matroska":return{ext:"mkv",mime:"video/x-matroska"};default:return}}if(this.check([82,73,70,70])){if(this.check([65,86,73],{offset:8}))return{ext:"avi",mime:"video/vnd.avi"};if(this.check([87,65,86,69],{offset:8}))return{ext:"wav",mime:"audio/wav"};if(this.check([81,76,67,77],{offset:8}))return{ext:"qcp",mime:"audio/qcelp"}}if(this.checkString("SQLi"))return{ext:"sqlite",mime:"application/x-sqlite3"};if(this.check([78,69,83,26]))return{ext:"nes",mime:"application/x-nintendo-nes-rom"};if(this.checkString("Cr24"))return{ext:"crx",mime:"application/x-google-chrome-extension"};if(this.checkString("MSCF")||this.checkString("ISc("))return{ext:"cab",mime:"application/vnd.ms-cab-compressed"};if(this.check([237,171,238,219]))return{ext:"rpm",mime:"application/x-rpm"};if(this.check([197,208,211,198]))return{ext:"eps",mime:"application/eps"};if(this.check([40,181,47,253]))return{ext:"zst",mime:"application/zstd"};if(this.check([127,69,76,70]))return{ext:"elf",mime:"application/x-elf"};if(this.check([33,66,68,78]))return{ext:"pst",mime:"application/vnd.ms-outlook"};if(this.checkString("PAR1"))return{ext:"parquet",mime:"application/x-parquet"};if(this.check([207,250,237,254]))return{ext:"macho",mime:"application/x-mach-binary"};if(this.check([79,84,84,79,0]))return{ext:"otf",mime:"font/otf"};if(this.checkString("#!AMR"))return{ext:"amr",mime:"audio/amr"};if(this.checkString("{\\rtf"))return{ext:"rtf",mime:"application/rtf"};if(this.check([70,76,86,1]))return{ext:"flv",mime:"video/x-flv"};if(this.checkString("IMPM"))return{ext:"it",mime:"audio/x-it"};if(this.checkString("-lh0-",{offset:2})||this.checkString("-lh1-",{offset:2})||this.checkString("-lh2-",{offset:2})||this.checkString("-lh3-",{offset:2})||this.checkString("-lh4-",{offset:2})||this.checkString("-lh5-",{offset:2})||this.checkString("-lh6-",{offset:2})||this.checkString("-lh7-",{offset:2})||this.checkString("-lzs-",{offset:2})||this.checkString("-lz4-",{offset:2})||this.checkString("-lz5-",{offset:2})||this.checkString("-lhd-",{offset:2}))return{ext:"lzh",mime:"application/x-lzh-compressed"};if(this.check([0,0,1,186])){if(this.check([33],{offset:4,mask:[241]}))return{ext:"mpg",mime:"video/MP1S"};if(this.check([68],{offset:4,mask:[196]}))return{ext:"mpg",mime:"video/MP2P"}}if(this.checkString("ITSF"))return{ext:"chm",mime:"application/vnd.ms-htmlhelp"};if(this.check([202,254,186,190]))return{ext:"class",mime:"application/java-vm"};if(this.check([253,55,122,88,90,0]))return{ext:"xz",mime:"application/x-xz"};if(this.checkString("<?xml "))return{ext:"xml",mime:"application/xml"};if(this.check([55,122,188,175,39,28]))return{ext:"7z",mime:"application/x-7z-compressed"};if(this.check([82,97,114,33,26,7])&&(0===this.buffer[6]||1===this.buffer[6]))return{ext:"rar",mime:"application/x-rar-compressed"};if(this.checkString("solid "))return{ext:"stl",mime:"model/stl"};if(this.checkString("AC")){const T=new j(4,"latin1").get(this.buffer,2);if(T.match("^d*")&&T>=1e3&&T<=1050)return{ext:"dwg",mime:"image/vnd.dwg"}}if(this.checkString("070707"))return{ext:"cpio",mime:"application/x-cpio"};if(this.checkString("BLENDER"))return{ext:"blend",mime:"application/x-blender"};if(this.checkString("!<arch>"))return await e.ignore(8),"debian-binary"===await e.readToken(new j(13,"ascii"))?{ext:"deb",mime:"application/x-deb"}:{ext:"ar",mime:"application/x-unix-archive"};if(this.checkString("**ACE",{offset:7})&&(await e.peekBuffer(this.buffer,{length:14,mayBeLess:!0}),this.checkString("**",{offset:12})))return{ext:"ace",mime:"application/x-ace-compressed"};if(this.check([137,80,78,71,13,10,26,10])){async function y(){return{length:await e.readToken(x),type:await e.readToken(new j(4,"latin1"))}}await e.ignore(8);do{const v=await y();if(v.length<0)return;switch(v.type){case"IDAT":return{ext:"png",mime:"image/png"};case"acTL":return{ext:"apng",mime:"image/apng"};default:await e.ignore(v.length+4)}}while(e.position+8<e.fileInfo.size);return{ext:"png",mime:"image/png"}}if(this.check([65,82,82,79,87,49,0,0]))return{ext:"arrow",mime:"application/x-apache-arrow"};if(this.check([103,108,84,70,2,0,0,0]))return{ext:"glb",mime:"model/gltf-binary"};if(this.check([102,114,101,101],{offset:4})||this.check([109,100,97,116],{offset:4})||this.check([109,111,111,118],{offset:4})||this.check([119,105,100,101],{offset:4}))return{ext:"mov",mime:"video/quicktime"};if(this.check([73,73,82,79,8,0,0,0,24]))return{ext:"orf",mime:"image/x-olympus-orf"};if(this.checkString("gimp xcf "))return{ext:"xcf",mime:"image/x-xcf"};if(this.check([73,73,85,0,24,0,0,0,136,231,116,216]))return{ext:"rw2",mime:"image/x-panasonic-rw2"};if(this.check([48,38,178,117,142,102,207,17,166,217])){async function S(){const t=new Uint8Array(16);return await e.readBuffer(t),{id:t,size:Number(await e.readToken(z))}}for(await e.ignore(30);e.position+24<e.fileInfo.size;){const I=await S();let C=I.size-24;if(ce(I.id,[145,7,220,183,183,169,207,17,142,230,0,192,12,32,83,101])){const A=new Uint8Array(16);if(C-=await e.readBuffer(A),ce(A,[64,158,105,248,77,91,207,17,168,253,0,128,95,92,68,43]))return{ext:"asf",mime:"audio/x-ms-asf"};if(ce(A,[192,239,25,188,77,91,207,17,168,253,0,128,95,92,68,43]))return{ext:"asf",mime:"video/x-ms-asf"};break}await e.ignore(C)}return{ext:"asf",mime:"application/vnd.ms-asf"}}if(this.check([171,75,84,88,32,49,49,187,13,10,26,10]))return{ext:"ktx",mime:"image/ktx"};if((this.check([126,16,4])||this.check([126,24,4]))&&this.check([48,77,73,69],{offset:4}))return{ext:"mie",mime:"application/x-mie"};if(this.check([39,10,0,0,0,0,0,0,0,0,0,0],{offset:2}))return{ext:"shp",mime:"application/x-esri-shape"};if(this.check([255,79,255,81]))return{ext:"j2c",mime:"image/j2c"};if(this.check([0,0,0,12,106,80,32,32,13,10,135,10]))switch(await e.ignore(20),await e.readToken(new j(4,"ascii"))){case"jp2 ":return{ext:"jp2",mime:"image/jp2"};case"jpx ":return{ext:"jpx",mime:"image/jpx"};case"jpm ":return{ext:"jpm",mime:"image/jpm"};case"mjp2":return{ext:"mj2",mime:"image/mj2"};default:return}if(this.check([255,10])||this.check([0,0,0,12,74,88,76,32,13,10,135,10]))return{ext:"jxl",mime:"image/jxl"};if(this.check([254,255]))return this.check([0,60,0,63,0,120,0,109,0,108],{offset:2})?{ext:"xml",mime:"application/xml"}:void 0;if(this.check([0,0,1,186])||this.check([0,0,1,179]))return{ext:"mpg",mime:"video/mpeg"};if(this.check([0,1,0,0,0]))return{ext:"ttf",mime:"font/ttf"};if(this.check([0,0,1,0]))return{ext:"ico",mime:"image/x-icon"};if(this.check([0,0,2,0]))return{ext:"cur",mime:"image/x-icon"};if(this.check([208,207,17,224,161,177,26,225]))return{ext:"cfb",mime:"application/x-cfb"};if(await e.peekBuffer(this.buffer,{length:Math.min(256,e.fileInfo.size),mayBeLess:!0}),this.check([97,99,115,112],{offset:36}))return{ext:"icc",mime:"application/vnd.iccprofile"};if(this.checkString("BEGIN:")){if(this.checkString("VCARD",{offset:6}))return{ext:"vcf",mime:"text/vcard"};if(this.checkString("VCALENDAR",{offset:6}))return{ext:"ics",mime:"text/calendar"}}if(this.checkString("FUJIFILMCCD-RAW"))return{ext:"raf",mime:"image/x-fujifilm-raf"};if(this.checkString("Extended Module:"))return{ext:"xm",mime:"audio/x-xm"};if(this.checkString("Creative Voice File"))return{ext:"voc",mime:"audio/x-voc"};if(this.check([4,0,0,0])&&this.buffer.length>=16){const E=new DataView(this.buffer.buffer).getUint32(12,!0);if(E>12&&this.buffer.length>=E+16)try{const F=(new TextDecoder).decode(this.buffer.slice(16,E+16));if(JSON.parse(F).files)return{ext:"asar",mime:"application/x-asar"}}catch{}}if(this.check([6,14,43,52,2,5,1,1,13,1,2,1,1,2]))return{ext:"mxf",mime:"application/mxf"};if(this.checkString("SCRM",{offset:44}))return{ext:"s3m",mime:"audio/x-s3m"};if(this.check([71])&&this.check([71],{offset:188}))return{ext:"mts",mime:"video/mp2t"};if(this.check([71],{offset:4})&&this.check([71],{offset:196}))return{ext:"mts",mime:"video/mp2t"};if(this.check([66,79,79,75,77,79,66,73],{offset:60}))return{ext:"mobi",mime:"application/x-mobipocket-ebook"};if(this.check([68,73,67,77],{offset:128}))return{ext:"dcm",mime:"application/dicom"};if(this.check([76,0,0,0,1,20,2,0,0,0,0,0,192,0,0,0,0,0,0,70]))return{ext:"lnk",mime:"application/x.ms.shortcut"};if(this.check([98,111,111,107,0,0,0,0,109,97,114,107,0,0,0,0]))return{ext:"alias",mime:"application/x.apple.alias"};if(this.checkString("Kaydara FBX Binary  \0"))return{ext:"fbx",mime:"application/x.autodesk.fbx"};if(this.check([76,80],{offset:34})&&(this.check([0,0,1],{offset:8})||this.check([1,0,2],{offset:8})||this.check([2,0,2],{offset:8})))return{ext:"eot",mime:"application/vnd.ms-fontobject"};if(this.check([6,6,237,245,216,29,70,229,189,49,239,231,254,116,183,29]))return{ext:"indd",mime:"application/x-indesign"};if(await e.peekBuffer(this.buffer,{length:Math.min(512,e.fileInfo.size),mayBeLess:!0}),function(e,t=0){const a=Number.parseInt(new j(6).get(e,148).replace(/\0.*$/,"").trim(),8);if(Number.isNaN(a))return!1;let i=256;for(let a=t;a<t+148;a++)i+=e[a];for(let a=t+156;a<t+512;a++)i+=e[a];return a===i}(this.buffer))return{ext:"tar",mime:"application/x-tar"};if(this.check([255,254]))return this.check([60,0,63,0,120,0,109,0,108,0],{offset:2})?{ext:"xml",mime:"application/xml"}:this.check([255,14,83,0,107,0,101,0,116,0,99,0,104,0,85,0,112,0,32,0,77,0,111,0,100,0,101,0,108,0],{offset:2})?{ext:"skp",mime:"application/vnd.sketchup.skp"}:void 0;if(this.checkString("-----BEGIN PGP MESSAGE-----"))return{ext:"pgp",mime:"application/pgp-encrypted"};if(this.buffer.length>=2&&this.check([255,224],{offset:0,mask:[255,224]})){if(this.check([16],{offset:1,mask:[22]}))return this.check([8],{offset:1,mask:[8]}),{ext:"aac",mime:"audio/aac"};if(this.check([2],{offset:1,mask:[6]}))return{ext:"mp3",mime:"audio/mpeg"};if(this.check([4],{offset:1,mask:[6]}))return{ext:"mp2",mime:"audio/mpeg"};if(this.check([6],{offset:1,mask:[6]}))return{ext:"mp1",mime:"audio/mpeg"}}}async readTiffTag(e){const t=await this.tokenizer.readToken(e?g:f);switch(this.tokenizer.ignore(10),t){case 50341:return{ext:"arw",mime:"image/x-sony-arw"};case 50706:return{ext:"dng",mime:"image/x-adobe-dng"}}}async readTiffIFD(e){const t=await this.tokenizer.readToken(e?g:f);for(let a=0;a<t;++a){const t=await this.readTiffTag(e);if(t)return t}}async readTiffHeader(e){const t=(e?g:f).get(this.buffer,2),a=(e?T:w).get(this.buffer,4);if(42===t){if(a>=6){if(this.checkString("CR",{offset:8}))return{ext:"cr2",mime:"image/x-canon-cr2"};if(a>=8&&(this.check([28,0,254,0],{offset:8})||this.check([31,0,11,0],{offset:8})))return{ext:"nef",mime:"image/x-nikon-nef"}}return await this.tokenizer.ignore(a),await this.readTiffIFD(e)??{ext:"tif",mime:"image/tiff"}}if(43===t)return{ext:"tif",mime:"image/tiff"}}}new Set(["jpg","png","apng","gif","webp","flif","xcf","cr2","cr3","orf","arw","dng","nef","rw2","raf","tif","bmp","icns","jxr","psd","indd","zip","tar","rar","gz","bz2","7z","dmg","mp4","mid","mkv","webm","mov","avi","mpg","mp2","mp3","m4a","oga","ogg","ogv","opus","flac","wav","spx","amr","pdf","epub","elf","macho","exe","swf","rtf","wasm","woff","woff2","eot","ttf","otf","ico","flv","ps","xz","sqlite","nes","crx","xpi","cab","deb","ar","rpm","Z","lz","cfb","mxf","mts","blend","bpg","docx","pptx","xlsx","3gp","3g2","j2c","jp2","jpm","jpx","mj2","aif","qcp","odt","ods","odp","xml","mobi","heic","cur","ktx","ape","wv","dcm","ics","glb","pcap","dsf","lnk","alias","voc","ac3","m4v","m4p","m4b","f4v","f4p","f4b","f4a","mie","asf","ogm","ogx","mpc","arrow","shp","aac","mp1","it","s3m","xm","ai","skp","avif","eps","lzh","pgp","asar","stl","chm","3mf","zst","jxl","vcf","jls","pst","dwg","parquet","class","arj","cpio","ace","avro","icc","fbx","vsdx"]),new Set(["image/jpeg","image/png","image/gif","image/webp","image/flif","image/x-xcf","image/x-canon-cr2","image/x-canon-cr3","image/tiff","image/bmp","image/vnd.ms-photo","image/vnd.adobe.photoshop","application/x-indesign","application/epub+zip","application/x-xpinstall","application/vnd.oasis.opendocument.text","application/vnd.oasis.opendocument.spreadsheet","application/vnd.oasis.opendocument.presentation","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.openxmlformats-officedocument.presentationml.presentation","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","application/zip","application/x-tar","application/x-rar-compressed","application/gzip","application/x-bzip2","application/x-7z-compressed","application/x-apple-diskimage","application/x-apache-arrow","video/mp4","audio/midi","video/x-matroska","video/webm","video/quicktime","video/vnd.avi","audio/wav","audio/qcelp","audio/x-ms-asf","video/x-ms-asf","application/vnd.ms-asf","video/mpeg","video/3gpp","audio/mpeg","audio/mp4","audio/opus","video/ogg","audio/ogg","application/ogg","audio/x-flac","audio/ape","audio/wavpack","audio/amr","application/pdf","application/x-elf","application/x-mach-binary","application/x-msdownload","application/x-shockwave-flash","application/rtf","application/wasm","font/woff","font/woff2","application/vnd.ms-fontobject","font/ttf","font/otf","image/x-icon","video/x-flv","application/postscript","application/eps","application/x-xz","application/x-sqlite3","application/x-nintendo-nes-rom","application/x-google-chrome-extension","application/vnd.ms-cab-compressed","application/x-deb","application/x-unix-archive","application/x-rpm","application/x-compress","application/x-lzip","application/x-cfb","application/x-mie","application/mxf","video/mp2t","application/x-blender","image/bpg","image/j2c","image/jp2","image/jpx","image/jpm","image/mj2","audio/aiff","application/xml","application/x-mobipocket-ebook","image/heif","image/heif-sequence","image/heic","image/heic-sequence","image/icns","image/ktx","application/dicom","audio/x-musepack","text/calendar","text/vcard","model/gltf-binary","application/vnd.tcpdump.pcap","audio/x-dsf","application/x.ms.shortcut","application/x.apple.alias","audio/x-voc","audio/vnd.dolby.dd-raw","audio/x-m4a","image/apng","image/x-olympus-orf","image/x-sony-arw","image/x-adobe-dng","image/x-nikon-nef","image/x-panasonic-rw2","image/x-fujifilm-raf","video/x-m4v","video/3gpp2","application/x-esri-shape","audio/aac","audio/x-it","audio/x-s3m","audio/x-xm","video/MP1S","video/MP2P","application/vnd.sketchup.skp","image/avif","application/x-lzh-compressed","application/pgp-encrypted","application/x-asar","model/stl","application/vnd.ms-htmlhelp","model/3mf","image/jxl","application/zstd","image/jls","application/vnd.ms-outlook","image/vnd.dwg","application/x-parquet","application/java-vm","application/x-arj","application/x-cpio","application/x-ace-compressed","application/avro","application/vnd.iccprofile","application/x.autodesk.fbx","application/vnd.visio"]);var me,ue,de,he,pe,fe=a(597),ge=a(864),ke=a(833);function be(e,t,a){return!!(e[t]&1<<a)}function we(e,t,a,i){let n=t;if("utf-16le"===i){for(;0!==e[n]||0!==e[n+1];){if(n>=a)return a;n+=2}return n}for(;0!==e[n];){if(n>=a)return a;n++}return n}function Te(e){const t=e.indexOf("\0");return-1===t?e:e.substr(0,t)}function ye(e,t){if(255===e[0]&&254===e[1])return ye(e.subarray(2),t);if("utf-16le"===t&&254===e[0]&&255===e[1]){if(1&e.length)throw new Error("Expected even number of octets for 16-bit unicode string");return ye(function(e){const t=e.length;if(1&t)throw new Error("Buffer length must be even");for(let a=0;a<t;a+=2){const t=e[a];e[a]=e[a+1],e[a+1]=t}return e}(e),t)}return new j(e.length,t).get(e,0)}function ve(e){return(e=e.replace(/^\x00+/g,"")).replace(/\x00+$/g,"")}function Se(e,t,a,i){const n=a%8;let r=e[t+~~(a/8)];r&=255>>n;const s=8-n,o=i-s;return o<0?r>>=8-n-i:o>0&&(r<<=o,r|=Se(e,t,a+s,o)),r}function Ie(e,t,a){return 1===Se(e,t,a,1)}!function(e){e[e.shot=10]="shot",e[e.scene=20]="scene",e[e.track=30]="track",e[e.part=40]="part",e[e.album=50]="album",e[e.edition=60]="edition",e[e.collection=70]="collection"}(me||(me={})),function(e){e[e.video=1]="video",e[e.audio=2]="audio",e[e.complex=3]="complex",e[e.logo=4]="logo",e[e.subtitle=17]="subtitle",e[e.button=18]="button",e[e.control=32]="control"}(ue||(ue={})),function(e){e[e.Other=0]="Other",e[e["32x32 pixels 'file icon' (PNG only)"]=1]="32x32 pixels 'file icon' (PNG only)",e[e["Other file icon"]=2]="Other file icon",e[e["Cover (front)"]=3]="Cover (front)",e[e["Cover (back)"]=4]="Cover (back)",e[e["Leaflet page"]=5]="Leaflet page",e[e["Media (e.g. label side of CD)"]=6]="Media (e.g. label side of CD)",e[e["Lead artist/lead performer/soloist"]=7]="Lead artist/lead performer/soloist",e[e["Artist/performer"]=8]="Artist/performer",e[e.Conductor=9]="Conductor",e[e["Band/Orchestra"]=10]="Band/Orchestra",e[e.Composer=11]="Composer",e[e["Lyricist/text writer"]=12]="Lyricist/text writer",e[e["Recording Location"]=13]="Recording Location",e[e["During recording"]=14]="During recording",e[e["During performance"]=15]="During performance",e[e["Movie/video screen capture"]=16]="Movie/video screen capture",e[e["A bright coloured fish"]=17]="A bright coloured fish",e[e.Illustration=18]="Illustration",e[e["Band/artist logotype"]=19]="Band/artist logotype",e[e["Publisher/Studio logotype"]=20]="Publisher/Studio logotype"}(de||(de={})),function(e){e[e.other=0]="other",e[e.lyrics=1]="lyrics",e[e.text=2]="text",e[e.movement_part=3]="movement_part",e[e.events=4]="events",e[e.chord=5]="chord",e[e.trivia_pop=6]="trivia_pop"}(he||(he={})),function(e){e[e.notSynchronized0=0]="notSynchronized0",e[e.mpegFrameNumber=1]="mpegFrameNumber",e[e.milliseconds=2]="milliseconds"}(pe||(pe={}));const Ce={get:(e,t)=>127&e[t+3]|e[t+2]<<7|e[t+1]<<14|e[t]<<21,len:4},xe={len:10,get:(e,t)=>({fileIdentifier:new j(3,"ascii").get(e,t),version:{major:y.get(e,t+3),revision:y.get(e,t+4)},flags:{unsynchronisation:be(e,t+5,7),isExtendedHeader:be(e,t+5,6),expIndicator:be(e,t+5,5),footer:be(e,t+5,4)},size:Ce.get(e,t+6)})},Ae={len:10,get:(e,t)=>({size:T.get(e,t),extendedFlags:g.get(e,t+4),sizeOfPadding:T.get(e,t+6),crcDataPresent:be(e,t+4,31)})},ze=(e,t)=>{switch(e[t]){case 0:return{encoding:"latin1"};case 1:return{encoding:"utf-16le",bom:!0};case 2:return{encoding:"utf-16le",bom:!1};default:return{encoding:"utf8",bom:!1}}},Ee=(e,t)=>({encoding:ze(e,t),language:new j(3,"latin1").get(e,t+1)}),Fe={year:{multiple:!1},track:{multiple:!1},disk:{multiple:!1},title:{multiple:!1},artist:{multiple:!1},artists:{multiple:!0,unique:!0},albumartist:{multiple:!1},album:{multiple:!1},date:{multiple:!1},originaldate:{multiple:!1},originalyear:{multiple:!1},releasedate:{multiple:!1},comment:{multiple:!0,unique:!1},genre:{multiple:!0,unique:!0},picture:{multiple:!0,unique:!0},composer:{multiple:!0,unique:!0},lyrics:{multiple:!0,unique:!1},albumsort:{multiple:!1,unique:!0},titlesort:{multiple:!1,unique:!0},work:{multiple:!1,unique:!0},artistsort:{multiple:!1,unique:!0},albumartistsort:{multiple:!1,unique:!0},composersort:{multiple:!1,unique:!0},lyricist:{multiple:!0,unique:!0},writer:{multiple:!0,unique:!0},conductor:{multiple:!0,unique:!0},remixer:{multiple:!0,unique:!0},arranger:{multiple:!0,unique:!0},engineer:{multiple:!0,unique:!0},producer:{multiple:!0,unique:!0},technician:{multiple:!0,unique:!0},djmixer:{multiple:!0,unique:!0},mixer:{multiple:!0,unique:!0},label:{multiple:!0,unique:!0},grouping:{multiple:!1},subtitle:{multiple:!0},discsubtitle:{multiple:!1},totaltracks:{multiple:!1},totaldiscs:{multiple:!1},compilation:{multiple:!1},rating:{multiple:!0},bpm:{multiple:!1},mood:{multiple:!1},media:{multiple:!1},catalognumber:{multiple:!0,unique:!0},tvShow:{multiple:!1},tvShowSort:{multiple:!1},tvSeason:{multiple:!1},tvEpisode:{multiple:!1},tvEpisodeId:{multiple:!1},tvNetwork:{multiple:!1},podcast:{multiple:!1},podcasturl:{multiple:!1},releasestatus:{multiple:!1},releasetype:{multiple:!0},releasecountry:{multiple:!1},script:{multiple:!1},language:{multiple:!1},copyright:{multiple:!1},license:{multiple:!1},encodedby:{multiple:!1},encodersettings:{multiple:!1},gapless:{multiple:!1},barcode:{multiple:!1},isrc:{multiple:!0},asin:{multiple:!1},musicbrainz_recordingid:{multiple:!1},musicbrainz_trackid:{multiple:!1},musicbrainz_albumid:{multiple:!1},musicbrainz_artistid:{multiple:!0},musicbrainz_albumartistid:{multiple:!0},musicbrainz_releasegroupid:{multiple:!1},musicbrainz_workid:{multiple:!1},musicbrainz_trmid:{multiple:!1},musicbrainz_discid:{multiple:!1},acoustid_id:{multiple:!1},acoustid_fingerprint:{multiple:!1},musicip_puid:{multiple:!1},musicip_fingerprint:{multiple:!1},website:{multiple:!1},"performer:instrument":{multiple:!0,unique:!0},averageLevel:{multiple:!1},peakLevel:{multiple:!1},notes:{multiple:!0,unique:!1},key:{multiple:!1},originalalbum:{multiple:!1},originalartist:{multiple:!1},discogs_artist_id:{multiple:!0,unique:!0},discogs_release_id:{multiple:!1},discogs_label_id:{multiple:!1},discogs_master_release_id:{multiple:!1},discogs_votes:{multiple:!1},discogs_rating:{multiple:!1},replaygain_track_peak:{multiple:!1},replaygain_track_gain:{multiple:!1},replaygain_album_peak:{multiple:!1},replaygain_album_gain:{multiple:!1},replaygain_track_minmax:{multiple:!1},replaygain_album_minmax:{multiple:!1},replaygain_undo:{multiple:!1},description:{multiple:!0},longDescription:{multiple:!1},category:{multiple:!0},hdVideo:{multiple:!1},keywords:{multiple:!0},movement:{multiple:!1},movementIndex:{multiple:!1},movementTotal:{multiple:!1},podcastId:{multiple:!1},showMovement:{multiple:!1},stik:{multiple:!1}};class De{static toIntOrNull(e){const t=Number.parseInt(e,10);return Number.isNaN(t)?null:t}static normalizeTrack(e){const t=e.toString().split("/");return{no:Number.parseInt(t[0],10)||null,of:Number.parseInt(t[1],10)||null}}constructor(e,t){this.tagTypes=e,this.tagMap=t}mapGenericTag(e,t){e={id:e.id,value:e.value},this.postMap(e,t);const a=this.getCommonName(e.id);return a?{id:a,value:e.value}:null}getCommonName(e){return this.tagMap[e]}postMap(e,t){}}De.maxRatingScore=1;const Me={title:"title",artist:"artist",album:"album",year:"year",comment:"comment",track:"track",genre:"genre"};class Pe extends De{constructor(){super(["ID3v1"],Me)}}class _e extends De{constructor(e,t){const a={};for(const e of Object.keys(t))a[e.toUpperCase()]=t[e];super(e,a)}getCommonName(e){return this.tagMap[e.toUpperCase()]}}const Re={TIT2:"title",TPE1:"artist","TXXX:Artists":"artists",TPE2:"albumartist",TALB:"album",TDRV:"date",TORY:"originalyear",TPOS:"disk",TCON:"genre",APIC:"picture",TCOM:"composer",USLT:"lyrics",TSOA:"albumsort",TSOT:"titlesort",TOAL:"originalalbum",TSOP:"artistsort",TSO2:"albumartistsort",TSOC:"composersort",TEXT:"lyricist","TXXX:Writer":"writer",TPE3:"conductor",TPE4:"remixer","IPLS:arranger":"arranger","IPLS:engineer":"engineer","IPLS:producer":"producer","IPLS:DJ-mix":"djmixer","IPLS:mix":"mixer",TPUB:"label",TIT1:"grouping",TIT3:"subtitle",TRCK:"track",TCMP:"compilation",POPM:"rating",TBPM:"bpm",TMED:"media","TXXX:CATALOGNUMBER":"catalognumber","TXXX:MusicBrainz Album Status":"releasestatus","TXXX:MusicBrainz Album Type":"releasetype","TXXX:MusicBrainz Album Release Country":"releasecountry","TXXX:RELEASECOUNTRY":"releasecountry","TXXX:SCRIPT":"script",TLAN:"language",TCOP:"copyright",WCOP:"license",TENC:"encodedby",TSSE:"encodersettings","TXXX:BARCODE":"barcode","TXXX:ISRC":"isrc",TSRC:"isrc","TXXX:ASIN":"asin","TXXX:originalyear":"originalyear","UFID:http://musicbrainz.org":"musicbrainz_recordingid","TXXX:MusicBrainz Release Track Id":"musicbrainz_trackid","TXXX:MusicBrainz Album Id":"musicbrainz_albumid","TXXX:MusicBrainz Artist Id":"musicbrainz_artistid","TXXX:MusicBrainz Album Artist Id":"musicbrainz_albumartistid","TXXX:MusicBrainz Release Group Id":"musicbrainz_releasegroupid","TXXX:MusicBrainz Work Id":"musicbrainz_workid","TXXX:MusicBrainz TRM Id":"musicbrainz_trmid","TXXX:MusicBrainz Disc Id":"musicbrainz_discid","TXXX:ACOUSTID_ID":"acoustid_id","TXXX:Acoustid Id":"acoustid_id","TXXX:Acoustid Fingerprint":"acoustid_fingerprint","TXXX:MusicIP PUID":"musicip_puid","TXXX:MusicMagic Fingerprint":"musicip_fingerprint",WOAR:"website",TDRC:"date",TYER:"year",TDOR:"originaldate","TIPL:arranger":"arranger","TIPL:engineer":"engineer","TIPL:producer":"producer","TIPL:DJ-mix":"djmixer","TIPL:mix":"mixer",TMOO:"mood",SYLT:"lyrics",TSST:"discsubtitle",TKEY:"key",COMM:"comment",TOPE:"originalartist","PRIV:AverageLevel":"averageLevel","PRIV:PeakLevel":"peakLevel","TXXX:DISCOGS_ARTIST_ID":"discogs_artist_id","TXXX:DISCOGS_ARTISTS":"artists","TXXX:DISCOGS_ARTIST_NAME":"artists","TXXX:DISCOGS_ALBUM_ARTISTS":"albumartist","TXXX:DISCOGS_CATALOG":"catalognumber","TXXX:DISCOGS_COUNTRY":"releasecountry","TXXX:DISCOGS_DATE":"originaldate","TXXX:DISCOGS_LABEL":"label","TXXX:DISCOGS_LABEL_ID":"discogs_label_id","TXXX:DISCOGS_MASTER_RELEASE_ID":"discogs_master_release_id","TXXX:DISCOGS_RATING":"discogs_rating","TXXX:DISCOGS_RELEASED":"date","TXXX:DISCOGS_RELEASE_ID":"discogs_release_id","TXXX:DISCOGS_VOTES":"discogs_votes","TXXX:CATALOGID":"catalognumber","TXXX:STYLE":"genre","TXXX:REPLAYGAIN_TRACK_PEAK":"replaygain_track_peak","TXXX:REPLAYGAIN_TRACK_GAIN":"replaygain_track_gain","TXXX:REPLAYGAIN_ALBUM_PEAK":"replaygain_album_peak","TXXX:REPLAYGAIN_ALBUM_GAIN":"replaygain_album_gain","TXXX:MP3GAIN_MINMAX":"replaygain_track_minmax","TXXX:MP3GAIN_ALBUM_MINMAX":"replaygain_album_minmax","TXXX:MP3GAIN_UNDO":"replaygain_undo",MVNM:"movement",MVIN:"movementIndex",PCST:"podcast",TCAT:"category",TDES:"description",TDRL:"releasedate",TGID:"podcastId",TKWD:"keywords",WFED:"podcasturl",GRP1:"grouping"};class Be extends _e{static toRating(e){return{source:e.email,rating:e.rating>0?(e.rating-1)/254*De.maxRatingScore:void 0}}constructor(){super(["ID3v2.3","ID3v2.4"],Re)}postMap(e,t){switch(e.id){case"UFID":{const t=e.value;"http://musicbrainz.org"===t.owner_identifier&&(e.id+=`:${t.owner_identifier}`,e.value=ye(t.identifier,"latin1"))}break;case"PRIV":{const a=e.value;switch(a.owner_identifier){case"AverageLevel":case"PeakValue":e.id+=`:${a.owner_identifier}`,e.value=4===a.data.length?w.get(a.data,0):null,null===e.value&&t.addWarning("Failed to parse PRIV:PeakValue");break;default:t.addWarning(`Unknown PRIV owner-identifier: ${a.data}`)}}break;case"POPM":e.value=Be.toRating(e.value)}}}const Oe={Title:"title",Author:"artist","WM/AlbumArtist":"albumartist","WM/AlbumTitle":"album","WM/Year":"date","WM/OriginalReleaseTime":"originaldate","WM/OriginalReleaseYear":"originalyear",Description:"comment","WM/TrackNumber":"track","WM/PartOfSet":"disk","WM/Genre":"genre","WM/Composer":"composer","WM/Lyrics":"lyrics","WM/AlbumSortOrder":"albumsort","WM/TitleSortOrder":"titlesort","WM/ArtistSortOrder":"artistsort","WM/AlbumArtistSortOrder":"albumartistsort","WM/ComposerSortOrder":"composersort","WM/Writer":"lyricist","WM/Conductor":"conductor","WM/ModifiedBy":"remixer","WM/Engineer":"engineer","WM/Producer":"producer","WM/DJMixer":"djmixer","WM/Mixer":"mixer","WM/Publisher":"label","WM/ContentGroupDescription":"grouping","WM/SubTitle":"subtitle","WM/SetSubTitle":"discsubtitle","WM/IsCompilation":"compilation","WM/SharedUserRating":"rating","WM/BeatsPerMinute":"bpm","WM/Mood":"mood","WM/Media":"media","WM/CatalogNo":"catalognumber","MusicBrainz/Album Status":"releasestatus","MusicBrainz/Album Type":"releasetype","MusicBrainz/Album Release Country":"releasecountry","WM/Script":"script","WM/Language":"language",Copyright:"copyright",LICENSE:"license","WM/EncodedBy":"encodedby","WM/EncodingSettings":"encodersettings","WM/Barcode":"barcode","WM/ISRC":"isrc","MusicBrainz/Track Id":"musicbrainz_recordingid","MusicBrainz/Release Track Id":"musicbrainz_trackid","MusicBrainz/Album Id":"musicbrainz_albumid","MusicBrainz/Artist Id":"musicbrainz_artistid","MusicBrainz/Album Artist Id":"musicbrainz_albumartistid","MusicBrainz/Release Group Id":"musicbrainz_releasegroupid","MusicBrainz/Work Id":"musicbrainz_workid","MusicBrainz/TRM Id":"musicbrainz_trmid","MusicBrainz/Disc Id":"musicbrainz_discid","Acoustid/Id":"acoustid_id","Acoustid/Fingerprint":"acoustid_fingerprint","MusicIP/PUID":"musicip_puid","WM/ARTISTS":"artists","WM/InitialKey":"key",ASIN:"asin","WM/Work":"work","WM/AuthorURL":"website","WM/Picture":"picture"};class Le extends De{static toRating(e){return{rating:Number.parseFloat(e+1)/5}}constructor(){super(["asf"],Oe)}postMap(e){switch(e.id){case"WM/SharedUserRating":{const t=e.id.split(":");e.value=Le.toRating(e.value),e.id=t[0];break}}}}const Ne={TT2:"title",TP1:"artist",TP2:"albumartist",TAL:"album",TYE:"year",COM:"comment",TRK:"track",TPA:"disk",TCO:"genre",PIC:"picture",TCM:"composer",TOR:"originaldate",TOT:"originalalbum",TXT:"lyricist",TP3:"conductor",TPB:"label",TT1:"grouping",TT3:"subtitle",TLA:"language",TCR:"copyright",WCP:"license",TEN:"encodedby",TSS:"encodersettings",WAR:"website",PCS:"podcast",TCP:"compilation",TDR:"date",TS2:"albumartistsort",TSA:"albumsort",TSC:"composersort",TSP:"artistsort",TST:"titlesort",WFD:"podcasturl",TBP:"bpm"};class Ue extends _e{constructor(){super(["ID3v2.2"],Ne)}}const $e={Title:"title",Artist:"artist",Artists:"artists","Album Artist":"albumartist",Album:"album",Year:"date",Originalyear:"originalyear",Originaldate:"originaldate",Releasedate:"releasedate",Comment:"comment",Track:"track",Disc:"disk",DISCNUMBER:"disk",Genre:"genre","Cover Art (Front)":"picture","Cover Art (Back)":"picture",Composer:"composer",Lyrics:"lyrics",ALBUMSORT:"albumsort",TITLESORT:"titlesort",WORK:"work",ARTISTSORT:"artistsort",ALBUMARTISTSORT:"albumartistsort",COMPOSERSORT:"composersort",Lyricist:"lyricist",Writer:"writer",Conductor:"conductor",MixArtist:"remixer",Arranger:"arranger",Engineer:"engineer",Producer:"producer",DJMixer:"djmixer",Mixer:"mixer",Label:"label",Grouping:"grouping",Subtitle:"subtitle",DiscSubtitle:"discsubtitle",Compilation:"compilation",BPM:"bpm",Mood:"mood",Media:"media",CatalogNumber:"catalognumber",MUSICBRAINZ_ALBUMSTATUS:"releasestatus",MUSICBRAINZ_ALBUMTYPE:"releasetype",RELEASECOUNTRY:"releasecountry",Script:"script",Language:"language",Copyright:"copyright",LICENSE:"license",EncodedBy:"encodedby",EncoderSettings:"encodersettings",Barcode:"barcode",ISRC:"isrc",ASIN:"asin",musicbrainz_trackid:"musicbrainz_recordingid",musicbrainz_releasetrackid:"musicbrainz_trackid",MUSICBRAINZ_ALBUMID:"musicbrainz_albumid",MUSICBRAINZ_ARTISTID:"musicbrainz_artistid",MUSICBRAINZ_ALBUMARTISTID:"musicbrainz_albumartistid",MUSICBRAINZ_RELEASEGROUPID:"musicbrainz_releasegroupid",MUSICBRAINZ_WORKID:"musicbrainz_workid",MUSICBRAINZ_TRMID:"musicbrainz_trmid",MUSICBRAINZ_DISCID:"musicbrainz_discid",Acoustid_Id:"acoustid_id",ACOUSTID_FINGERPRINT:"acoustid_fingerprint",MUSICIP_PUID:"musicip_puid",Weblink:"website",REPLAYGAIN_TRACK_GAIN:"replaygain_track_gain",REPLAYGAIN_TRACK_PEAK:"replaygain_track_peak",MP3GAIN_MINMAX:"replaygain_track_minmax",MP3GAIN_UNDO:"replaygain_undo"};class je extends _e{constructor(){super(["APEv2"],$e)}}const Ge={"©nam":"title","©ART":"artist",aART:"albumartist","----:com.apple.iTunes:Band":"albumartist","©alb":"album","©day":"date","©cmt":"comment","©com":"comment",trkn:"track",disk:"disk","©gen":"genre",covr:"picture","©wrt":"composer","©lyr":"lyrics",soal:"albumsort",sonm:"titlesort",soar:"artistsort",soaa:"albumartistsort",soco:"composersort","----:com.apple.iTunes:LYRICIST":"lyricist","----:com.apple.iTunes:CONDUCTOR":"conductor","----:com.apple.iTunes:REMIXER":"remixer","----:com.apple.iTunes:ENGINEER":"engineer","----:com.apple.iTunes:PRODUCER":"producer","----:com.apple.iTunes:DJMIXER":"djmixer","----:com.apple.iTunes:MIXER":"mixer","----:com.apple.iTunes:LABEL":"label","©grp":"grouping","----:com.apple.iTunes:SUBTITLE":"subtitle","----:com.apple.iTunes:DISCSUBTITLE":"discsubtitle",cpil:"compilation",tmpo:"bpm","----:com.apple.iTunes:MOOD":"mood","----:com.apple.iTunes:MEDIA":"media","----:com.apple.iTunes:CATALOGNUMBER":"catalognumber",tvsh:"tvShow",tvsn:"tvSeason",tves:"tvEpisode",sosn:"tvShowSort",tven:"tvEpisodeId",tvnn:"tvNetwork",pcst:"podcast",purl:"podcasturl","----:com.apple.iTunes:MusicBrainz Album Status":"releasestatus","----:com.apple.iTunes:MusicBrainz Album Type":"releasetype","----:com.apple.iTunes:MusicBrainz Album Release Country":"releasecountry","----:com.apple.iTunes:SCRIPT":"script","----:com.apple.iTunes:LANGUAGE":"language",cprt:"copyright","©cpy":"copyright","----:com.apple.iTunes:LICENSE":"license","©too":"encodedby",pgap:"gapless","----:com.apple.iTunes:BARCODE":"barcode","----:com.apple.iTunes:ISRC":"isrc","----:com.apple.iTunes:ASIN":"asin","----:com.apple.iTunes:NOTES":"comment","----:com.apple.iTunes:MusicBrainz Track Id":"musicbrainz_recordingid","----:com.apple.iTunes:MusicBrainz Release Track Id":"musicbrainz_trackid","----:com.apple.iTunes:MusicBrainz Album Id":"musicbrainz_albumid","----:com.apple.iTunes:MusicBrainz Artist Id":"musicbrainz_artistid","----:com.apple.iTunes:MusicBrainz Album Artist Id":"musicbrainz_albumartistid","----:com.apple.iTunes:MusicBrainz Release Group Id":"musicbrainz_releasegroupid","----:com.apple.iTunes:MusicBrainz Work Id":"musicbrainz_workid","----:com.apple.iTunes:MusicBrainz TRM Id":"musicbrainz_trmid","----:com.apple.iTunes:MusicBrainz Disc Id":"musicbrainz_discid","----:com.apple.iTunes:Acoustid Id":"acoustid_id","----:com.apple.iTunes:Acoustid Fingerprint":"acoustid_fingerprint","----:com.apple.iTunes:MusicIP PUID":"musicip_puid","----:com.apple.iTunes:fingerprint":"musicip_fingerprint","----:com.apple.iTunes:replaygain_track_gain":"replaygain_track_gain","----:com.apple.iTunes:replaygain_track_peak":"replaygain_track_peak","----:com.apple.iTunes:replaygain_album_gain":"replaygain_album_gain","----:com.apple.iTunes:replaygain_album_peak":"replaygain_album_peak","----:com.apple.iTunes:replaygain_track_minmax":"replaygain_track_minmax","----:com.apple.iTunes:replaygain_album_minmax":"replaygain_album_minmax","----:com.apple.iTunes:replaygain_undo":"replaygain_undo",gnre:"genre","----:com.apple.iTunes:ALBUMARTISTSORT":"albumartistsort","----:com.apple.iTunes:ARTISTS":"artists","----:com.apple.iTunes:ORIGINALDATE":"originaldate","----:com.apple.iTunes:ORIGINALYEAR":"originalyear","----:com.apple.iTunes:RELEASEDATE":"releasedate",desc:"description",ldes:"longDescription","©mvn":"movement","©mvi":"movementIndex","©mvc":"movementTotal","©wrk":"work",catg:"category",egid:"podcastId",hdvd:"hdVideo",keyw:"keywords",shwm:"showMovement",stik:"stik",rate:"rating"};class Xe extends _e{constructor(){super(["iTunes"],Ge)}postMap(e,t){"rate"===e.id&&(e.value={source:void 0,rating:Number.parseFloat(e.value)/100})}}const We={TITLE:"title",ARTIST:"artist",ARTISTS:"artists",ALBUMARTIST:"albumartist","ALBUM ARTIST":"albumartist",ALBUM:"album",DATE:"date",ORIGINALDATE:"originaldate",ORIGINALYEAR:"originalyear",RELEASEDATE:"releasedate",COMMENT:"comment",TRACKNUMBER:"track",DISCNUMBER:"disk",GENRE:"genre",METADATA_BLOCK_PICTURE:"picture",COMPOSER:"composer",LYRICS:"lyrics",ALBUMSORT:"albumsort",TITLESORT:"titlesort",WORK:"work",ARTISTSORT:"artistsort",ALBUMARTISTSORT:"albumartistsort",COMPOSERSORT:"composersort",LYRICIST:"lyricist",WRITER:"writer",CONDUCTOR:"conductor",REMIXER:"remixer",ARRANGER:"arranger",ENGINEER:"engineer",PRODUCER:"producer",DJMIXER:"djmixer",MIXER:"mixer",LABEL:"label",GROUPING:"grouping",SUBTITLE:"subtitle",DISCSUBTITLE:"discsubtitle",TRACKTOTAL:"totaltracks",DISCTOTAL:"totaldiscs",COMPILATION:"compilation",RATING:"rating",BPM:"bpm",KEY:"key",MOOD:"mood",MEDIA:"media",CATALOGNUMBER:"catalognumber",RELEASESTATUS:"releasestatus",RELEASETYPE:"releasetype",RELEASECOUNTRY:"releasecountry",SCRIPT:"script",LANGUAGE:"language",COPYRIGHT:"copyright",LICENSE:"license",ENCODEDBY:"encodedby",ENCODERSETTINGS:"encodersettings",BARCODE:"barcode",ISRC:"isrc",ASIN:"asin",MUSICBRAINZ_TRACKID:"musicbrainz_recordingid",MUSICBRAINZ_RELEASETRACKID:"musicbrainz_trackid",MUSICBRAINZ_ALBUMID:"musicbrainz_albumid",MUSICBRAINZ_ARTISTID:"musicbrainz_artistid",MUSICBRAINZ_ALBUMARTISTID:"musicbrainz_albumartistid",MUSICBRAINZ_RELEASEGROUPID:"musicbrainz_releasegroupid",MUSICBRAINZ_WORKID:"musicbrainz_workid",MUSICBRAINZ_TRMID:"musicbrainz_trmid",MUSICBRAINZ_DISCID:"musicbrainz_discid",ACOUSTID_ID:"acoustid_id",ACOUSTID_ID_FINGERPRINT:"acoustid_fingerprint",MUSICIP_PUID:"musicip_puid",WEBSITE:"website",NOTES:"notes",TOTALTRACKS:"totaltracks",TOTALDISCS:"totaldiscs",DISCOGS_ARTIST_ID:"discogs_artist_id",DISCOGS_ARTISTS:"artists",DISCOGS_ARTIST_NAME:"artists",DISCOGS_ALBUM_ARTISTS:"albumartist",DISCOGS_CATALOG:"catalognumber",DISCOGS_COUNTRY:"releasecountry",DISCOGS_DATE:"originaldate",DISCOGS_LABEL:"label",DISCOGS_LABEL_ID:"discogs_label_id",DISCOGS_MASTER_RELEASE_ID:"discogs_master_release_id",DISCOGS_RATING:"discogs_rating",DISCOGS_RELEASED:"date",DISCOGS_RELEASE_ID:"discogs_release_id",DISCOGS_VOTES:"discogs_votes",CATALOGID:"catalognumber",STYLE:"genre",REPLAYGAIN_TRACK_GAIN:"replaygain_track_gain",REPLAYGAIN_TRACK_PEAK:"replaygain_track_peak",REPLAYGAIN_ALBUM_GAIN:"replaygain_album_gain",REPLAYGAIN_ALBUM_PEAK:"replaygain_album_peak",REPLAYGAIN_MINMAX:"replaygain_track_minmax",REPLAYGAIN_ALBUM_MINMAX:"replaygain_album_minmax",REPLAYGAIN_UNDO:"replaygain_undo"};class He extends De{static toRating(e,t,a){return{source:e?e.toLowerCase():void 0,rating:Number.parseFloat(t)/a*De.maxRatingScore}}constructor(){super(["vorbis"],We)}postMap(e){if("RATING"===e.id)e.value=He.toRating(void 0,e.value,100);else if(0===e.id.indexOf("RATING:")){const t=e.id.split(":");e.value=He.toRating(t[1],e.value,1),e.id=t[0]}}}const Ve={IART:"artist",ICRD:"date",INAM:"title",TITL:"title",IPRD:"album",ITRK:"track",IPRT:"track",COMM:"comment",ICMT:"comment",ICNT:"releasecountry",GNRE:"genre",IWRI:"writer",RATE:"rating",YEAR:"year",ISFT:"encodedby",CODE:"encodedby",TURL:"website",IGNR:"genre",IENG:"engineer",ITCH:"technician",IMED:"media",IRPD:"album"};class qe extends De{constructor(){super(["exif"],Ve)}}const Ke={"segment:title":"title","album:ARTIST":"albumartist","album:ARTISTSORT":"albumartistsort","album:TITLE":"album","album:DATE_RECORDED":"originaldate","album:DATE_RELEASED":"releasedate","album:PART_NUMBER":"disk","album:TOTAL_PARTS":"totaltracks","track:ARTIST":"artist","track:ARTISTSORT":"artistsort","track:TITLE":"title","track:PART_NUMBER":"track","track:MUSICBRAINZ_TRACKID":"musicbrainz_recordingid","track:MUSICBRAINZ_ALBUMID":"musicbrainz_albumid","track:MUSICBRAINZ_ARTISTID":"musicbrainz_artistid","track:PUBLISHER":"label","track:GENRE":"genre","track:ENCODER":"encodedby","track:ENCODER_OPTIONS":"encodersettings","edition:TOTAL_PARTS":"totaldiscs",picture:"picture"};class Ye extends _e{constructor(){super(["matroska"],Ke)}}const Ze={NAME:"title",AUTH:"artist","(c) ":"copyright",ANNO:"comment"};class Je extends De{constructor(){super(["AIFF"],Ze)}}class Qe{constructor(){this.tagMappers={},[new Pe,new Ue,new Be,new Xe,new Xe,new He,new je,new Le,new qe,new Ye,new Je].forEach((e=>{this.registerTagMapper(e)}))}mapTag(e,t,a){if(this.tagMappers[e])return this.tagMappers[e].mapGenericTag(t,a);throw new Error(`No generic tag mapper defined for tag-format: ${e}`)}registerTagMapper(e){for(const t of e.tagTypes)this.tagMappers[t]=e}}const et=ke("music-metadata:collector"),tt=["matroska","APEv2","vorbis","ID3v2.4","ID3v2.3","ID3v2.2","exif","asf","iTunes","AIFF","ID3v1"];class at{constructor(e){this.opts=e,this.format={tagTypes:[],trackInfo:[]},this.native={},this.common={track:{no:null,of:null},disk:{no:null,of:null},movementIndex:{no:null,of:null}},this.quality={warnings:[]},this.commonOrigin={},this.originPriority={},this.tagMapper=new Qe;let t=1;for(const e of tt)this.originPriority[e]=t++;this.originPriority.artificial=500,this.originPriority.id3v1=600}hasAny(){return Object.keys(this.native).length>0}addStreamInfo(e){et(`streamInfo: type=${e.type?ue[e.type]:"?"}, codec=${e.codecName}`),this.format.trackInfo.push(e)}setFormat(e,t){et(`format: ${e} = ${t}`),this.format[e]=t,this.opts?.observer&&this.opts.observer({metadata:this,tag:{type:"format",id:e,value:t}})}async addTag(e,t,a){et(`tag ${e}.${t} = ${a}`),this.native[e]||(this.format.tagTypes.push(e),this.native[e]=[]),this.native[e].push({id:t,value:a}),await this.toCommon(e,t,a)}addWarning(e){this.quality.warnings.push({message:e})}async postMap(e,t){switch(t.id){case"artist":if(this.commonOrigin.artist===this.originPriority[e])return this.postMap("artificial",{id:"artists",value:t.value});this.common.artists||this.setGenericTag("artificial",{id:"artists",value:t.value});break;case"artists":if(!(this.common.artist&&this.commonOrigin.artist!==this.originPriority.artificial||this.common.artists&&-1!==this.common.artists.indexOf(t.value))){const e={id:"artist",value:(a=(this.common.artists||[]).concat([t.value])).length>2?`${a.slice(0,a.length-1).join(", ")} & ${a[a.length-1]}`:a.join(" & ")};this.setGenericTag("artificial",e)}break;case"picture":return this.postFixPicture(t.value).then((a=>{null!==a&&(t.value=a,this.setGenericTag(e,t))}));case"totaltracks":return void(this.common.track.of=De.toIntOrNull(t.value));case"totaldiscs":return void(this.common.disk.of=De.toIntOrNull(t.value));case"movementTotal":return void(this.common.movementIndex.of=De.toIntOrNull(t.value));case"track":case"disk":case"movementIndex":{const e=this.common[t.id].of;return this.common[t.id]=De.normalizeTrack(t.value),void(this.common[t.id].of=null!=e?e:this.common[t.id].of)}case"bpm":case"year":case"originalyear":t.value=Number.parseInt(t.value,10);break;case"date":{const e=Number.parseInt(t.value.substr(0,4),10);Number.isNaN(e)||(this.common.year=e);break}case"discogs_label_id":case"discogs_release_id":case"discogs_master_release_id":case"discogs_artist_id":case"discogs_votes":t.value="string"==typeof t.value?Number.parseInt(t.value,10):t.value;break;case"replaygain_track_gain":case"replaygain_track_peak":case"replaygain_album_gain":case"replaygain_album_peak":t.value=function(e){const t=e.split(" ").map((e=>e.trim().toLowerCase()));if(t.length>=1){const e=Number.parseFloat(t[0]);return 2===t.length&&"db"===t[1]?{dB:e,ratio:(i=e,10**(i/10))}:{dB:(a=e,10*Math.log10(a)),ratio:e}}var a,i}(t.value);break;case"replaygain_track_minmax":t.value=t.value.split(",").map((e=>Number.parseInt(e,10)));break;case"replaygain_undo":{const e=t.value.split(",").map((e=>Number.parseInt(e,10)));t.value={leftChannel:e[0],rightChannel:e[1]};break}case"gapless":case"compilation":case"podcast":case"showMovement":t.value="1"===t.value||1===t.value;break;case"isrc":{const e=this.common[t.id];if(e&&-1!==e.indexOf(t.value))return;break}case"comment":"string"==typeof t.value&&(t.value={text:t.value}),"iTunPGAP"===t.value.descriptor&&this.setGenericTag(e,{id:"gapless",value:"1"===t.value.text})}var a;null!==t.value&&this.setGenericTag(e,t)}toCommonMetadata(){return{format:this.format,native:this.native,quality:this.quality,common:this.common}}async postFixPicture(e){if(e.data&&e.data.length>0){if(!e.format){const t=await oe(Uint8Array.from(e.data));if(!t)return null;e.format=t.mime}return e.format=e.format.toLocaleLowerCase(),"image/jpg"===e.format&&(e.format="image/jpeg"),e}return this.addWarning("Empty picture tag found"),null}async toCommon(e,t,a){const i={id:t,value:a},n=this.tagMapper.mapTag(e,i,this);n&&await this.postMap(e,n)}setGenericTag(e,t){et(`common.${t.id} = ${t.value}`);const a=this.commonOrigin[t.id]||1e3,i=this.originPriority[e];if(n=t.id,Fe[n]&&!Fe[n].multiple){if(!(i<=a))return et(`Ignore native tag (singleton): ${e}.${t.id} = ${t.value}`);this.common[t.id]=t.value,this.commonOrigin[t.id]=i}else if(i===a)!function(e){return!Fe[e].multiple||Fe[e].unique||!1}(t.id)||-1===this.common[t.id].indexOf(t.value)?this.common[t.id].push(t.value):et(`Ignore duplicate value: ${e}.${t.id} = ${t.value}`);else{if(!(i<a))return et(`Ignore native tag (list): ${e}.${t.id} = ${t.value}`);this.common[t.id]=[t.value],this.commonOrigin[t.id]=i}var n;this.opts?.observer&&this.opts.observer({metadata:this,tag:{type:"common",id:t.id,value:t.value}})}}class it{constructor(){this.metadata=void 0,this.tokenizer=void 0,this.options=void 0}init(e,t,a){return this.metadata=e,this.tokenizer=t,this.options=a,this}}const nt=/^[\x21-\x7e©][\x20-\x7e\x00()]{3}/,rt={len:4,get:(e,t)=>{const a=Y(e.slice(t,t+rt.len),"latin1");if(!a.match(nt))throw new Error(`FourCC contains invalid characters: ${function(e){const t=[];for(let a=0,i=e.length;a<i;a++){const i=Number(e.charCodeAt(a)).toString(16);t.push(1===i.length?`0${i}`:i)}return t.join(" ")}(a)} "${a}"`);return a},put:(e,t,a)=>{const i=(Z(n=a),J.encode(n));var n;if(4!==i.length)throw new Error("Invalid length");return e.set(i,t),t+4}};var st;!function(e){e[e.text_utf8=0]="text_utf8",e[e.binary=1]="binary",e[e.external_info=2]="external_info",e[e.reserved=3]="reserved"}(st||(st={}));const ot={len:52,get:(e,t)=>({ID:rt.get(e,t),version:w.get(e,t+4)/1e3,descriptorBytes:w.get(e,t+8),headerBytes:w.get(e,t+12),seekTableBytes:w.get(e,t+16),headerDataBytes:w.get(e,t+20),apeFrameDataBytes:w.get(e,t+24),apeFrameDataBytesHigh:w.get(e,t+28),terminatingDataBytes:w.get(e,t+32),fileMD5:new $(16).get(e,t+36)})},ct={len:24,get:(e,t)=>({compressionLevel:f.get(e,t),formatFlags:f.get(e,t+2),blocksPerFrame:w.get(e,t+4),finalFrameBlocks:w.get(e,t+8),totalFrames:w.get(e,t+12),bitsPerSample:f.get(e,t+16),channel:f.get(e,t+18),sampleRate:w.get(e,t+20)})},lt={len:32,get:(e,t)=>({ID:new j(8,"ascii").get(e,t),version:w.get(e,t+8),size:w.get(e,t+12),fields:w.get(e,t+16),flags:ut(w.get(e,t+20))})},mt={len:8,get:(e,t)=>({size:w.get(e,t),flags:ut(w.get(e,t+4))})};function ut(e){return{containsHeader:dt(e,31),containsFooter:dt(e,30),isHeader:dt(e,29),readOnly:dt(e,0),dataType:(6&e)>>1}}function dt(e,t){return!!(e&1<<t)}const ht=ke("music-metadata:parser:APEv2"),pt="APEv2",ft="APETAGEX";class gt extends it{constructor(){super(...arguments),this.ape={}}static tryParseApeHeader(e,t,a){const i=new gt;return i.init(e,t,a),i.tryParseApeHeader()}static calculateDuration(e){let t=e.totalFrames>1?e.blocksPerFrame*(e.totalFrames-1):0;return t+=e.finalFrameBlocks,t/e.sampleRate}static async findApeFooterOffset(e,t){const a=new Uint8Array(lt.len);await e.randomRead(a,0,lt.len,t-lt.len);const i=lt.get(a,0);if("APETAGEX"===i.ID)return i.flags.isHeader?ht("APE Header found at offset="+(t-lt.len)):(ht("APE Footer found at offset="+(t-lt.len)),t-=i.size),{footer:i,offset:t}}static parseTagFooter(e,t,a){const i=lt.get(t,t.length-lt.len);if(i.ID!==ft)throw new Error("Unexpected APEv2 Footer ID preamble value.");u(t);const n=new gt;return n.init(e,u(t),a),n.parseTags(i)}async tryParseApeHeader(){if(this.tokenizer.fileInfo.size&&this.tokenizer.fileInfo.size-this.tokenizer.position<lt.len)return void ht("No APEv2 header found, end-of-file reached");const e=await this.tokenizer.peekToken(lt);if(e.ID===ft)return await this.tokenizer.ignore(lt.len),this.parseTags(e);if(ht(`APEv2 header not found at offset=${this.tokenizer.position}`),this.tokenizer.fileInfo.size){const e=this.tokenizer.fileInfo.size-this.tokenizer.position,t=new Uint8Array(e);return await this.tokenizer.readBuffer(t),gt.parseTagFooter(this.metadata,t,this.options)}}async parse(){const e=await this.tokenizer.readToken(ot);if("MAC "!==e.ID)throw new Error("Unexpected descriptor ID");this.ape.descriptor=e;const t=e.descriptorBytes-ot.len,a=await(t>0?this.parseDescriptorExpansion(t):this.parseHeader());return await this.tokenizer.ignore(a.forwardBytes),this.tryParseApeHeader()}async parseTags(e){const t=new Uint8Array(256);let a=e.size-lt.len;ht(`Parse APE tags at offset=${this.tokenizer.position}, size=${a}`);for(let i=0;i<e.fields;i++){if(a<mt.len){this.metadata.addWarning(`APEv2 Tag-header: ${e.fields-i} items remaining, but no more tag data to read.`);break}const n=await this.tokenizer.readToken(mt);a-=mt.len+n.size,await this.tokenizer.peekBuffer(t,{length:Math.min(t.length,a)});let r=we(t,0,t.length);const s=await this.tokenizer.readToken(new j(r,"ascii"));switch(await this.tokenizer.ignore(1),a-=s.length+1,n.flags.dataType){case st.text_utf8:{const e=(await this.tokenizer.readToken(new j(n.size,"utf8"))).split(/\x00/g);await Promise.all(e.map((e=>this.metadata.addTag(pt,s,e))));break}case st.binary:if(this.options.skipCovers)await this.tokenizer.ignore(n.size);else{const e=new Uint8Array(n.size);await this.tokenizer.readBuffer(e),r=we(e,0,e.length);const t=Y(e.slice(0,r)),a=e.slice(r+1);await this.metadata.addTag(pt,s,{description:t,data:a})}break;case st.external_info:ht(`Ignore external info ${s}`),await this.tokenizer.ignore(n.size);break;case st.reserved:ht(`Ignore external info ${s}`),this.metadata.addWarning(`APEv2 header declares a reserved datatype for "${s}"`),await this.tokenizer.ignore(n.size)}}}async parseDescriptorExpansion(e){return await this.tokenizer.ignore(e),this.parseHeader()}async parseHeader(){const e=await this.tokenizer.readToken(ct);if(this.metadata.setFormat("lossless",!0),this.metadata.setFormat("container","Monkey's Audio"),this.metadata.setFormat("bitsPerSample",e.bitsPerSample),this.metadata.setFormat("sampleRate",e.sampleRate),this.metadata.setFormat("numberOfChannels",e.channel),this.metadata.setFormat("duration",gt.calculateDuration(e)),!this.ape.descriptor)throw new Error("Missing APE descriptor");return{forwardBytes:this.ape.descriptor.seekTableBytes+this.ape.descriptor.headerDataBytes+this.ape.descriptor.apeFrameDataBytes+this.ape.descriptor.terminatingDataBytes}}}const kt=ke("music-metadata:parser:ID3v1"),bt=["Blues","Classic Rock","Country","Dance","Disco","Funk","Grunge","Hip-Hop","Jazz","Metal","New Age","Oldies","Other","Pop","R&B","Rap","Reggae","Rock","Techno","Industrial","Alternative","Ska","Death Metal","Pranks","Soundtrack","Euro-Techno","Ambient","Trip-Hop","Vocal","Jazz+Funk","Fusion","Trance","Classical","Instrumental","Acid","House","Game","Sound Clip","Gospel","Noise","Alt. Rock","Bass","Soul","Punk","Space","Meditative","Instrumental Pop","Instrumental Rock","Ethnic","Gothic","Darkwave","Techno-Industrial","Electronic","Pop-Folk","Eurodance","Dream","Southern Rock","Comedy","Cult","Gangsta Rap","Top 40","Christian Rap","Pop/Funk","Jungle","Native American","Cabaret","New Wave","Psychedelic","Rave","Showtunes","Trailer","Lo-Fi","Tribal","Acid Punk","Acid Jazz","Polka","Retro","Musical","Rock & Roll","Hard Rock","Folk","Folk/Rock","National Folk","Swing","Fast-Fusion","Bebob","Latin","Revival","Celtic","Bluegrass","Avantgarde","Gothic Rock","Progressive Rock","Psychedelic Rock","Symphonic Rock","Slow Rock","Big Band","Chorus","Easy Listening","Acoustic","Humour","Speech","Chanson","Opera","Chamber Music","Sonata","Symphony","Booty Bass","Primus","Porn Groove","Satire","Slow Jam","Club","Tango","Samba","Folklore","Ballad","Power Ballad","Rhythmic Soul","Freestyle","Duet","Punk Rock","Drum Solo","A Cappella","Euro-House","Dance Hall","Goa","Drum & Bass","Club-House","Hardcore","Terror","Indie","BritPop","Negerpunk","Polsk Punk","Beat","Christian Gangsta Rap","Heavy Metal","Black Metal","Crossover","Contemporary Christian","Christian Rock","Merengue","Salsa","Thrash Metal","Anime","JPop","Synthpop","Abstract","Art Rock","Baroque","Bhangra","Big Beat","Breakbeat","Chillout","Downtempo","Dub","EBM","Eclectic","Electro","Electroclash","Emo","Experimental","Garage","Global","IDM","Illbient","Industro-Goth","Jam Band","Krautrock","Leftfield","Lounge","Math Rock","New Romantic","Nu-Breakz","Post-Punk","Post-Rock","Psytrance","Shoegaze","Space Rock","Trop Rock","World Music","Neoclassical","Audiobook","Audio Theatre","Neue Deutsche Welle","Podcast","Indie Rock","G-Funk","Dubstep","Garage Rock","Psybient"],wt={len:128,get:(e,t)=>{const a=new Tt(3).get(e,t);return"TAG"===a?{header:a,title:new Tt(30).get(e,t+3),artist:new Tt(30).get(e,t+33),album:new Tt(30).get(e,t+63),year:new Tt(4).get(e,t+93),comment:new Tt(28).get(e,t+97),zeroByte:p.get(e,t+127),track:p.get(e,t+126),genre:p.get(e,t+127)}:null}};class Tt{constructor(e){this.len=e,this.stringType=new j(e,"latin1")}get(e,t){let a=this.stringType.get(e,t);return a=Te(a),a=a.trim(),a.length>0?a:void 0}}class yt extends it{static getGenre(e){if(e<bt.length)return bt[e]}async parse(){if(!this.tokenizer.fileInfo.size)return void kt("Skip checking for ID3v1 because the file-size is unknown");if(this.options.apeHeader){this.tokenizer.ignore(this.options.apeHeader.offset-this.tokenizer.position);const e=new gt;e.init(this.metadata,this.tokenizer,this.options),await e.parseTags(this.options.apeHeader.footer)}const e=this.tokenizer.fileInfo.size-wt.len;if(this.tokenizer.position>e)return void kt("Already consumed the last 128 bytes");const t=await this.tokenizer.readToken(wt,e);if(t){kt("ID3v1 header found at: pos=%s",this.tokenizer.fileInfo.size-wt.len);const e=["title","artist","album","comment","track","year"];for(const a of e)t[a]&&""!==t[a]&&await this.addTag(a,t[a]);const a=yt.getGenre(t.genre);a&&await this.addTag("genre",a)}else kt("ID3v1 header not found at: pos=%s",this.tokenizer.fileInfo.size-wt.len)}async addTag(e,t){await this.metadata.addTag("ID3v1",e,t)}}const vt=ke("music-metadata:id3v2:frame-parser"),St="latin1";function It(e){return"RX"===e?"Remix":"CR"===e?"Cover":e.match(/^\d*$/)?bt[Number.parseInt(e)]:void 0}class Ct{constructor(e,t){this.major=e,this.warningCollector=t}readData(e,t,a){if(0===e.length)return void this.warningCollector.addWarning(`id3v2.${this.major} header has empty tag type=${t}`);const{encoding:i,bom:n}=ze(e,0),r=e.length;let s=0,o=[];const c=Ct.getNullTerminatorLength(i);let l;switch(vt(`Parsing tag type=${t}, encoding=${i}, bom=${n}`),"TXXX"!==t&&"T"===t[0]?"T*":t){case"T*":case"GRP1":case"IPLS":case"MVIN":case"MVNM":case"PCS":case"PCST":{let a;try{a=ye(e.slice(1),i).replace(/\x00+$/,"")}catch(e){if(e instanceof Error){this.warningCollector.addWarning(`id3v2.${this.major} type=${t} header has invalid string value: ${e.message}`);break}throw e}switch(t){case"TMCL":case"TIPL":case"IPLS":o=Ct.functionList(this.splitValue(t,a));break;case"TRK":case"TRCK":case"TPOS":o=a;break;case"TCOM":case"TEXT":case"TOLY":case"TOPE":case"TPE1":case"TSRC":o=this.splitValue(t,a);break;case"TCO":case"TCON":o=this.splitValue(t,a).map((e=>function(e){const t=[];let a,i="";for(const n of e)if("string"==typeof a)if("("===n&&""===a)i+="(",a=void 0;else if(")"===n){""!==i&&(t.push(i),i="");const e=It(a);e&&t.push(e),a=void 0}else a+=n;else"("===n?a="":i+=n;return i&&(0===t.length&&i.match(/^\d*$/)&&(i=It(i)),i&&t.push(i)),t}(e))).reduce(((e,t)=>e.concat(t)),[]);break;case"PCS":case"PCST":o=this.major>=4?this.splitValue(t,a):[a],o=Array.isArray(o)&&""===o[0]?1:0;break;default:o=this.major>=4?this.splitValue(t,a):[a]}break}case"TXXX":{const a=Ct.readIdentifierAndData(e,s+1,r,i);o={description:a.id,text:this.splitValue(t,ye(a.data,i).replace(/\x00+$/,""))};break}case"PIC":case"APIC":if(a){const t={};switch(s+=1,this.major){case 2:t.format=ye(e.slice(s,s+3),"latin1"),s+=3;break;case 3:case 4:l=we(e,s,r,St),t.format=ye(e.slice(s,l),St),s=l+1;break;default:throw new Error(`Warning: unexpected major versionIndex: ${this.major}`)}t.format=Ct.fixPictureMimeType(t.format),t.type=de[e[s]],s+=1,l=we(e,s,r,i),t.description=ye(e.slice(s,l),i),s=l+c,t.data=e.slice(s,r),o=t}break;case"CNT":case"PCNT":o=T.get(e,0);break;case"SYLT":{const t=((e,t)=>{const a=Ee(e,t);return{encoding:a.encoding,language:a.language,timeStampFormat:p.get(e,t+4),contentType:p.get(e,t+5)}})(e,0);s+=6;const a={descriptor:"",language:t.language,contentType:t.contentType,timeStampFormat:t.timeStampFormat,syncText:[]};let i=!1;for(;s<r;){const n=Ct.readNullTerminatedString(e.subarray(s),t.encoding);if(s+=n.len,i){const t=T.get(e,s);s+=T.len,a.syncText.push({text:n.text,timestamp:t})}else a.descriptor=n.text,i=!0}o=a;break}case"ULT":case"USLT":case"COM":case"COMM":{const t=Ee(e,s);s+=4;const a=Ct.readNullTerminatedString(e.subarray(s),t.encoding);s+=a.len;const i=Ct.readNullTerminatedString(e.subarray(s),t.encoding);o={language:t.language,descriptor:a.text,text:i.text};break}case"UFID":{const t=Ct.readIdentifierAndData(e,s,r,St);o={owner_identifier:t.id,identifier:t.data};break}case"PRIV":{const t=Ct.readIdentifierAndData(e,s,r,St);o={owner_identifier:t.id,data:t.data};break}case"POPM":{l=we(e,s,r,St);const t=ye(e.slice(s,l),St);s=l+1;const a=r-s;o={email:t,rating:p.get(e,s),counter:a>=5?T.get(e,s+1):void 0};break}case"GEOB":{l=we(e,s+1,r,i);const t=ye(e.slice(s+1,l),St);s=l+1,l=we(e,s,r-s,i);const a=ye(e.slice(s,l),St);s=l+1,l=we(e,s,r-s,i),o={type:t,filename:a,description:ye(e.slice(s,l),St),data:e.slice(s+1,r)};break}case"WCOM":case"WCOP":case"WOAF":case"WOAR":case"WOAS":case"WORS":case"WPAY":case"WPUB":l=we(e,s+1,r,i),o=ye(e.slice(s,l),St);break;case"WXXX":{l=we(e,s+1,r,i);const t=ye(e.slice(s+1,l),i);s=l+("utf-16le"===i?2:1),o={description:t,url:ye(e.slice(s,r),St)};break}case"WFD":case"WFED":o=ye(e.slice(s+1,we(e,s+1,r,i)),i);break;case"MCDI":o=e.slice(0,r);break;default:vt(`Warning: unsupported id3v2-tag-type: ${t}`)}return o}static readNullTerminatedString(e,t){let a=t.bom?2:0;const i=we(e,a,e.length,t.encoding),n=e.slice(a,i);return a="utf-16le"===t.encoding?i+2:i+1,{text:ye(n,t.encoding),len:a}}static fixPictureMimeType(e){switch(e=e.toLocaleLowerCase()){case"jpg":return"image/jpeg";case"png":return"image/png"}return e}static functionList(e){const t={};for(let a=0;a+1<e.length;a+=2){const i=e[a+1].split(",");t[e[a]]=t[e[a]]?t[e[a]].concat(i):i}return t}splitValue(e,t){let a;return this.major<4?(a=t.split(/\x00/g),a.length>1?this.warningCollector.addWarning(`ID3v2.${this.major} ${e} uses non standard null-separator.`):a=t.split(/\//g)):a=t.split(/\x00/g),Ct.trimArray(a)}static trimArray(e){return e.map((e=>e.replace(/\x00+$/,"").trim()))}static readIdentifierAndData(e,t,a,i){const n=we(e,t,a,i),r=ye(e.slice(t,n),i);return t=n+Ct.getNullTerminatorLength(i),{id:r,data:e.slice(t,a)}}static getNullTerminatorLength(e){return"utf-16le"===e?2:1}}const xt=new TextDecoder("ascii");class At{constructor(){this.tokenizer=void 0,this.id3Header=void 0,this.metadata=void 0,this.headerType=void 0,this.options=void 0}static removeUnsyncBytes(e){let t=0,a=0;for(;t<e.length-1;)t!==a&&(e[a]=e[t]),t+=255===e[t]&&0===e[t+1]?2:1,a++;return t<e.length&&(e[a++]=e[t]),e.slice(0,a)}static getFrameHeaderLength(e){switch(e){case 2:return 6;case 3:case 4:return 10;default:throw new Error("header versionIndex is incorrect")}}static readFrameFlags(e){return{status:{tag_alter_preservation:be(e,0,6),file_alter_preservation:be(e,0,5),read_only:be(e,0,4)},format:{grouping_identity:be(e,1,7),compression:be(e,1,3),encryption:be(e,1,2),unsynchronisation:be(e,1,1),data_length_indicator:be(e,1,0)}}}static readFrameData(e,t,a,i,n){const r=new Ct(a,n);switch(a){case 2:return r.readData(e,t.id,i);case 3:case 4:return t.flags?.format.unsynchronisation&&(e=At.removeUnsyncBytes(e)),t.flags?.format.data_length_indicator&&(e=e.slice(4,e.length)),r.readData(e,t.id,i);default:throw new Error(`Unexpected majorVer: ${a}`)}}static makeDescriptionTagName(e,t){return e+(t?`:${t}`:"")}async parse(e,t,a){this.tokenizer=t,this.metadata=e,this.options=a;const i=await this.tokenizer.readToken(xe);if("ID3"!==i.fileIdentifier)throw new Error("expected ID3-header file-identifier 'ID3' was not found");return this.id3Header=i,this.headerType=`ID3v2.${i.version.major}`,i.flags.isExtendedHeader?this.parseExtendedHeader():this.parseId3Data(i.size)}async parseExtendedHeader(){const e=await this.tokenizer.readToken(Ae),t=e.size-Ae.len;return t>0?this.parseExtendedHeaderData(t,e.size):this.parseId3Data(this.id3Header.size-e.size)}async parseExtendedHeaderData(e,t){return await this.tokenizer.ignore(e),this.parseId3Data(this.id3Header.size-t)}async parseId3Data(e){const t=await this.tokenizer.readToken(new $(e));for(const e of this.parseMetadata(t))"TXXX"===e.id?e.value&&await this.handleTag(e,e.value.text,(()=>e.value.description)):await(Array.isArray(e.value)?Promise.all(e.value.map((t=>this.addTag(e.id,t)))):this.addTag(e.id,e.value))}async handleTag(e,t,a,i=e=>e){await Promise.all(t.map((t=>this.addTag(At.makeDescriptionTagName(e.id,a(t)),i(t)))))}async addTag(e,t){await this.metadata.addTag(this.headerType,e,t)}parseMetadata(e){let t=0;const a=[];for(;t!==e.length;){const i=At.getFrameHeaderLength(this.id3Header.version.major);if(t+i>e.length){this.metadata.addWarning("Illegal ID3v2 tag length");break}const n=e.slice(t,t+i);t+=i;const r=this.readFrameHeader(n,this.id3Header.version.major),s=e.slice(t,t+r.length);t+=r.length;const o=At.readFrameData(s,r,this.id3Header.version.major,!this.options.skipCovers,this.metadata);o&&a.push({id:r.id,value:o})}return a}readFrameHeader(e,t){let a;switch(t){case 2:a={id:xt.decode(e.slice(0,3)),length:b.get(e,3)},a.id.match(/[A-Z0-9]{3}/g)||this.metadata.addWarning(`Invalid ID3v2.${this.id3Header.version.major} frame-header-ID: ${a.id}`);break;case 3:case 4:a={id:xt.decode(e.slice(0,4)),length:(4===t?Ce:T).get(e,4),flags:At.readFrameFlags(e.slice(8,10))},a.id.match(/[A-Z0-9]{4}/g)||this.metadata.addWarning(`Invalid ID3v2.${this.id3Header.version.major} frame-header-ID: ${a.id}`);break;default:throw new Error(`Unexpected majorVer: ${t}`)}return a}}const zt={NONE:"not compressed\tPCM\tApple Computer",sowt:"PCM (byte swapped)",fl32:"32-bit floating point IEEE 32-bit float",fl64:"64-bit floating point IEEE 64-bit float\tApple Computer",alaw:"ALaw 2:1\t8-bit ITU-T G.711 A-law",ulaw:"µLaw 2:1\t8-bit ITU-T G.711 µ-law\tApple Computer",ULAW:"CCITT G.711 u-law 8-bit ITU-T G.711 µ-law",ALAW:"CCITT G.711 A-law 8-bit ITU-T G.711 A-law",FL32:"Float 32\tIEEE 32-bit float "};class Et{constructor(e,t){this.isAifc=t;const a=t?22:18;if(e.chunkSize<a)throw new Error(`COMMON CHUNK size should always be at least ${a}`);this.len=e.chunkSize}get(e,t){const a=g.get(e,t+8)-16398,i=g.get(e,t+8+2),n={numChannels:g.get(e,t),numSampleFrames:T.get(e,t+2),sampleSize:g.get(e,t+6),sampleRate:a<0?i>>Math.abs(a):i<<a};if(this.isAifc){if(n.compressionType=rt.get(e,t+18),this.len>22){const a=p.get(e,t+22);if(a>0){if(23+a+(a+1)%2!==this.len)throw new Error("Illegal pstring length");n.compressionName=new j(a,"latin1").get(e,t+23)}else n.compressionName=void 0}}else n.compressionName="PCM";return n}}const Ft={len:8,get:(e,t)=>({chunkID:rt.get(e,t),chunkSize:Number(BigInt(T.get(e,t+4)))})},Dt=ke("music-metadata:parser:aiff");class Mt extends it{constructor(){super(...arguments),this.isCompressed=null}async parse(){if("FORM"!==(await this.tokenizer.readToken(Ft)).chunkID)throw new Error("Invalid Chunk-ID, expected 'FORM'");const e=await this.tokenizer.readToken(rt);switch(e){case"AIFF":this.metadata.setFormat("container",e),this.isCompressed=!1;break;case"AIFC":this.metadata.setFormat("container","AIFF-C"),this.isCompressed=!0;break;default:throw new Error(`Unsupported AIFF type: ${e}`)}this.metadata.setFormat("lossless",!this.isCompressed);try{for(;!this.tokenizer.fileInfo.size||this.tokenizer.fileInfo.size-this.tokenizer.position>=Ft.len;){Dt(`Reading AIFF chunk at offset=${this.tokenizer.position}`);const e=await this.tokenizer.readToken(Ft),t=2*Math.round(e.chunkSize/2),a=await this.readData(e);await this.tokenizer.ignore(t-a)}}catch(e){if(!(e instanceof n))throw e;Dt("End-of-stream")}}async readData(e){switch(e.chunkID){case"COMM":{if(null===this.isCompressed)throw new Error("Failed to parse AIFF.COMM chunk when compression type is unknown");const t=await this.tokenizer.readToken(new Et(e,this.isCompressed));return this.metadata.setFormat("bitsPerSample",t.sampleSize),this.metadata.setFormat("sampleRate",t.sampleRate),this.metadata.setFormat("numberOfChannels",t.numChannels),this.metadata.setFormat("numberOfSamples",t.numSampleFrames),this.metadata.setFormat("duration",t.numSampleFrames/t.sampleRate),(t.compressionName||t.compressionType)&&this.metadata.setFormat("codec",t.compressionName??zt[t.compressionType]),e.chunkSize}case"ID3 ":{const t=u(await this.tokenizer.readToken(new $(e.chunkSize)));return await(new At).parse(this.metadata,t,this.options),e.chunkSize}case"SSND":return this.metadata.format.duration&&this.metadata.setFormat("bitrate",8*e.chunkSize/this.metadata.format.duration),0;case"NAME":case"AUTH":case"(c) ":case"ANNO":return this.readTextChunk(e);default:return Dt(`Ignore chunk id=${e.chunkID}, size=${e.chunkSize}`),0}}async readTextChunk(e){const t=(await this.tokenizer.readToken(new j(e.chunkSize,"ascii"))).split("\0").map((e=>e.trim())).filter((e=>e?.length));return await Promise.all(t.map((t=>this.metadata.addTag("AIFF",e.chunkID,t)))),e.chunkSize}}class Pt{static fromBin(e,t=0){return new Pt(Pt.decode(e,t))}static decode(e,t=0){const a=new DataView(e.buffer,t);return`${a.getUint32(0,!0).toString(16)}-${a.getUint16(4,!0).toString(16)}-${a.getUint16(6,!0).toString(16)}-${a.getUint16(8).toString(16)}-${ee(e.slice(t+10,t+16))}`.toUpperCase()}static decodeMediaType(e){switch(e.str){case Pt.AudioMedia.str:return"audio";case Pt.VideoMedia.str:return"video";case Pt.CommandMedia.str:return"command";case Pt.Degradable_JPEG_Media.str:return"degradable-jpeg";case Pt.FileTransferMedia.str:return"file-transfer";case Pt.BinaryMedia.str:return"binary"}}static encode(e){const t=new Uint8Array(16),a=new DataView(t.buffer);return a.setUint32(0,Number.parseInt(e.slice(0,8),16),!0),a.setUint16(4,Number.parseInt(e.slice(9,13),16),!0),a.setUint16(6,Number.parseInt(e.slice(14,18),16),!0),t.set(ae(e.slice(19,23)),8),t.set(ae(e.slice(24)),10),t}constructor(e){this.str=e}equals(e){return this.str===e.str}toBin(){return Pt.encode(this.str)}}Pt.HeaderObject=new Pt("75B22630-668E-11CF-A6D9-00AA0062CE6C"),Pt.DataObject=new Pt("75B22636-668E-11CF-A6D9-00AA0062CE6C"),Pt.SimpleIndexObject=new Pt("33000890-E5B1-11CF-89F4-00A0C90349CB"),Pt.IndexObject=new Pt("D6E229D3-35DA-11D1-9034-00A0C90349BE"),Pt.MediaObjectIndexObject=new Pt("FEB103F8-12AD-4C64-840F-2A1D2F7AD48C"),Pt.TimecodeIndexObject=new Pt("3CB73FD0-0C4A-4803-953D-EDF7B6228F0C"),Pt.FilePropertiesObject=new Pt("8CABDCA1-A947-11CF-8EE4-00C00C205365"),Pt.StreamPropertiesObject=new Pt("B7DC0791-A9B7-11CF-8EE6-00C00C205365"),Pt.HeaderExtensionObject=new Pt("5FBF03B5-A92E-11CF-8EE3-00C00C205365"),Pt.CodecListObject=new Pt("86D15240-311D-11D0-A3A4-00A0C90348F6"),Pt.ScriptCommandObject=new Pt("1EFB1A30-0B62-11D0-A39B-00A0C90348F6"),Pt.MarkerObject=new Pt("F487CD01-A951-11CF-8EE6-00C00C205365"),Pt.BitrateMutualExclusionObject=new Pt("D6E229DC-35DA-11D1-9034-00A0C90349BE"),Pt.ErrorCorrectionObject=new Pt("75B22635-668E-11CF-A6D9-00AA0062CE6C"),Pt.ContentDescriptionObject=new Pt("75B22633-668E-11CF-A6D9-00AA0062CE6C"),Pt.ExtendedContentDescriptionObject=new Pt("D2D0A440-E307-11D2-97F0-00A0C95EA850"),Pt.ContentBrandingObject=new Pt("2211B3FA-BD23-11D2-B4B7-00A0C955FC6E"),Pt.StreamBitratePropertiesObject=new Pt("7BF875CE-468D-11D1-8D82-006097C9A2B2"),Pt.ContentEncryptionObject=new Pt("2211B3FB-BD23-11D2-B4B7-00A0C955FC6E"),Pt.ExtendedContentEncryptionObject=new Pt("298AE614-2622-4C17-B935-DAE07EE9289C"),Pt.DigitalSignatureObject=new Pt("2211B3FC-BD23-11D2-B4B7-00A0C955FC6E"),Pt.PaddingObject=new Pt("1806D474-CADF-4509-A4BA-9AABCB96AAE8"),Pt.ExtendedStreamPropertiesObject=new Pt("14E6A5CB-C672-4332-8399-A96952065B5A"),Pt.AdvancedMutualExclusionObject=new Pt("A08649CF-4775-4670-8A16-6E35357566CD"),Pt.GroupMutualExclusionObject=new Pt("D1465A40-5A79-4338-B71B-E36B8FD6C249"),Pt.StreamPrioritizationObject=new Pt("D4FED15B-88D3-454F-81F0-ED5C45999E24"),Pt.BandwidthSharingObject=new Pt("A69609E6-517B-11D2-B6AF-00C04FD908E9"),Pt.LanguageListObject=new Pt("7C4346A9-EFE0-4BFC-B229-393EDE415C85"),Pt.MetadataObject=new Pt("C5F8CBEA-5BAF-4877-8467-AA8C44FA4CCA"),Pt.MetadataLibraryObject=new Pt("44231C94-9498-49D1-A141-1D134E457054"),Pt.IndexParametersObject=new Pt("D6E229DF-35DA-11D1-9034-00A0C90349BE"),Pt.MediaObjectIndexParametersObject=new Pt("6B203BAD-3F11-48E4-ACA8-D7613DE2CFA7"),Pt.TimecodeIndexParametersObject=new Pt("F55E496D-9797-4B5D-8C8B-604DFE9BFB24"),Pt.CompatibilityObject=new Pt("26F18B5D-4584-47EC-9F5F-0E651F0452C9"),Pt.AdvancedContentEncryptionObject=new Pt("43058533-6981-49E6-9B74-AD12CB86D58C"),Pt.AudioMedia=new Pt("F8699E40-5B4D-11CF-A8FD-00805F5C442B"),Pt.VideoMedia=new Pt("BC19EFC0-5B4D-11CF-A8FD-00805F5C442B"),Pt.CommandMedia=new Pt("59DACFC0-59E6-11D0-A3AC-00A0C90348F6"),Pt.JFIF_Media=new Pt("B61BE100-5B4E-11CF-A8FD-00805F5C442B"),Pt.Degradable_JPEG_Media=new Pt("35907DE0-E415-11CF-A917-00805F5C442B"),Pt.FileTransferMedia=new Pt("91BD222C-F21C-497A-8B6D-5AA86BFC0185"),Pt.BinaryMedia=new Pt("3AFB65E2-47EF-40F2-AC2C-70A90D71D343"),Pt.ASF_Index_Placeholder_Object=new Pt("D9AADE20-7C17-4F9C-BC28-8555DD98E2A2");const _t=Pt;function Rt(e){return ve(ye(e,"utf-16le"))}const Bt=[Rt,Ot,function(e,t=0){return 1===Lt(e,t)},function(e,t=0){return w.get(e,t)},function(e,t=0){return z.get(e,t)},Lt,Ot];function Ot(e){return new Uint8Array(e)}function Lt(e,t=0){return f.get(e,t)}var Nt;!function(e){e[e.UnicodeString=0]="UnicodeString",e[e.ByteArray=1]="ByteArray",e[e.Bool=2]="Bool",e[e.DWord=3]="DWord",e[e.QWord=4]="QWord",e[e.Word=5]="Word"}(Nt||(Nt={}));const Ut={len:30,get:(e,t)=>({objectId:_t.fromBin(e,t),objectSize:Number(z.get(e,t+16)),numberOfHeaderObjects:w.get(e,t+24)})},$t={len:24,get:(e,t)=>({objectId:_t.fromBin(e,t),objectSize:Number(z.get(e,t+16))})};class jt{constructor(e){this.len=Number(e.objectSize)-$t.len}postProcessTag(e,t,a,i){if("WM/Picture"===t)e.push({id:t,value:ia.fromBuffer(i)});else{const n=Bt[a];if(!n)throw new Error(`unexpected value headerType: ${a}`);e.push({id:t,value:n(i)})}}}class Gt extends jt{get(e,t){return null}}class Xt extends jt{get(e,t){return{fileId:_t.fromBin(e,t),fileSize:z.get(e,t+16),creationDate:z.get(e,t+24),dataPacketsCount:z.get(e,t+32),playDuration:z.get(e,t+40),sendDuration:z.get(e,t+48),preroll:z.get(e,t+56),flags:{broadcast:be(e,t+64,24),seekable:be(e,t+64,25)},minimumDataPacketSize:w.get(e,t+68),maximumDataPacketSize:w.get(e,t+72),maximumBitrate:w.get(e,t+76)}}}Xt.guid=_t.FilePropertiesObject;class Wt extends jt{get(e,t){return{streamType:_t.decodeMediaType(_t.fromBin(e,t)),errorCorrectionType:_t.fromBin(e,t+8)}}}Wt.guid=_t.StreamPropertiesObject;class Ht{constructor(){this.len=22}get(e,t){const a=new DataView(e.buffer,t);return{reserved1:_t.fromBin(e,t),reserved2:a.getUint16(16,!0),extensionDataSize:a.getUint16(18,!0)}}}Ht.guid=_t.HeaderExtensionObject;const Vt={len:20,get:(e,t)=>({entryCount:new DataView(e.buffer,t).getUint16(16,!0)})};async function qt(e){const t=await e.readNumber(f);return(await e.readToken(new j(2*t,"utf-16le"))).replace("\0","")}async function Kt(e){const t=await e.readToken(Vt),a=[];for(let i=0;i<t.entryCount;++i)a.push(await Zt(e));return a}async function Yt(e){const t=await e.readNumber(f),a=new Uint8Array(t);return await e.readBuffer(a),a}async function Zt(e){const t=await e.readNumber(f);return{type:{videoCodec:!(1&~t),audioCodec:!(2&~t)},codecName:await qt(e),description:await qt(e),information:await Yt(e)}}class Jt extends jt{get(e,t){const a=[],i=new DataView(e.buffer,t);let n=10;for(let r=0;r<Jt.contentDescTags.length;++r){const s=i.getUint16(2*r,!0);if(s>0){const i=Jt.contentDescTags[r],o=n+s;a.push({id:i,value:Rt(e.slice(t+n,t+o))}),n=o}}return a}}Jt.guid=_t.ContentDescriptionObject,Jt.contentDescTags=["Title","Author","Copyright","Description","Rating"];class Qt extends jt{get(e,t){const a=[],i=new DataView(e.buffer,t),n=i.getUint16(0,!0);let r=2;for(let s=0;s<n;s+=1){const n=i.getUint16(r,!0);r+=2;const s=Rt(e.slice(t+r,t+r+n));r+=n;const o=i.getUint16(r,!0);r+=2;const c=i.getUint16(r,!0);r+=2;const l=e.slice(t+r,t+r+c);r+=c,this.postProcessTag(a,s,o,l)}return a}}Qt.guid=_t.ExtendedContentDescriptionObject;class ea extends jt{get(e,t){const a=new DataView(e.buffer,t);return{startTime:z.get(e,t),endTime:z.get(e,t+8),dataBitrate:a.getInt32(12,!0),bufferSize:a.getInt32(16,!0),initialBufferFullness:a.getInt32(20,!0),alternateDataBitrate:a.getInt32(24,!0),alternateBufferSize:a.getInt32(28,!0),alternateInitialBufferFullness:a.getInt32(32,!0),maximumObjectSize:a.getInt32(36,!0),flags:{reliableFlag:be(e,t+40,0),seekableFlag:be(e,t+40,1),resendLiveCleanpointsFlag:be(e,t+40,2)},streamNumber:a.getInt16(42,!0),streamLanguageId:a.getInt16(44,!0),averageTimePerFrame:a.getInt32(52,!0),streamNameCount:a.getInt32(54,!0),payloadExtensionSystems:a.getInt32(56,!0),streamNames:[],streamPropertiesObject:null}}}ea.guid=_t.ExtendedStreamPropertiesObject;class ta extends jt{get(e,t){const a=[],i=new DataView(e.buffer,t),n=i.getUint16(0,!0);let r=2;for(let s=0;s<n;s+=1){r+=4;const n=i.getUint16(r,!0);r+=2;const s=i.getUint16(r,!0);r+=2;const o=i.getUint32(r,!0);r+=4;const c=Rt(e.slice(t+r,t+r+n));r+=n;const l=e.slice(t+r,t+r+o);r+=o,this.postProcessTag(a,c,s,l)}return a}}ta.guid=_t.MetadataObject;class aa extends ta{}aa.guid=_t.MetadataLibraryObject;class ia{static fromBuffer(e){return new ia(e.length).get(e,0)}constructor(e){this.len=e}get(e,t){const a=new DataView(e.buffer,t),i=a.getUint8(0),n=a.getInt32(1,!0);let r=5;for(;0!==a.getUint16(r);)r+=2;const s=new j(r-5,"utf-16le").get(e,5);for(;0!==a.getUint16(r);)r+=2;const o=new j(r-5,"utf-16le").get(e,5);return{type:de[i],format:s,description:o,size:n,data:e.slice(r+4)}}}const na=ke("music-metadata:parser:ASF");class ra extends it{async parse(){const e=await this.tokenizer.readToken(Ut);if(!e.objectId.equals(_t.HeaderObject))throw new Error(`expected asf header; but was not found; got: ${e.objectId.str}`);try{await this.parseObjectHeader(e.numberOfHeaderObjects)}catch(e){na("Error while parsing ASF: %s",e)}}async parseObjectHeader(e){let t;do{const e=await this.tokenizer.readToken($t);switch(na("header GUID=%s",e.objectId.str),e.objectId.str){case Xt.guid.str:{const t=await this.tokenizer.readToken(new Xt(e));this.metadata.setFormat("duration",Number(t.playDuration/BigInt(1e3))/1e4-Number(t.preroll)/1e3),this.metadata.setFormat("bitrate",t.maximumBitrate);break}case Wt.guid.str:{const t=await this.tokenizer.readToken(new Wt(e));this.metadata.setFormat("container",`ASF/${t.streamType}`);break}case Ht.guid.str:{const e=await this.tokenizer.readToken(new Ht);await this.parseExtensionObject(e.extensionDataSize);break}case Jt.guid.str:t=await this.tokenizer.readToken(new Jt(e)),await this.addTags(t);break;case Qt.guid.str:t=await this.tokenizer.readToken(new Qt(e)),await this.addTags(t);break;case _t.CodecListObject.str:{const e=await Kt(this.tokenizer);e.forEach((e=>{this.metadata.addStreamInfo({type:e.type.videoCodec?ue.video:ue.audio,codecName:e.codecName})}));const t=e.filter((e=>e.type.audioCodec)).map((e=>e.codecName)).join("/");this.metadata.setFormat("codec",t);break}case _t.StreamBitratePropertiesObject.str:await this.tokenizer.ignore(e.objectSize-$t.len);break;case _t.PaddingObject.str:na("Padding: %s bytes",e.objectSize-$t.len),await this.tokenizer.ignore(e.objectSize-$t.len);break;default:this.metadata.addWarning(`Ignore ASF-Object-GUID: ${e.objectId.str}`),na("Ignore ASF-Object-GUID: %s",e.objectId.str),await this.tokenizer.readToken(new Gt(e))}}while(--e)}async addTags(e){await Promise.all(e.map((({id:e,value:t})=>this.metadata.addTag("asf",e,t))))}async parseExtensionObject(e){do{const t=await this.tokenizer.readToken($t),a=t.objectSize-$t.len;switch(t.objectId.str){case ea.guid.str:await this.tokenizer.readToken(new ea(t));break;case ta.guid.str:{const e=await this.tokenizer.readToken(new ta(t));await this.addTags(e);break}case aa.guid.str:{const e=await this.tokenizer.readToken(new aa(t));await this.addTags(e);break}case _t.PaddingObject.str:await this.tokenizer.ignore(a);break;case _t.CompatibilityObject.str:this.tokenizer.ignore(a);break;case _t.ASF_Index_Placeholder_Object.str:await this.tokenizer.ignore(a);break;default:this.metadata.addWarning(`Ignore ASF-Object-GUID: ${t.objectId.str}`),await this.tokenizer.readToken(new Gt(t))}e-=t.objectSize}while(e>0)}}class sa{static fromBase64(e){return sa.fromBuffer(Uint8Array.from(atob(e),(e=>e.charCodeAt(0))))}static fromBuffer(e){return new sa(e.length).get(e,0)}constructor(e){this.len=e}get(e,t){const a=de[T.get(e,t)];t+=4;const i=T.get(e,t);t+=4;const n=new j(i,"utf-8").get(e,t);t+=i;const r=T.get(e,t);t+=4;const s=new j(r,"utf-8").get(e,t);t+=r;const o=T.get(e,t);t+=4;const c=T.get(e,t);t+=4;const l=T.get(e,t);t+=4;const m=T.get(e,t);t+=4;const u=T.get(e,t);return t+=4,{type:a,format:n,description:s,width:o,height:c,colour_depth:l,indexed_color:m,data:Uint8Array.from(e.slice(t,t+u))}}}const oa=(e,t)=>({packetType:p.get(e,t),vorbis:new j(6,"ascii").get(e,t+1)}),ca=ke("music-metadata:parser:ID3");class la extends it{constructor(){super(...arguments),this.id3parser=new At}static async startsWithID3v2Header(e){return"ID3"===(await e.peekToken(xe)).fileIdentifier}async parse(){try{await this.parseID3v2()}catch(e){if(!(e instanceof n))throw e;ca("End-of-stream")}}finalize(){}async parseID3v2(){if(await this.tryReadId3v2Headers(),ca("End of ID3v2 header, go to MPEG-parser: pos=%s",this.tokenizer.position),await this.postId3v2Parse(),this.options.skipPostHeaders&&this.metadata.hasAny())this.finalize();else{const e=new yt;await e.init(this.metadata,this.tokenizer,this.options).parse(),this.finalize()}}async tryReadId3v2Headers(){if("ID3"===(await this.tokenizer.peekToken(xe)).fileIdentifier)return ca("Found ID3v2 header, pos=%s",this.tokenizer.position),await this.id3parser.parse(this.metadata,this.tokenizer,this.options),this.tryReadId3v2Headers()}}class ma{constructor(e,t){this.data=e,this.offset=t}readInt32(){const e=w.get(this.data,this.offset);return this.offset+=4,e}readStringUtf8(){const e=this.readInt32(),t=new TextDecoder("utf-8").decode(this.data.subarray(this.offset,this.offset+e));return this.offset+=e,t}parseUserComment(){const e=this.offset,t=this.readStringUtf8(),a=t.indexOf("=");return{key:t.slice(0,a).toUpperCase(),value:t.slice(a+1),len:this.offset-e}}}const ua=ke("music-metadata:parser:ogg:vorbis1");class da{constructor(e,t){this.metadata=e,this.options=t,this.pageSegments=[]}async parsePage(e,t){if(e.headerType.firstPage)this.parseFirstPage(e,t);else{if(e.headerType.continued){if(0===this.pageSegments.length)throw new Error("Cannot continue on previous page");this.pageSegments.push(t)}if(e.headerType.lastPage||!e.headerType.continued){if(this.pageSegments.length>0){const e=da.mergeUint8Arrays(this.pageSegments);await this.parseFullPage(e)}this.pageSegments=e.headerType.lastPage?[]:[t]}}e.headerType.lastPage&&this.calculateDuration(e)}static mergeUint8Arrays(e){const t=e.reduce(((e,t)=>e+t.length),0),a=new Uint8Array(t);return e.forEach(((e,t,i)=>{const n=i.slice(0,t).reduce(((e,t)=>e+t.length),0);a.set(e,n)})),a}async flush(){await this.parseFullPage(da.mergeUint8Arrays(this.pageSegments))}async parseUserComment(e,t){const a=new ma(e,t).parseUserComment();return await this.addTag(a.key,a.value),a.len}async addTag(e,t){if("METADATA_BLOCK_PICTURE"===e&&"string"==typeof t){if(this.options.skipCovers)return void ua("Ignore picture");t=sa.fromBase64(t),ua(`Push picture: id=${e}, format=${t.format}`)}else ua(`Push tag: id=${e}, value=${t}`);await this.metadata.addTag("vorbis",e,t)}calculateDuration(e){this.metadata.format.sampleRate&&e.absoluteGranulePosition>=0&&(this.metadata.setFormat("numberOfSamples",e.absoluteGranulePosition),this.metadata.setFormat("duration",e.absoluteGranulePosition/this.metadata.format.sampleRate))}parseFirstPage(e,t){this.metadata.setFormat("codec","Vorbis I"),ua("Parse first page");const a=oa(t,0);if("vorbis"!==a.vorbis)throw new Error("Metadata does not look like Vorbis");if(1!==a.packetType)throw new Error("First Ogg page should be type 1: the identification header");{const e=(i=t,n=7,{version:w.get(i,n+0),channelMode:p.get(i,n+4),sampleRate:w.get(i,n+5),bitrateMax:w.get(i,n+9),bitrateNominal:w.get(i,n+13),bitrateMin:w.get(i,n+17)});this.metadata.setFormat("sampleRate",e.sampleRate),this.metadata.setFormat("bitrate",e.bitrateNominal),this.metadata.setFormat("numberOfChannels",e.channelMode),ua("sample-rate=%s[hz], bitrate=%s[b/s], channel-mode=%s",e.sampleRate,e.bitrateNominal,e.channelMode)}var i,n}async parseFullPage(e){const t=oa(e,0);if(ua("Parse full page: type=%s, byteLength=%s",t.packetType,e.byteLength),3===t.packetType)return this.parseUserCommentList(e,7)}async parseUserCommentList(e,t){const a=w.get(e,t);t+=4,t+=a;let i=w.get(e,t);for(t+=4;i-- >0;)t+=await this.parseUserComment(e,t)}}const ha=ke("music-metadata:parser:FLAC");var pa;!function(e){e[e.STREAMINFO=0]="STREAMINFO",e[e.PADDING=1]="PADDING",e[e.APPLICATION=2]="APPLICATION",e[e.SEEKTABLE=3]="SEEKTABLE",e[e.VORBIS_COMMENT=4]="VORBIS_COMMENT",e[e.CUESHEET=5]="CUESHEET",e[e.PICTURE=6]="PICTURE"}(pa||(pa={}));class fa extends la{constructor(){super(...arguments),this.padding=0}init(e,t,a){return super.init(e,t,a),this.vorbisParser=new da(e,a),this}async postId3v2Parse(){if("fLaC"!==(await this.tokenizer.readToken(rt)).toString())throw new Error("Invalid FLAC preamble");let e;do{e=await this.tokenizer.readToken(ga),await this.parseDataBlock(e)}while(!e.lastBlock);if(this.tokenizer.fileInfo.size&&this.metadata.format.duration){const e=this.tokenizer.fileInfo.size-this.tokenizer.position;this.metadata.setFormat("bitrate",8*e/this.metadata.format.duration)}}async parseDataBlock(e){switch(ha(`blockHeader type=${e.type}, length=${e.length}`),e.type){case pa.STREAMINFO:return this.parseBlockStreamInfo(e.length);case pa.PADDING:this.padding+=e.length;break;case pa.APPLICATION:case pa.SEEKTABLE:break;case pa.VORBIS_COMMENT:return this.parseComment(e.length);case pa.CUESHEET:break;case pa.PICTURE:return void await this.parsePicture(e.length);default:this.metadata.addWarning(`Unknown block type: ${e.type}`)}return this.tokenizer.ignore(e.length).then()}async parseBlockStreamInfo(e){if(e!==ka.len)throw new Error("Unexpected block-stream-info length");const t=await this.tokenizer.readToken(ka);this.metadata.setFormat("container","FLAC"),this.metadata.setFormat("codec","FLAC"),this.metadata.setFormat("lossless",!0),this.metadata.setFormat("numberOfChannels",t.channels),this.metadata.setFormat("bitsPerSample",t.bitsPerSample),this.metadata.setFormat("sampleRate",t.sampleRate),t.totalSamples>0&&this.metadata.setFormat("duration",t.totalSamples/t.sampleRate)}async parseComment(e){const t=await this.tokenizer.readToken(new $(e)),a=new ma(t,0);a.readStringUtf8();const i=a.readInt32(),n=new Array(i);for(let e=0;e<i;e++)n[e]=a.parseUserComment();await Promise.all(n.map((e=>this.vorbisParser.addTag(e.key,e.value))))}async parsePicture(e){if(this.options.skipCovers)return this.tokenizer.ignore(e);const t=await this.tokenizer.readToken(new sa(e));this.vorbisParser.addTag("METADATA_BLOCK_PICTURE",t)}}const ga={len:4,get:(e,t)=>({lastBlock:be(e,t,7),type:Se(e,t,1,7),length:b.get(e,t+1)})},ka={len:34,get:(e,t)=>({minimumBlockSize:g.get(e,t),maximumBlockSize:g.get(e,t+2)/1e3,minimumFrameSize:b.get(e,t+4),maximumFrameSize:b.get(e,t+7),sampleRate:b.get(e,t+10)>>4,channels:Se(e,t+12,4,3)+1,bitsPerSample:Se(e,t+12,7,5)+1,totalSamples:Se(e,t+13,4,36),fileMD5:new $(16).get(e,t+18)})},ba=ke("music-metadata:parser:MP4:atom"),wa={len:8,get:(e,t)=>{const a=T.get(e,t);if(a<0)throw new Error("Invalid atom header length");return{length:BigInt(a),name:new j(4,"latin1").get(e,t+4)}},put:(e,t,a)=>(T.put(e,t,Number(a.length)),rt.put(e,t+4,a.name))},Ta=F,ya={len:4,get:(e,t)=>({type:new j(4,"ascii").get(e,t)})};class va{constructor(e,t,a){if(this.len=e,e<t)throw new Error(`Atom ${a} expected to be ${t}, but specifies ${e} bytes long.`);e>t&&ba(`Warning: atom ${a} expected to be ${t}, but was actually ${e} bytes long.`)}}const Sa=(e,t)=>{const a=T.get(e,t)-2082844800;return new Date(1e3*a)};class Ia extends va{constructor(e){super(e,24,"mdhd"),this.len=e}get(e,t){return{version:p.get(e,t+0),flags:b.get(e,t+1),creationTime:Sa(e,t+4),modificationTime:Sa(e,t+8),timeScale:T.get(e,t+12),duration:T.get(e,t+16),language:g.get(e,t+20),quality:g.get(e,t+22)}}}class Ca extends va{constructor(e){super(e,100,"mvhd"),this.len=e}get(e,t){return{version:p.get(e,t),flags:b.get(e,t+1),creationTime:Sa(e,t+4),modificationTime:Sa(e,t+8),timeScale:T.get(e,t+12),duration:T.get(e,t+16),preferredRate:T.get(e,t+20),preferredVolume:g.get(e,t+24),previewTime:T.get(e,t+72),previewDuration:T.get(e,t+76),posterTime:T.get(e,t+80),selectionTime:T.get(e,t+84),selectionDuration:T.get(e,t+88),currentTime:T.get(e,t+92),nextTrackID:T.get(e,t+96)}}}class xa{constructor(e){this.len=e}get(e,t){return{type:{set:p.get(e,t+0),type:b.get(e,t+1)},locale:b.get(e,t+4),value:new $(this.len-8).get(e,t+8)}}}class Aa{constructor(e){this.len=e}get(e,t){return{version:p.get(e,t),flags:b.get(e,t+1),name:new j(this.len-4,"utf-8").get(e,t+4)}}}class za{constructor(e){this.len=e}get(e,t){return{version:p.get(e,t),flags:b.get(e,t+1),creationTime:Sa(e,t+4),modificationTime:Sa(e,t+8),trackId:T.get(e,t+12),duration:T.get(e,t+20),layer:g.get(e,t+24),alternateGroup:g.get(e,t+26),volume:g.get(e,t+28)}}}class Ea{constructor(e){this.len=e}get(e,t){return{dataFormat:rt.get(e,t),dataReferenceIndex:g.get(e,t+10),description:new $(this.len-12).get(e,t+12)}}}class Fa{constructor(e){this.len=e}get(e,t){const a=((e,t)=>({version:p.get(e,t),flags:b.get(e,t+1),numberOfEntries:T.get(e,t+4)}))(e,t);t+=8;const i=[];for(let n=0;n<a.numberOfEntries;++n){const a=T.get(e,t);t+=T.len,i.push(new Ea(a).get(e,t)),t+=a}return{header:a,table:i}}}const Da=8,Ma=(e,t)=>({version:v.get(e,t),revision:v.get(e,t+2),vendor:x.get(e,t+4)}),Pa=(e,t)=>({numAudioChannels:v.get(e,t+0),sampleSize:v.get(e,t+2),compressionId:v.get(e,t+4),packetSize:v.get(e,t+6),sampleRate:g.get(e,t+8)+g.get(e,t+10)/1e4});class _a{constructor(e,t){this.len=e,this.token=t}get(e,t){const a=x.get(e,t+4);return{version:y.get(e,t+0),flags:C.get(e,t+1),numberOfEntries:a,entries:ja(e,this.token,t+8,this.len-8,a)}}}const Ra={len:8,get:(e,t)=>({count:x.get(e,t+0),duration:x.get(e,t+4)})};class Ba extends _a{constructor(e){super(e,Ra),this.len=e}}const Oa={len:12,get:(e,t)=>({firstChunk:x.get(e,t),samplesPerChunk:x.get(e,t+4),sampleDescriptionId:x.get(e,t+8)})};class La extends _a{constructor(e){super(e,Oa),this.len=e}}class Na{constructor(e){this.len=e}get(e,t){const a=x.get(e,t+8);return{version:y.get(e,t),flags:C.get(e,t+1),sampleSize:x.get(e,t+4),numberOfEntries:a,entries:ja(e,x,t+12,this.len-12,a)}}}class Ua extends _a{constructor(e){super(e,x),this.len=e}}class $a{constructor(e){this.len=e}get(e,t){const a=v.get(e,t+0);return new j(a,"utf-8").get(e,t+2)}}function ja(e,t,a,i,n){if(ba(`remainingLen=${i}, numberOfEntries=${n} * token-len=${t.len}`),0===i)return[];if(i!==n*t.len)throw new Error("mismatch number-of-entries with remaining atom-length");const r=[];for(let i=0;i<n;++i)r.push(t.get(e,a)),a+=t.len;return r}const Ga=ke("music-metadata:parser:MP4:Atom");class Xa{static async readAtom(e,t,a,i){const n=e.position,r=await e.readToken(wa);r.length===BigInt(1)&&(r.length=await e.readToken(Ta));const s=new Xa(r,r.length===BigInt(1),a),o=s.getPayloadLength(i);return Ga(`parse atom name=${s.atomPath}, extended=${s.extended}, offset=${n}, len=${s.header.length}`),await s.readData(e,t,o),s}constructor(e,t,a){this.header=e,this.extended=t,this.parent=a,this.children=[],this.atomPath=(this.parent?`${this.parent.atomPath}.`:"")+this.header.name}getHeaderLength(){return this.extended?16:8}getPayloadLength(e){return(this.header.length===BigInt(0)?e:Number(this.header.length))-this.getHeaderLength()}async readAtoms(e,t,a){for(;a>0;){const i=await Xa.readAtom(e,t,this,a);this.children.push(i),a-=i.header.length===BigInt(0)?a:Number(i.header.length)}}async readData(e,t,a){switch(this.header.name){case"moov":case"udta":case"trak":case"mdia":case"minf":case"stbl":case"<id>":case"ilst":case"tref":return this.readAtoms(e,t,this.getPayloadLength(a));case"meta":{const i="hdlr"===(await e.peekToken(wa)).name?0:4;return await e.ignore(i),this.readAtoms(e,t,this.getPayloadLength(a)-i)}default:return t(this,a)}}}const Wa=ke("music-metadata:parser:MP4"),Ha={raw:{lossy:!1,format:"raw"},MAC3:{lossy:!0,format:"MACE 3:1"},MAC6:{lossy:!0,format:"MACE 6:1"},ima4:{lossy:!0,format:"IMA 4:1"},ulaw:{lossy:!0,format:"uLaw 2:1"},alaw:{lossy:!0,format:"uLaw 2:1"},Qclp:{lossy:!0,format:"QUALCOMM PureVoice"},".mp3":{lossy:!0,format:"MPEG-1 layer 3"},alac:{lossy:!1,format:"ALAC"},"ac-3":{lossy:!0,format:"AC-3"},mp4a:{lossy:!0,format:"MPEG-4/AAC"},mp4s:{lossy:!0,format:"MP4S"},c608:{lossy:!0,format:"CEA-608"},c708:{lossy:!0,format:"CEA-708"}};function Va(e,t,a){return a.indexOf(e)===t}class qa extends it{constructor(){super(...arguments),this.tracks=[],this.atomParsers={mvhd:async e=>{const t=await this.tokenizer.readToken(new Ca(e));this.metadata.setFormat("creationTime",t.creationTime),this.metadata.setFormat("modificationTime",t.modificationTime)},mdhd:async e=>{const t=await this.tokenizer.readToken(new Ia(e)),a=this.getTrackDescription();a.creationTime=t.creationTime,a.modificationTime=t.modificationTime,a.timeScale=t.timeScale,a.duration=t.duration},chap:async e=>{const t=this.getTrackDescription(),a=[];for(;e>=T.len;)a.push(await this.tokenizer.readNumber(T)),e-=T.len;t.chapterList=a},tkhd:async e=>{const t=await this.tokenizer.readToken(new za(e));this.tracks.push(t)},mdat:async e=>{if(this.audioLengthInBytes=e,this.calculateBitRate(),this.options.includeChapters){const t=this.tracks.filter((e=>e.chapterList));if(1===t.length){const a=t[0].chapterList,i=this.tracks.filter((e=>-1!==a.indexOf(e.trackId)));if(1===i.length)return this.parseChapterTrack(i[0],t[0],e)}}await this.tokenizer.ignore(e)},ftyp:async e=>{const t=[];for(;e>0;){const a=await this.tokenizer.readToken(ya);e-=ya.len;const i=a.type.replace(/\W/g,"");i.length>0&&t.push(i)}Wa(`ftyp: ${t.join("/")}`);const a=t.filter(Va).join("/");this.metadata.setFormat("container",a)},stsd:async e=>{const t=await this.tokenizer.readToken(new Fa(e));this.getTrackDescription().soundSampleDescription=t.table.map((e=>this.parseSoundSampleDescription(e)))},stsc:async e=>{const t=await this.tokenizer.readToken(new La(e));this.getTrackDescription().sampleToChunkTable=t.entries},stts:async e=>{const t=await this.tokenizer.readToken(new Ba(e));this.getTrackDescription().timeToSampleTable=t.entries},stsz:async e=>{const t=await this.tokenizer.readToken(new Na(e)),a=this.getTrackDescription();a.sampleSize=t.sampleSize,a.sampleSizeTable=t.entries},stco:async e=>{const t=await this.tokenizer.readToken(new Ua(e));this.getTrackDescription().chunkOffsetTable=t.entries},date:async e=>{const t=await this.tokenizer.readToken(new j(e,"utf-8"));await this.addTag("date",t)}}}static read_BE_Integer(e,t){const a=(t?"INT":"UINT")+8*e.length+(e.length>1?"_BE":""),n=i[a];if(!n)throw new Error(`Token for integer type not found: "${a}"`);return Number(n.get(e,0))}async parse(){this.tracks=[];let e=this.tokenizer.fileInfo.size||0;for(;!this.tokenizer.fileInfo.size||e>0;){try{if("\0\0\0\0"===(await this.tokenizer.peekToken(wa)).name){const e=`Error at offset=${this.tokenizer.position}: box.id=0`;Wa(e),this.addWarning(e);break}}catch(e){if(!(e instanceof Error))throw e;{const t=`Error at offset=${this.tokenizer.position}: ${e.message}`;Wa(t),this.addWarning(t)}break}const t=await Xa.readAtom(this.tokenizer,((e,t)=>this.handleAtom(e,t)),null,e);e-=t.header.length===BigInt(0)?e:Number(t.header.length)}const t=[];this.tracks.forEach((e=>{const a=[];e.soundSampleDescription.forEach((e=>{const t={},i=Ha[e.dataFormat];if(i?(a.push(i.format),t.codecName=i.format):t.codecName=`<${e.dataFormat}>`,e.description){const{description:a}=e;a.sampleRate>0&&(t.type=ue.audio,t.audio={samplingFrequency:a.sampleRate,bitDepth:a.sampleSize,channels:a.numAudioChannels})}this.metadata.addStreamInfo(t)})),a.length>=1&&t.push(a.join("/"))})),t.length>0&&this.metadata.setFormat("codec",t.filter(Va).join("+"));const a=this.tracks.filter((e=>e.soundSampleDescription.length>=1&&e.soundSampleDescription[0].description&&e.soundSampleDescription[0].description.numAudioChannels>0));if(a.length>=1){const e=a[0];if(e.timeScale>0){const t=e.duration/e.timeScale;this.metadata.setFormat("duration",t)}const t=e.soundSampleDescription[0];if(t.description&&(this.metadata.setFormat("sampleRate",t.description.sampleRate),this.metadata.setFormat("bitsPerSample",t.description.sampleSize),this.metadata.setFormat("numberOfChannels",t.description.numAudioChannels),0===e.timeScale&&e.timeToSampleTable.length>0)){const a=e.timeToSampleTable.map((e=>e.count*e.duration)).reduce(((e,t)=>e+t))/t.description.sampleRate;this.metadata.setFormat("duration",a)}const i=Ha[t.dataFormat];i&&this.metadata.setFormat("lossless",!i.lossy),this.calculateBitRate()}}async handleAtom(e,t){if(e.parent)switch(e.parent.header.name){case"ilst":case"<id>":return this.parseMetadataItemData(e)}if(this.atomParsers[e.header.name])return this.atomParsers[e.header.name](t);Wa(`No parser for atom path=${e.atomPath}, payload-len=${t}, ignoring atom`),await this.tokenizer.ignore(t)}getTrackDescription(){return this.tracks[this.tracks.length-1]}calculateBitRate(){this.audioLengthInBytes&&this.metadata.format.duration&&this.metadata.setFormat("bitrate",8*this.audioLengthInBytes/this.metadata.format.duration)}async addTag(e,t){await this.metadata.addTag("iTunes",e,t)}addWarning(e){Wa(`Warning: ${e}`),this.metadata.addWarning(e)}parseMetadataItemData(e){let t=e.header.name;return e.readAtoms(this.tokenizer,(async(e,a)=>{const i=e.getPayloadLength(a);switch(e.header.name){case"data":return this.parseValueAtom(t,e);case"name":case"mean":case"rate":{const e=await this.tokenizer.readToken(new Aa(i));t+=`:${e.name}`;break}default:{const a=await this.tokenizer.readToken(new $(i));this.addWarning(`Unsupported meta-item: ${t}[${e.header.name}] => value=${ee(a)} ascii=${Y(a,"ascii")}`)}}}),e.getPayloadLength(0))}async parseValueAtom(e,t){const a=await this.tokenizer.readToken(new xa(Number(t.header.length)-wa.len));if(0!==a.type.set)throw new Error(`Unsupported type-set != 0: ${a.type.set}`);switch(a.type.type){case 0:switch(e){case"trkn":case"disk":{const t=p.get(a.value,3),i=p.get(a.value,5);await this.addTag(e,`${t}/${i}`);break}case"gnre":{const t=p.get(a.value,1),i=bt[t-1];await this.addTag(e,i);break}case"rate":{const t=new TextDecoder("ascii").decode(a.value);await this.addTag(e,t);break}default:Wa(`unknown proprietary value type for: ${t.atomPath}`)}break;case 1:case 18:await this.addTag(e,new TextDecoder("utf-8").decode(a.value));break;case 13:if(this.options.skipCovers)break;await this.addTag(e,{format:"image/jpeg",data:Uint8Array.from(a.value)});break;case 14:if(this.options.skipCovers)break;await this.addTag(e,{format:"image/png",data:Uint8Array.from(a.value)});break;case 21:await this.addTag(e,qa.read_BE_Integer(a.value,!0));break;case 22:await this.addTag(e,qa.read_BE_Integer(a.value,!1));break;case 65:await this.addTag(e,p.get(a.value,0));break;case 66:await this.addTag(e,g.get(a.value,0));break;case 67:await this.addTag(e,T.get(a.value,0));break;default:this.addWarning(`atom key=${e}, has unknown well-known-type (data-type): ${a.type.type}`)}}parseSoundSampleDescription(e){const t={dataFormat:e.dataFormat,dataReferenceIndex:e.dataReferenceIndex};let a=0;const i=Ma(e.description,a);return a+=Da,0===i.version||1===i.version?t.description=Pa(e.description,a):Wa(`Warning: sound-sample-description ${i} not implemented`),t}async parseChapterTrack(e,t,a){if(!e.sampleSize&&e.chunkOffsetTable.length!==e.sampleSizeTable.length)throw new Error("Expected equal chunk-offset-table & sample-size-table length.");const i=[];for(let n=0;n<e.chunkOffsetTable.length&&a>0;++n){const r=e.chunkOffsetTable[n]-this.tokenizer.position,s=e.sampleSize>0?e.sampleSize:e.sampleSizeTable[n];if((a-=r+s)<0)throw new Error("Chapter chunk exceeding token length");await this.tokenizer.ignore(r);const o=await this.tokenizer.readToken(new $a(s));Wa(`Chapter ${n+1}: ${o}`);const c={title:o,sampleOffset:this.findSampleOffset(t,this.tokenizer.position)};Wa(`Chapter title=${c.title}, offset=${c.sampleOffset}/${this.tracks[0].duration}`),i.push(c)}this.metadata.setFormat("chapters",i),await this.tokenizer.ignore(a)}findSampleOffset(e,t){let a=0;e.timeToSampleTable.forEach((e=>{a+=e.count*e.duration})),Wa(`Total duration=${a}`);let i=0;for(;i<e.chunkOffsetTable.length&&e.chunkOffsetTable[i]<t;)++i;return this.getChunkDuration(i+1,e)}getChunkDuration(e,t){let a=0,i=t.timeToSampleTable[a].count,n=t.timeToSampleTable[a].duration,r=1,s=this.getSamplesPerChunk(r,t.sampleToChunkTable),o=0;for(;r<e;){const e=Math.min(i,s);o+=e*n,i-=e,s-=e,0===s?(++r,s=this.getSamplesPerChunk(r,t.sampleToChunkTable)):(++a,i=t.timeToSampleTable[a].count,n=t.timeToSampleTable[a].duration)}return o}getSamplesPerChunk(e,t){for(let a=0;a<t.length-1;++a)if(e>=t[a].firstChunk&&e<t[a+1].firstChunk)return t[a].samplesPerChunk;return t[t.length-1].samplesPerChunk}}var Ka,Ya;!function(e){e[e.not_set=0]="not_set",e[e.radio=1]="radio",e[e.audiophile=2]="audiophile"}(Ka||(Ka={})),function(e){e[e.unspecified=0]="unspecified",e[e.engineer=1]="engineer",e[e.user=2]="user",e[e.automatic=3]="automatic",e[e.rms_average=4]="rms_average"}(Ya||(Ya={}));const Za=(e,t)=>{const a=Se(e,t,0,3),i=Se(e,t,6,1),n=Se(e,t,7,9)/10;if(a>0)return{type:Se(e,t,0,3),origin:Se(e,t,3,3),adjustment:i?-n:n}},Ja={len:27,get:(e,t)=>{const a=T.get(e,t+2);return{revision:Se(e,t,0,4),vbr_method:Se(e,t,4,4),lowpass_filter:100*p.get(e,t+1),track_peak:0===a?null:a/2**23,track_gain:Za(e,6),album_gain:Za(e,8),music_length:T.get(e,t+20),music_crc:p.get(e,t+24),header_crc:g.get(e,t+24)}}},Qa=new j(4,"ascii"),ei=new j(6,"ascii"),ti={len:4,get:(e,t)=>({frames:Ie(e,t,31),bytes:Ie(e,t,30),toc:Ie(e,t,29),vbrScale:Ie(e,t,28)})},ai=ke("music-metadata:parser:mpeg"),ii={AudioObjectTypes:["AAC Main","AAC LC","AAC SSR","AAC LTP"],SamplingFrequencies:[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350,null,null,-1]},ni=[void 0,["front-center"],["front-left","front-right"],["front-center","front-left","front-right"],["front-center","front-left","front-right","back-center"],["front-center","front-left","front-right","back-left","back-right"],["front-center","front-left","front-right","back-left","back-right","LFE-channel"],["front-center","front-left","front-right","side-left","side-right","back-left","back-right","LFE-channel"]];class ri{constructor(e,t){this.bitrateIndex=null,this.sampRateFreqIndex=null,this.padding=null,this.privateBit=null,this.channelModeIndex=null,this.modeExtension=null,this.isOriginalMedia=null,this.version=null,this.bitrate=null,this.samplingRate=null,this.frameLength=0,this.versionIndex=Se(e,t+1,3,2),this.layer=ri.LayerDescription[Se(e,t+1,5,2)],this.versionIndex>1&&0===this.layer?this.parseAdtsHeader(e,t):this.parseMpegHeader(e,t),this.isProtectedByCRC=!Ie(e,t+1,7)}calcDuration(e){return null==this.samplingRate?null:e*this.calcSamplesPerFrame()/this.samplingRate}calcSamplesPerFrame(){return ri.samplesInFrameTable[1===this.version?0:1][this.layer]}calculateSideInfoLength(){if(3!==this.layer)return 2;if(3===this.channelModeIndex){if(1===this.version)return 17;if(2===this.version||2.5===this.version)return 9}else{if(1===this.version)return 32;if(2===this.version||2.5===this.version)return 17}return null}calcSlotSize(){return[null,4,1,1][this.layer]}parseMpegHeader(e,t){this.container="MPEG",this.bitrateIndex=Se(e,t+2,0,4),this.sampRateFreqIndex=Se(e,t+2,4,2),this.padding=Ie(e,t+2,6),this.privateBit=Ie(e,t+2,7),this.channelModeIndex=Se(e,t+3,0,2),this.modeExtension=Se(e,t+3,2,2),this.isCopyrighted=Ie(e,t+3,4),this.isOriginalMedia=Ie(e,t+3,5),this.emphasis=Se(e,t+3,7,2),this.version=ri.VersionID[this.versionIndex],this.channelMode=ri.ChannelMode[this.channelModeIndex],this.codec=`MPEG ${this.version} Layer ${this.layer}`;const a=this.calcBitrate();if(!a)throw new Error("Cannot determine bit-rate");if(this.bitrate=1e3*a,this.samplingRate=this.calcSamplingRate(),null==this.samplingRate)throw new Error("Cannot determine sampling-rate")}parseAdtsHeader(e,t){ai("layer=0 => ADTS"),this.version=2===this.versionIndex?4:2,this.container=`ADTS/MPEG-${this.version}`;const a=Se(e,t+2,0,2);this.codec="AAC",this.codecProfile=ii.AudioObjectTypes[a],ai(`MPEG-4 audio-codec=${this.codec}`);const i=Se(e,t+2,2,4);this.samplingRate=ii.SamplingFrequencies[i],ai(`sampling-rate=${this.samplingRate}`);const n=Se(e,t+2,7,3);this.mp4ChannelConfig=ni[n],ai(`channel-config=${this.mp4ChannelConfig?this.mp4ChannelConfig.join("+"):"?"}`),this.frameLength=Se(e,t+3,6,2)<<11}calcBitrate(){if(0===this.bitrateIndex||15===this.bitrateIndex)return null;if(this.version&&this.bitrateIndex){const e=10*Math.floor(this.version)+this.layer;return ri.bitrate_index[this.bitrateIndex][e]}return null}calcSamplingRate(){return 3===this.sampRateFreqIndex||null===this.version||null==this.sampRateFreqIndex?null:ri.sampling_rate_freq_index[this.version][this.sampRateFreqIndex]}}ri.SyncByte1=255,ri.SyncByte2=224,ri.VersionID=[2.5,null,2,1],ri.LayerDescription=[0,3,2,1],ri.ChannelMode=["stereo","joint_stereo","dual_channel","mono"],ri.bitrate_index={1:{11:32,12:32,13:32,21:32,22:8,23:8},2:{11:64,12:48,13:40,21:48,22:16,23:16},3:{11:96,12:56,13:48,21:56,22:24,23:24},4:{11:128,12:64,13:56,21:64,22:32,23:32},5:{11:160,12:80,13:64,21:80,22:40,23:40},6:{11:192,12:96,13:80,21:96,22:48,23:48},7:{11:224,12:112,13:96,21:112,22:56,23:56},8:{11:256,12:128,13:112,21:128,22:64,23:64},9:{11:288,12:160,13:128,21:144,22:80,23:80},10:{11:320,12:192,13:160,21:160,22:96,23:96},11:{11:352,12:224,13:192,21:176,22:112,23:112},12:{11:384,12:256,13:224,21:192,22:128,23:128},13:{11:416,12:320,13:256,21:224,22:144,23:144},14:{11:448,12:384,13:320,21:256,22:160,23:160}},ri.sampling_rate_freq_index={1:{0:44100,1:48e3,2:32e3},2:{0:22050,1:24e3,2:16e3},2.5:{0:11025,1:12e3,2:8e3}},ri.samplesInFrameTable=[[0,384,1152,1152],[0,384,1152,576]];class si extends la{constructor(){super(...arguments),this.frameCount=0,this.syncFrameCount=-1,this.countSkipFrameData=0,this.totalDataLength=0,this.bitrates=[],this.offset=0,this.frame_size=0,this.crc=null,this.calculateEofDuration=!1,this.samplesPerFrame=null,this.buf_frame_header=new Uint8Array(4),this.mpegOffset=null,this.syncPeek={buf:new Uint8Array(1024),len:0}}async postId3v2Parse(){this.metadata.setFormat("lossless",!1);try{let e=!1;for(;!e;)await this.sync(),e=await this.parseCommonMpegHeader()}catch(e){if(!(e instanceof n))throw e;if(ai("End-of-stream"),this.calculateEofDuration&&null!==this.samplesPerFrame){const e=this.frameCount*this.samplesPerFrame;if(this.metadata.setFormat("numberOfSamples",e),this.metadata.format.sampleRate){const t=e/this.metadata.format.sampleRate;ai(`Calculate duration at EOF: ${t} sec.`,t),this.metadata.setFormat("duration",t)}}}}finalize(){const e=this.metadata.format,t=!!this.metadata.native.ID3v1;if(null!==this.mpegOffset)if(e.duration&&this.tokenizer.fileInfo.size){const a=this.tokenizer.fileInfo.size-this.mpegOffset-(t?128:0);e.codecProfile&&"V"===e.codecProfile[0]&&this.metadata.setFormat("bitrate",8*a/e.duration)}else if(this.tokenizer.fileInfo.size&&"CBR"===e.codecProfile){const a=this.tokenizer.fileInfo.size-this.mpegOffset-(t?128:0);if(null!==this.frame_size&&null!==this.samplesPerFrame){const t=Math.round(a/this.frame_size)*this.samplesPerFrame;if(this.metadata.setFormat("numberOfSamples",t),e.sampleRate){const a=t/e.sampleRate;ai("Calculate CBR duration based on file size: %s",a),this.metadata.setFormat("duration",a)}}}}async sync(){let e=!1;for(;;){let t=0;if(this.syncPeek.len=await this.tokenizer.peekBuffer(this.syncPeek.buf,{length:1024,mayBeLess:!0}),this.syncPeek.len<=163)throw new n;for(;;){if(e&&!(224&~this.syncPeek.buf[t]))return this.buf_frame_header[0]=ri.SyncByte1,this.buf_frame_header[1]=this.syncPeek.buf[t],await this.tokenizer.ignore(t),ai(`Sync at offset=${this.tokenizer.position-1}, frameCount=${this.frameCount}`),this.syncFrameCount===this.frameCount&&(ai(`Re-synced MPEG stream, frameCount=${this.frameCount}`),this.frameCount=0,this.frame_size=0),void(this.syncFrameCount=this.frameCount);if(e=!1,t=this.syncPeek.buf.indexOf(ri.SyncByte1,t),-1===t){if(this.syncPeek.len<this.syncPeek.buf.length)throw new n;await this.tokenizer.ignore(this.syncPeek.len);break}++t,e=!0}}}async parseCommonMpegHeader(){let e;0===this.frameCount&&(this.mpegOffset=this.tokenizer.position-1),await this.tokenizer.peekBuffer(this.buf_frame_header,{offset:1,length:3});try{t=this.buf_frame_header,e=new ri(t,0)}catch(e){if(await this.tokenizer.ignore(1),e instanceof Error)return this.metadata.addWarning(`Parse error: ${e.message}`),!1;throw e}var t;return await this.tokenizer.ignore(3),this.metadata.setFormat("container",e.container),this.metadata.setFormat("codec",e.codec),this.metadata.setFormat("lossless",!1),this.metadata.setFormat("sampleRate",e.samplingRate),this.frameCount++,null!==e.version&&e.version>=2&&0===e.layer?this.parseAdts(e):this.parseAudioFrameHeader(e)}async parseAudioFrameHeader(e){this.metadata.setFormat("numberOfChannels","mono"===e.channelMode?1:2),this.metadata.setFormat("bitrate",e.bitrate),this.frameCount<2e5&&ai("offset=%s MP%s bitrate=%s sample-rate=%s",this.tokenizer.position-4,e.layer,e.bitrate,e.samplingRate);const t=e.calcSlotSize();if(null===t)throw new Error("invalid slot_size");const a=e.calcSamplesPerFrame();ai(`samples_per_frame=${a}`);const i=a/8;if(null!==e.bitrate&&null!=e.samplingRate){const a=i*e.bitrate/e.samplingRate+(e.padding?t:0);this.frame_size=Math.floor(a)}if(this.audioFrameHeader=e,null!==e.bitrate&&this.bitrates.push(e.bitrate),1===this.frameCount)return this.offset=4,await this.skipSideInformation(),!1;if(3===this.frameCount){if(this.areAllSame(this.bitrates)){if(this.samplesPerFrame=a,this.metadata.setFormat("codecProfile","CBR"),this.tokenizer.fileInfo.size)return!0}else if(this.metadata.format.duration)return!0;if(!this.options.duration)return!0}return this.options.duration&&4===this.frameCount&&(this.samplesPerFrame=a,this.calculateEofDuration=!0),this.offset=4,e.isProtectedByCRC?(await this.parseCrc(),!1):(await this.skipSideInformation(),!1)}async parseAdts(e){const t=new Uint8Array(3);if(await this.tokenizer.readBuffer(t),e.frameLength+=Se(t,0,0,11),this.totalDataLength+=e.frameLength,this.samplesPerFrame=1024,null!==e.samplingRate){const t=e.samplingRate/this.samplesPerFrame,a=8*(0===this.frameCount?0:this.totalDataLength/this.frameCount)*t+.5;this.metadata.setFormat("bitrate",a),ai(`frame-count=${this.frameCount}, size=${e.frameLength} bytes, bit-rate=${a}`)}if(await this.tokenizer.ignore(e.frameLength>7?e.frameLength-7:1),3===this.frameCount){if(this.metadata.setFormat("codecProfile",e.codecProfile),e.mp4ChannelConfig&&this.metadata.setFormat("numberOfChannels",e.mp4ChannelConfig.length),!this.options.duration)return!0;this.calculateEofDuration=!0}return!1}async parseCrc(){return this.crc=await this.tokenizer.readNumber(v),this.offset+=2,this.skipSideInformation()}async skipSideInformation(){if(this.audioFrameHeader){const e=this.audioFrameHeader.calculateSideInfoLength();if(null!==e)return await this.tokenizer.readToken(new $(e)),this.offset+=e,void await this.readXtraInfoHeader()}}async readXtraInfoHeader(){const e=await this.tokenizer.readToken(Qa);switch(this.offset+=Qa.len,e){case"Info":return this.metadata.setFormat("codecProfile","CBR"),this.readXingInfoHeader();case"Xing":{const e=await this.readXingInfoHeader();if(null!==e.vbrScale){const a=(t=e.vbrScale,`V${Math.floor((100-t)/10)}`);this.metadata.setFormat("codecProfile",a)}return null}case"Xtra":break;case"LAME":{const e=await this.tokenizer.readToken(ei);if(null!==this.frame_size&&this.frame_size>=this.offset+ei.len)return this.offset+=ei.len,this.metadata.setFormat("tool",`LAME ${e}`),await this.skipFrameData(this.frame_size-this.offset),null;this.metadata.addWarning("Corrupt LAME header");break}}var t;const a=this.frame_size-this.offset;return a<0?this.metadata.addWarning(`Frame ${this.frameCount}corrupt: negative frameDataLeft`):await this.skipFrameData(a),null}async readXingInfoHeader(){const e=this.tokenizer.position,t=await async function(e){const t=await e.readToken(ti),a={numFrames:null,streamSize:null,vbrScale:null};if(t.frames&&(a.numFrames=await e.readToken(T)),t.bytes&&(a.streamSize=await e.readToken(T)),t.toc&&(a.toc=new Uint8Array(100),await e.readBuffer(a.toc)),t.vbrScale&&(a.vbrScale=await e.readToken(T)),"LAME"===await e.peekToken(new j(4,"ascii"))){await e.ignore(4),a.lame={version:await e.readToken(new j(5,"ascii"))};const t=a.lame.version.match(/\d+.\d+/g);if(null!==t){const i=t[0].split(".").map((e=>Number.parseInt(e,10)));i[0]>=3&&i[1]>=90&&(a.lame.extended=await e.readToken(Ja))}}return a}(this.tokenizer);if(this.offset+=this.tokenizer.position-e,t.lame&&(this.metadata.setFormat("tool",`LAME ${ve(t.lame.version)}`),t.lame.extended&&(this.metadata.setFormat("trackPeakLevel",t.lame.extended.track_peak),t.lame.extended.track_gain&&this.metadata.setFormat("trackGain",t.lame.extended.track_gain.adjustment),t.lame.extended.album_gain&&this.metadata.setFormat("albumGain",t.lame.extended.album_gain.adjustment),this.metadata.setFormat("duration",t.lame.extended.music_length/1e3))),t.streamSize&&this.audioFrameHeader&&null!==t.numFrames){const e=this.audioFrameHeader.calcDuration(t.numFrames);return this.metadata.setFormat("duration",e),ai("Get duration from Xing header: %s",this.metadata.format.duration),t}const a=this.frame_size-this.offset;return await this.skipFrameData(a),t}async skipFrameData(e){if(e<0)throw new Error("frame-data-left cannot be negative");await this.tokenizer.ignore(e),this.countSkipFrameData+=e}areAllSame(e){const t=e[0];return e.every((e=>e===t))}}const oi=ke("music-metadata:parser:musepack:sv8"),ci=new j(2,"latin1"),li={len:5,get:(e,t)=>({crc:w.get(e,t),streamVersion:p.get(e,t+4)})},mi={len:2,get:(e,t)=>({sampleFrequency:[44100,48e3,37800,32e3][Se(e,t,0,3)],maxUsedBands:Se(e,t,3,5),channelCount:Se(e,t+1,0,4)+1,msUsed:Ie(e,t+1,4),audioBlockFrames:Se(e,t+1,5,3)})};class ui{constructor(e){this.tokenizer=e}async readPacketHeader(){const e=await this.tokenizer.readToken(ci),t=await this.readVariableSizeField();return{key:e,payloadLength:t.value-2-t.len}}async readStreamHeader(e){const t={};oi(`Reading SH at offset=${this.tokenizer.position}`);const a=await this.tokenizer.readToken(li);e-=li.len,Object.assign(t,a),oi(`SH.streamVersion = ${a.streamVersion}`);const i=await this.readVariableSizeField();e-=i.len,t.sampleCount=i.value;const n=await this.readVariableSizeField();e-=n.len,t.beginningOfSilence=n.value;const r=await this.tokenizer.readToken(mi);return e-=mi.len,Object.assign(t,r),await this.tokenizer.ignore(e),t}async readVariableSizeField(e=1,t=0){let a=await this.tokenizer.readNumber(p);return 128&a?(a&=127,a+=t,this.readVariableSizeField(e+1,a<<7)):{len:e,value:t+a}}}const di=ke("music-metadata:parser:musepack");class hi extends it{constructor(){super(...arguments),this.audioLength=0}async parse(){if("MPCK"!==await this.tokenizer.readToken(rt))throw new Error("Invalid Magic number");return this.metadata.setFormat("container","Musepack, SV8"),this.parsePacket()}async parsePacket(){const e=new ui(this.tokenizer);for(;;){const t=await e.readPacketHeader();switch(di(`packet-header key=${t.key}, payloadLength=${t.payloadLength}`),t.key){case"SH":{const a=await e.readStreamHeader(t.payloadLength);this.metadata.setFormat("numberOfSamples",a.sampleCount),this.metadata.setFormat("sampleRate",a.sampleFrequency),this.metadata.setFormat("duration",a.sampleCount/a.sampleFrequency),this.metadata.setFormat("numberOfChannels",a.channelCount);break}case"AP":this.audioLength+=t.payloadLength,await this.tokenizer.ignore(t.payloadLength);break;case"RG":case"EI":case"SO":case"ST":case"CT":await this.tokenizer.ignore(t.payloadLength);break;case"SE":return this.metadata.format.duration&&this.metadata.setFormat("bitrate",8*this.audioLength/this.metadata.format.duration),gt.tryParseApeHeader(this.metadata,this.tokenizer,this.options);default:throw new Error(`Unexpected header: ${t.key}`)}}}}class pi{constructor(e){this.tokenizer=e,this.pos=0,this.dword=null}async read(e){for(;null===this.dword;)this.dword=await this.tokenizer.readToken(w);let t=this.dword;return this.pos+=e,this.pos<32?(t>>>=32-this.pos,t&(1<<e)-1):(this.pos-=32,0===this.pos?(this.dword=null,t&(1<<e)-1):(this.dword=await this.tokenizer.readToken(w),this.pos&&(t<<=this.pos,t|=this.dword>>>32-this.pos),t&(1<<e)-1))}async ignore(e){if(this.pos>0){const t=32-this.pos;this.dword=null,e-=t,this.pos=0}const t=e%32,a=(e-t)/32;return await this.tokenizer.ignore(4*a),this.read(t)}}const fi={len:24,get:(e,t)=>{const a={signature:new TextDecoder("latin1").decode(e.subarray(t,t+3)),streamMinorVersion:Se(e,t+3,0,4),streamMajorVersion:Se(e,t+3,4,4),frameCount:w.get(e,t+4),maxLevel:f.get(e,t+8),sampleFrequency:[44100,48e3,37800,32e3][Se(e,t+10,0,2)],link:Se(e,t+10,2,2),profile:Se(e,t+10,4,4),maxBand:Se(e,t+11,0,6),intensityStereo:Ie(e,t+11,6),midSideStereo:Ie(e,t+11,7),titlePeak:f.get(e,t+12),titleGain:f.get(e,t+14),albumPeak:f.get(e,t+16),albumGain:f.get(e,t+18),lastFrameLength:w.get(e,t+20)>>>20&2047,trueGapless:Ie(e,t+23,0)};return a.lastFrameLength=a.trueGapless?w.get(e,20)>>>20&2047:0,a}},gi=ke("music-metadata:parser:musepack");class ki extends it{constructor(){super(...arguments),this.bitreader=null,this.audioLength=0,this.duration=null}async parse(){const e=await this.tokenizer.readToken(fi);if("MP+"!==e.signature)throw new Error("Unexpected magic number");gi(`stream-version=${e.streamMajorVersion}.${e.streamMinorVersion}`),this.metadata.setFormat("container","Musepack, SV7"),this.metadata.setFormat("sampleRate",e.sampleFrequency);const t=1152*(e.frameCount-1)+e.lastFrameLength;this.metadata.setFormat("numberOfSamples",t),this.duration=t/e.sampleFrequency,this.metadata.setFormat("duration",this.duration),this.bitreader=new pi(this.tokenizer),this.metadata.setFormat("numberOfChannels",e.midSideStereo||e.intensityStereo?2:1);const a=await this.bitreader.read(8);return this.metadata.setFormat("codec",(a/100).toFixed(2)),await this.skipAudioData(e.frameCount),gi(`End of audio stream, switching to APEv2, offset=${this.tokenizer.position}`),gt.tryParseApeHeader(this.metadata,this.tokenizer,this.options)}async skipAudioData(e){for(;e-- >0;){const e=await this.bitreader.read(20);this.audioLength+=20+e,await this.bitreader.ignore(e)}const t=await this.bitreader.read(11);this.audioLength+=t,null!==this.duration&&this.metadata.setFormat("bitrate",this.audioLength/this.duration)}}const bi=ke("music-metadata:parser:musepack"),wi=class extends la{async postId3v2Parse(){let e;switch(await this.tokenizer.peekToken(new j(3,"latin1"))){case"MP+":bi("Musepack stream-version 7"),e=new ki;break;case"MPC":bi("Musepack stream-version 8"),e=new hi;break;default:throw new Error("Invalid Musepack signature prefix")}return e.init(this.metadata,this.tokenizer,this.options),e.parse()}};class Ti{constructor(e){if(this.len=e,e<19)throw new Error("ID-header-page 0 should be at least 19 bytes long")}get(e,t){return{magicSignature:new j(8,"ascii").get(e,t+0),version:p.get(e,t+8),channelCount:p.get(e,t+9),preSkip:f.get(e,t+10),inputSampleRate:w.get(e,t+12),outputGain:f.get(e,t+16),channelMapping:p.get(e,t+18)}}}class yi extends da{constructor(e,t,a){super(e,t),this.tokenizer=a,this.idHeader=null,this.lastPos=-1}parseFirstPage(e,t){if(this.metadata.setFormat("codec","Opus"),this.idHeader=new Ti(t.length).get(t,0),"OpusHead"!==this.idHeader.magicSignature)throw new Error("Illegal ogg/Opus magic-signature");this.metadata.setFormat("sampleRate",this.idHeader.inputSampleRate),this.metadata.setFormat("numberOfChannels",this.idHeader.channelCount)}async parseFullPage(e){"OpusTags"===new j(8,"ascii").get(e,0)&&(await this.parseUserCommentList(e,8),this.lastPos=this.tokenizer.position-e.length)}calculateDuration(e){if(this.metadata.format.sampleRate&&e.absoluteGranulePosition>=0){const t=e.absoluteGranulePosition-this.idHeader.preSkip;if(this.metadata.setFormat("numberOfSamples",t),this.metadata.setFormat("duration",t/48e3),-1!==this.lastPos&&this.tokenizer.fileInfo.size&&this.metadata.format.duration){const e=this.tokenizer.fileInfo.size-this.lastPos;this.metadata.setFormat("bitrate",8*e/this.metadata.format.duration)}}}}const vi=ke("music-metadata:parser:ogg:speex");class Si extends da{constructor(e,t,a){super(e,t),this.tokenizer=a}parseFirstPage(e,t){vi("First Ogg/Speex page");const a=(i=t,n=0,{speex:new j(8,"ascii").get(i,n+0),version:Te(new j(20,"ascii").get(i,n+8)),version_id:A.get(i,n+28),header_size:A.get(i,n+32),rate:A.get(i,n+36),mode:A.get(i,n+40),mode_bitstream_version:A.get(i,n+44),nb_channels:A.get(i,n+48),bitrate:A.get(i,n+52),frame_size:A.get(i,n+56),vbr:A.get(i,n+60),frames_per_packet:A.get(i,n+64),extra_headers:A.get(i,n+68),reserved1:A.get(i,n+72),reserved2:A.get(i,n+76)});var i,n;this.metadata.setFormat("codec",`Speex ${a.version}`),this.metadata.setFormat("numberOfChannels",a.nb_channels),this.metadata.setFormat("sampleRate",a.rate),-1!==a.bitrate&&this.metadata.setFormat("bitrate",a.bitrate)}}const Ii=ke("music-metadata:parser:ogg:theora");class Ci{constructor(e,t,a){this.metadata=e,this.tokenizer=a}async parsePage(e,t){e.headerType.firstPage&&await this.parseFirstPage(e,t)}async flush(){Ii("flush")}calculateDuration(e){Ii("duration calculation not implemented")}async parseFirstPage(e,t){Ii("First Ogg/Theora page"),this.metadata.setFormat("codec","Theora");const a=(i=t,n=0,{id:new j(7,"ascii").get(i,n),vmaj:p.get(i,n+7),vmin:p.get(i,n+8),vrev:p.get(i,n+9),vmbw:g.get(i,n+10),vmbh:g.get(i,n+17),nombr:b.get(i,n+37),nqual:p.get(i,n+40)});var i,n;this.metadata.setFormat("bitrate",a.nombr)}}const xi=ke("music-metadata:parser:ogg");class Ai{static sum(e,t,a){const i=new DataView(e.buffer,0);let n=0;for(let e=t;e<t+a;++e)n+=i.getUint8(e);return n}constructor(e){this.len=e.page_segments}get(e,t){return{totalPageSize:Ai.sum(e,t,this.len)}}}class zi extends it{constructor(){super(...arguments),this.header=null,this.pageNumber=0,this.pageConsumer=null}async parse(){xi("pos=%s, parsePage()",this.tokenizer.position);try{let e;do{if(e=await this.tokenizer.readToken(zi.Header),"OggS"!==e.capturePattern)throw new Error("Invalid Ogg capture pattern");this.metadata.setFormat("container","Ogg"),this.header=e,this.pageNumber=e.pageSequenceNo,xi("page#=%s, Ogg.id=%s",e.pageSequenceNo,e.capturePattern);const t=await this.tokenizer.readToken(new Ai(e));xi("totalPageSize=%s",t.totalPageSize);const a=await this.tokenizer.readToken(new $(t.totalPageSize));if(xi("firstPage=%s, lastPage=%s, continued=%s",e.headerType.firstPage,e.headerType.lastPage,e.headerType.continued),e.headerType.firstPage){const e=new TextDecoder("ascii").decode(a.subarray(0,7));switch(e){case"vorbis":xi("Set page consumer to Ogg/Vorbis"),this.pageConsumer=new da(this.metadata,this.options);break;case"OpusHea":xi("Set page consumer to Ogg/Opus"),this.pageConsumer=new yi(this.metadata,this.options,this.tokenizer);break;case"Speex  ":xi("Set page consumer to Ogg/Speex"),this.pageConsumer=new Si(this.metadata,this.options,this.tokenizer);break;case"fishead":case"\0theora":xi("Set page consumer to Ogg/Theora"),this.pageConsumer=new Ci(this.metadata,this.options,this.tokenizer);break;default:throw new Error(`gg audio-codec not recognized (id=${e})`)}}await this.pageConsumer.parsePage(e,a)}while(!e.headerType.lastPage)}catch(e){if(!(e instanceof Error))throw e;e instanceof n?(this.metadata.addWarning("Last OGG-page is not marked with last-page flag"),xi("End-of-stream"),this.metadata.addWarning("Last OGG-page is not marked with last-page flag"),this.header&&this.pageConsumer.calculateDuration(this.header)):e.message.startsWith("FourCC")&&this.pageNumber>0&&(this.metadata.addWarning("Invalid FourCC ID, maybe last OGG-page is not marked with last-page flag"),await this.pageConsumer.flush())}}}zi.Header={len:27,get:(e,t)=>({capturePattern:rt.get(e,t),version:p.get(e,t+4),headerType:{continued:be(e,t+5,0),firstPage:be(e,t+5,1),lastPage:be(e,t+5,2)},absoluteGranulePosition:Number(z.get(e,t+6)),streamSerialNumber:w.get(e,t+14),pageSequenceNo:w.get(e,t+18),pageChecksum:w.get(e,t+22),page_segments:p.get(e,t+26)})};const Ei={len:8,get:(e,t)=>({chunkID:new j(4,"latin1").get(e,t),chunkSize:w.get(e,t+4)})};class Fi{constructor(e){this.tagHeader=e,this.len=e.chunkSize,this.len+=1&this.len}get(e,t){return new j(this.tagHeader.chunkSize,"ascii").get(e,t)}}var Di;!function(e){e[e.PCM=1]="PCM",e[e.ADPCM=2]="ADPCM",e[e.IEEE_FLOAT=3]="IEEE_FLOAT",e[e.MPEG_ADTS_AAC=5632]="MPEG_ADTS_AAC",e[e.MPEG_LOAS=5634]="MPEG_LOAS",e[e.RAW_AAC1=255]="RAW_AAC1",e[e.DOLBY_AC3_SPDIF=146]="DOLBY_AC3_SPDIF",e[e.DVM=8192]="DVM",e[e.RAW_SPORT=576]="RAW_SPORT",e[e.ESST_AC3=577]="ESST_AC3",e[e.DRM=9]="DRM",e[e.DTS2=8193]="DTS2",e[e.MPEG=80]="MPEG"}(Di||(Di={}));class Mi{constructor(e){if(e.chunkSize<16)throw new Error("Invalid chunk size");this.len=e.chunkSize}get(e,t){return{wFormatTag:f.get(e,t),nChannels:f.get(e,t+2),nSamplesPerSec:w.get(e,t+4),nAvgBytesPerSec:w.get(e,t+8),nBlockAlign:f.get(e,t+12),wBitsPerSample:f.get(e,t+14)}}}class Pi{constructor(e){if(e.chunkSize<4)throw new Error("Invalid fact chunk size.");this.len=e.chunkSize}get(e,t){return{dwSampleLength:w.get(e,t)}}}const _i={len:420,get:(e,t)=>({description:ve(new j(256,"ascii").get(e,t)).trim(),originator:ve(new j(32,"ascii").get(e,t+256)).trim(),originatorReference:ve(new j(32,"ascii").get(e,t+288)).trim(),originationDate:ve(new j(10,"ascii").get(e,t+320)).trim(),originationTime:ve(new j(8,"ascii").get(e,t+330)).trim(),timeReferenceLow:w.get(e,t+338),timeReferenceHigh:w.get(e,t+342),version:f.get(e,t+346),umid:new $(64).get(e,t+348),loudnessValue:f.get(e,t+412),maxTruePeakLevel:f.get(e,t+414),maxMomentaryLoudness:f.get(e,t+416),maxShortTermLoudness:f.get(e,t+418)})},Ri=ke("music-metadata:parser:RIFF");class Bi extends it{constructor(){super(...arguments),this.blockAlign=0}async parse(){const e=await this.tokenizer.readToken(Ei);if(Ri(`pos=${this.tokenizer.position}, parse: chunkID=${e.chunkID}`),"RIFF"===e.chunkID)return this.parseRiffChunk(e.chunkSize).catch((e=>{if(!(e instanceof n))throw e}))}async parseRiffChunk(e){const t=await this.tokenizer.readToken(rt);if(this.metadata.setFormat("container",t),"WAVE"===t)return this.readWaveChunk(e-rt.len);throw new Error(`Unsupported RIFF format: RIFF/${t}`)}async readWaveChunk(e){for(;e>=Ei.len;){const t=await this.tokenizer.readToken(Ei);switch(e-=Ei.len+t.chunkSize,t.chunkSize>e&&this.metadata.addWarning("Data chunk size exceeds file size"),this.header=t,Ri(`pos=${this.tokenizer.position}, readChunk: chunkID=RIFF/WAVE/${t.chunkID}`),t.chunkID){case"LIST":await this.parseListTag(t);break;case"fact":this.metadata.setFormat("lossless",!1),this.fact=await this.tokenizer.readToken(new Pi(t));break;case"fmt ":{const e=await this.tokenizer.readToken(new Mi(t));let a=Di[e.wFormatTag];a||(Ri(`WAVE/non-PCM format=${e.wFormatTag}`),a=`non-PCM (${e.wFormatTag})`),this.metadata.setFormat("codec",a),this.metadata.setFormat("bitsPerSample",e.wBitsPerSample),this.metadata.setFormat("sampleRate",e.nSamplesPerSec),this.metadata.setFormat("numberOfChannels",e.nChannels),this.metadata.setFormat("bitrate",e.nBlockAlign*e.nSamplesPerSec*8),this.blockAlign=e.nBlockAlign;break}case"id3 ":case"ID3 ":{const e=u(await this.tokenizer.readToken(new $(t.chunkSize)));await(new At).parse(this.metadata,e,this.options);break}case"data":{!1!==this.metadata.format.lossless&&this.metadata.setFormat("lossless",!0);let e=t.chunkSize;if(this.tokenizer.fileInfo.size){const t=this.tokenizer.fileInfo.size-this.tokenizer.position;t<e&&(this.metadata.addWarning("data chunk length exceeding file length"),e=t)}const a=this.fact?this.fact.dwSampleLength:4294967295===e?void 0:e/this.blockAlign;a&&(this.metadata.setFormat("numberOfSamples",a),this.metadata.format.sampleRate&&this.metadata.setFormat("duration",a/this.metadata.format.sampleRate)),"ADPCM"===this.metadata.format.codec?this.metadata.setFormat("bitrate",352e3):this.metadata.format.sampleRate&&this.metadata.setFormat("bitrate",this.blockAlign*this.metadata.format.sampleRate*8),await this.tokenizer.ignore(t.chunkSize);break}case"bext":{const e=await this.tokenizer.readToken(_i);Object.keys(e).forEach((t=>{this.metadata.addTag("exif",`bext.${t}`,e[t])}));const a=t.chunkSize-_i.len;await this.tokenizer.ignore(a);break}case"\0\0\0\0":Ri(`Ignore padding chunk: RIFF/${t.chunkID} of ${t.chunkSize} bytes`),this.metadata.addWarning(`Ignore chunk: RIFF/${t.chunkID}`),await this.tokenizer.ignore(t.chunkSize);break;default:Ri(`Ignore chunk: RIFF/${t.chunkID} of ${t.chunkSize} bytes`),this.metadata.addWarning(`Ignore chunk: RIFF/${t.chunkID}`),await this.tokenizer.ignore(t.chunkSize)}this.header.chunkSize%2==1&&(Ri("Read odd padding byte"),await this.tokenizer.ignore(1))}}async parseListTag(e){const t=await this.tokenizer.readToken(new j(4,"latin1"));return Ri("pos=%s, parseListTag: chunkID=RIFF/WAVE/LIST/%s",this.tokenizer.position,t),"INFO"===t?this.parseRiffInfoTags(e.chunkSize-4):(this.metadata.addWarning(`Ignore chunk: RIFF/WAVE/LIST/${t}`),Ri(`Ignoring chunkID=RIFF/WAVE/LIST/${t}`),this.tokenizer.ignore(e.chunkSize-4).then())}async parseRiffInfoTags(e){for(;e>=8;){const t=await this.tokenizer.readToken(Ei),a=new Fi(t),i=await this.tokenizer.readToken(a);this.addTag(t.chunkID,ve(i)),e-=8+a.len}if(0!==e)throw new Error(`Illegal remaining size: ${e}`)}addTag(e,t){this.metadata.addTag("exif",e,t)}}const Oi=[6e3,8e3,9600,11025,12e3,16e3,22050,24e3,32e3,44100,48e3,64e3,88200,96e3,192e3,-1],Li={len:32,get:(e,t)=>{const a=w.get(e,t+24),i={BlockID:rt.get(e,t),blockSize:w.get(e,t+4),version:f.get(e,t+8),totalSamples:w.get(e,t+12),blockIndex:w.get(e,t+16),blockSamples:w.get(e,t+20),flags:{bitsPerSample:8*(1+$i(a,0,2)),isMono:Ui(a,2),isHybrid:Ui(a,3),isJointStereo:Ui(a,4),crossChannel:Ui(a,5),hybridNoiseShaping:Ui(a,6),floatingPoint:Ui(a,7),samplingRate:Oi[$i(a,23,4)],isDSD:Ui(a,31)},crc:new $(4).get(e,t+28)};return i.flags.isDSD&&(i.totalSamples*=8),i}},Ni={len:1,get:(e,t)=>({functionId:$i(e[t],0,6),isOptional:Ui(e[t],5),isOddSize:Ui(e[t],6),largeBlock:Ui(e[t],7)})};function Ui(e,t){return 1===$i(e,t,1)}function $i(e,t,a){return e>>>t&4294967295>>>32-a}const ji=ke("music-metadata:parser:WavPack");class Gi extends it{constructor(){super(...arguments),this.audioDataSize=0}async parse(){return this.audioDataSize=0,await this.parseWavPackBlocks(),gt.tryParseApeHeader(this.metadata,this.tokenizer,this.options)}async parseWavPackBlocks(){do{if("wvpk"!==await this.tokenizer.peekToken(rt))break;const e=await this.tokenizer.readToken(Li);if("wvpk"!==e.BlockID)throw new Error("Invalid WavPack Block-ID");ji(`WavPack header blockIndex=${e.blockIndex}, len=${Li.len}`),0!==e.blockIndex||this.metadata.format.container||(this.metadata.setFormat("container","WavPack"),this.metadata.setFormat("lossless",!e.flags.isHybrid),this.metadata.setFormat("bitsPerSample",e.flags.bitsPerSample),e.flags.isDSD||(this.metadata.setFormat("sampleRate",e.flags.samplingRate),this.metadata.setFormat("duration",e.totalSamples/e.flags.samplingRate)),this.metadata.setFormat("numberOfChannels",e.flags.isMono?1:2),this.metadata.setFormat("numberOfSamples",e.totalSamples),this.metadata.setFormat("codec",e.flags.isDSD?"DSD":"PCM"));const t=e.blockSize-(Li.len-8);await(0===e.blockIndex?this.parseMetadataSubBlock(e,t):this.tokenizer.ignore(t)),e.blockSamples>0&&(this.audioDataSize+=e.blockSize)}while(!this.tokenizer.fileInfo.size||this.tokenizer.fileInfo.size-this.tokenizer.position>=Li.len);this.metadata.format.duration&&this.metadata.setFormat("bitrate",8*this.audioDataSize/this.metadata.format.duration)}async parseMetadataSubBlock(e,t){let a=t;for(;a>Ni.len;){const t=await this.tokenizer.readToken(Ni),i=await this.tokenizer.readNumber(t.largeBlock?k:p),n=new Uint8Array(2*i-(t.isOddSize?1:0));switch(await this.tokenizer.readBuffer(n),ji(`Metadata Sub-Blocks functionId=0x${t.functionId.toString(16)}, id.largeBlock=${t.largeBlock},data-size=${n.length}`),t.functionId){case 0:break;case 14:{ji("ID_DSD_BLOCK");const t=1<<p.get(n,0),a=e.flags.samplingRate*t*8;if(!e.flags.isDSD)throw new Error("Only expect DSD block if DSD-flag is set");this.metadata.setFormat("sampleRate",a),this.metadata.setFormat("duration",e.totalSamples/a);break}case 36:ji("ID_ALT_TRAILER: trailer for non-wav files");break;case 38:this.metadata.setFormat("audioMD5",n);break;case 47:ji(`ID_BLOCK_CHECKSUM: checksum=${ee(n)}`);break;default:ji(`Ignore unsupported meta-sub-block-id functionId=0x${t.functionId.toString(16)}`)}a-=Ni.len+(t.largeBlock?k.len:p.len)+2*i,ji(`remainingLength=${a}`),t.isOddSize&&this.tokenizer.ignore(1)}if(0!==a)throw new Error("metadata-sub-block should fit it remaining length")}}const Xi={len:12,get:(e,t)=>({id:rt.get(e,t),size:z.get(e,t+4)})},Wi={len:16,get:(e,t)=>({fileSize:E.get(e,t),metadataPointer:E.get(e,t+8)})};var Hi;!function(e){e[e.mono=1]="mono",e[e.stereo=2]="stereo",e[e.channels=3]="channels",e[e.quad=4]="quad",e[e["4 channels"]=5]="4 channels",e[e["5 channels"]=6]="5 channels",e[e["5.1 channels"]=7]="5.1 channels"}(Hi||(Hi={}));const Vi={len:40,get:(e,t)=>({formatVersion:A.get(e,t),formatID:A.get(e,t+4),channelType:A.get(e,t+8),channelNum:A.get(e,t+12),samplingFrequency:A.get(e,t+16),bitsPerSample:A.get(e,t+20),sampleCount:E.get(e,t+24),blockSizePerChannel:A.get(e,t+32)})},qi=ke("music-metadata:parser:DSF");class Ki extends la{async postId3v2Parse(){const e=this.tokenizer.position,t=await this.tokenizer.readToken(Xi);if("DSD "!==t.id)throw new Error("Invalid chunk signature");this.metadata.setFormat("container","DSF"),this.metadata.setFormat("lossless",!0);const a=await this.tokenizer.readToken(Wi);if(a.metadataPointer!==BigInt(0))return qi(`expect ID3v2 at offset=${a.metadataPointer}`),await this.parseChunks(a.fileSize-t.size),await this.tokenizer.ignore(Number(a.metadataPointer)-this.tokenizer.position-e),(new At).parse(this.metadata,this.tokenizer,this.options);qi("No ID3v2 tag present")}async parseChunks(e){for(;e>=Xi.len;){const t=await this.tokenizer.readToken(Xi);if(qi(`Parsing chunk name=${t.id} size=${t.size}`),"fmt "===t.id){const e=await this.tokenizer.readToken(Vi);this.metadata.setFormat("numberOfChannels",e.channelNum),this.metadata.setFormat("sampleRate",e.samplingFrequency),this.metadata.setFormat("bitsPerSample",e.bitsPerSample),this.metadata.setFormat("numberOfSamples",e.sampleCount),this.metadata.setFormat("duration",Number(e.sampleCount)/e.samplingFrequency);const t=e.bitsPerSample*e.samplingFrequency*e.channelNum;return void this.metadata.setFormat("bitrate",t)}this.tokenizer.ignore(Number(t.size)-Xi.len),e-=t.size}}}const Yi={len:12,get:(e,t)=>({chunkID:rt.get(e,t),chunkSize:D.get(e,t+4)})},Zi=ke("music-metadata:parser:aiff");class Ji extends it{async parse(){const e=await this.tokenizer.readToken(Yi);if("FRM8"!==e.chunkID)throw new Error("Unexpected chunk-ID");const t=(await this.tokenizer.readToken(rt)).trim();if("DSD"===t)return this.metadata.setFormat("container",`DSDIFF/${t}`),this.metadata.setFormat("lossless",!0),this.readFmt8Chunks(e.chunkSize-BigInt(rt.len));throw new Error(`Unsupported DSDIFF type: ${t}`)}async readFmt8Chunks(e){for(;e>=Yi.len;){const t=await this.tokenizer.readToken(Yi);Zi(`Chunk id=${t.chunkID}`),await this.readData(t),e-=BigInt(Yi.len)+t.chunkSize}}async readData(e){Zi(`Reading data of chunk[ID=${e.chunkID}, size=${e.chunkSize}]`);const t=this.tokenizer.position;switch(e.chunkID.trim()){case"FVER":{const e=await this.tokenizer.readToken(w);Zi(`DSDIFF version=${e}`);break}case"PROP":if("SND "!==await this.tokenizer.readToken(rt))throw new Error("Unexpected PROP-chunk ID");await this.handleSoundPropertyChunks(e.chunkSize-BigInt(rt.len));break;case"ID3":{const t=u(await this.tokenizer.readToken(new $(Number(e.chunkSize))));await(new At).parse(this.metadata,t,this.options);break}case"DSD":this.metadata.format.numberOfChannels&&this.metadata.setFormat("numberOfSamples",Number(e.chunkSize*BigInt(8)/BigInt(this.metadata.format.numberOfChannels))),this.metadata.format.numberOfSamples&&this.metadata.format.sampleRate&&this.metadata.setFormat("duration",this.metadata.format.numberOfSamples/this.metadata.format.sampleRate);break;default:Zi(`Ignore chunk[ID=${e.chunkID}, size=${e.chunkSize}]`)}const a=e.chunkSize-BigInt(this.tokenizer.position-t);a>0&&(Zi(`After Parsing chunk, remaining ${a} bytes`),await this.tokenizer.ignore(Number(a)))}async handleSoundPropertyChunks(e){for(Zi(`Parsing sound-property-chunks, remainingSize=${e}`);e>0;){const t=await this.tokenizer.readToken(Yi);Zi(`Sound-property-chunk[ID=${t.chunkID}, size=${t.chunkSize}]`);const a=this.tokenizer.position;switch(t.chunkID.trim()){case"FS":{const e=await this.tokenizer.readToken(T);this.metadata.setFormat("sampleRate",e);break}case"CHNL":{const e=await this.tokenizer.readToken(g);this.metadata.setFormat("numberOfChannels",e),await this.handleChannelChunks(t.chunkSize-BigInt(g.len));break}case"CMPR":{const e=(await this.tokenizer.readToken(rt)).trim(),t=await this.tokenizer.readToken(p),a=await this.tokenizer.readToken(new j(t,"ascii"));"DSD"===e&&(this.metadata.setFormat("lossless",!0),this.metadata.setFormat("bitsPerSample",1)),this.metadata.setFormat("codec",`${e} (${a})`);break}case"ABSS":{const e=await this.tokenizer.readToken(g),t=await this.tokenizer.readToken(p),a=await this.tokenizer.readToken(p),i=await this.tokenizer.readToken(T);Zi(`ABSS ${e}:${t}:${a}.${i}`);break}case"LSCO":{const e=await this.tokenizer.readToken(g);Zi(`LSCO lsConfig=${e}`);break}default:Zi(`Unknown sound-property-chunk[ID=${t.chunkID}, size=${t.chunkSize}]`),await this.tokenizer.ignore(Number(t.chunkSize))}const i=t.chunkSize-BigInt(this.tokenizer.position-a);i>0&&(Zi(`After Parsing sound-property-chunk ${t.chunkSize}, remaining ${i} bytes`),await this.tokenizer.ignore(Number(i))),e-=BigInt(Yi.len)+t.chunkSize,Zi(`Parsing sound-property-chunks, remainingSize=${e}`)}if(this.metadata.format.lossless&&this.metadata.format.sampleRate&&this.metadata.format.numberOfChannels&&this.metadata.format.bitsPerSample){const e=this.metadata.format.sampleRate*this.metadata.format.numberOfChannels*this.metadata.format.bitsPerSample;this.metadata.setFormat("bitrate",e)}}async handleChannelChunks(e){Zi(`Parsing channel-chunks, remainingSize=${e}`);const t=[];for(;e>=rt.len;){const a=await this.tokenizer.readToken(rt);Zi(`Channel[ID=${a}]`),t.push(a),e-=BigInt(rt.len)}return Zi(`Channels: ${t.join(", ")}`),t}}var Qi;!function(e){e[e.string=0]="string",e[e.uint=1]="uint",e[e.uid=2]="uid",e[e.bool=3]="bool",e[e.binary=4]="binary",e[e.float=5]="float"}(Qi||(Qi={}));const en={name:"dtd",container:{440786851:{name:"ebml",container:{17030:{name:"ebmlVersion",value:Qi.uint},17143:{name:"ebmlReadVersion",value:Qi.uint},17138:{name:"ebmlMaxIDWidth",value:Qi.uint},17139:{name:"ebmlMaxSizeWidth",value:Qi.uint},17026:{name:"docType",value:Qi.string},17031:{name:"docTypeVersion",value:Qi.uint},17029:{name:"docTypeReadVersion",value:Qi.uint}}},408125543:{name:"segment",container:{290298740:{name:"seekHead",container:{19899:{name:"seek",multiple:!0,container:{21419:{name:"id",value:Qi.binary},21420:{name:"position",value:Qi.uint}}}}},357149030:{name:"info",container:{29604:{name:"uid",value:Qi.uid},29572:{name:"filename",value:Qi.string},3979555:{name:"prevUID",value:Qi.uid},3965867:{name:"prevFilename",value:Qi.string},4110627:{name:"nextUID",value:Qi.uid},4096955:{name:"nextFilename",value:Qi.string},2807729:{name:"timecodeScale",value:Qi.uint},17545:{name:"duration",value:Qi.float},17505:{name:"dateUTC",value:Qi.uint},31657:{name:"title",value:Qi.string},19840:{name:"muxingApp",value:Qi.string},22337:{name:"writingApp",value:Qi.string}}},524531317:{name:"cluster",multiple:!0,container:{231:{name:"timecode",value:Qi.uid},22743:{name:"silentTracks ",multiple:!0},167:{name:"position",value:Qi.uid},171:{name:"prevSize",value:Qi.uid},160:{name:"blockGroup"},163:{name:"simpleBlock"}}},374648427:{name:"tracks",container:{174:{name:"entries",multiple:!0,container:{215:{name:"trackNumber",value:Qi.uint},29637:{name:"uid",value:Qi.uid},131:{name:"trackType",value:Qi.uint},185:{name:"flagEnabled",value:Qi.bool},136:{name:"flagDefault",value:Qi.bool},21930:{name:"flagForced",value:Qi.bool},156:{name:"flagLacing",value:Qi.bool},28135:{name:"minCache",value:Qi.uint},28136:{name:"maxCache",value:Qi.uint},2352003:{name:"defaultDuration",value:Qi.uint},2306383:{name:"timecodeScale",value:Qi.float},21358:{name:"name",value:Qi.string},2274716:{name:"language",value:Qi.string},134:{name:"codecID",value:Qi.string},25506:{name:"codecPrivate",value:Qi.binary},2459272:{name:"codecName",value:Qi.string},3839639:{name:"codecSettings",value:Qi.string},3883072:{name:"codecInfoUrl",value:Qi.string},2536e3:{name:"codecDownloadUrl",value:Qi.string},170:{name:"codecDecodeAll",value:Qi.bool},28587:{name:"trackOverlay",value:Qi.uint},224:{name:"video",container:{154:{name:"flagInterlaced",value:Qi.bool},21432:{name:"stereoMode",value:Qi.uint},176:{name:"pixelWidth",value:Qi.uint},186:{name:"pixelHeight",value:Qi.uint},21680:{name:"displayWidth",value:Qi.uint},21690:{name:"displayHeight",value:Qi.uint},21683:{name:"aspectRatioType",value:Qi.uint},3061028:{name:"colourSpace",value:Qi.uint},3126563:{name:"gammaValue",value:Qi.float}}},225:{name:"audio",container:{181:{name:"samplingFrequency",value:Qi.float},30901:{name:"outputSamplingFrequency",value:Qi.float},159:{name:"channels",value:Qi.uint},148:{name:"channels",value:Qi.uint},32123:{name:"channelPositions",value:Qi.binary},25188:{name:"bitDepth",value:Qi.uint}}},28032:{name:"contentEncodings",container:{25152:{name:"contentEncoding",container:{20529:{name:"order",value:Qi.uint},20530:{name:"scope",value:Qi.bool},20531:{name:"type",value:Qi.uint},20532:{name:"contentEncoding",container:{16980:{name:"contentCompAlgo",value:Qi.uint},16981:{name:"contentCompSettings",value:Qi.binary}}},20533:{name:"contentEncoding",container:{18401:{name:"contentEncAlgo",value:Qi.uint},18402:{name:"contentEncKeyID",value:Qi.binary},18403:{name:"contentSignature ",value:Qi.binary},18404:{name:"ContentSigKeyID  ",value:Qi.binary},18405:{name:"contentSigAlgo ",value:Qi.uint},18406:{name:"contentSigHashAlgo ",value:Qi.uint}}},25188:{name:"bitDepth",value:Qi.uint}}}}}}}}},475249515:{name:"cues",container:{187:{name:"cuePoint",container:{179:{name:"cueTime",value:Qi.uid},183:{name:"positions",container:{247:{name:"track",value:Qi.uint},241:{name:"clusterPosition",value:Qi.uint},21368:{name:"blockNumber",value:Qi.uint},234:{name:"codecState",value:Qi.uint},219:{name:"reference",container:{150:{name:"time",value:Qi.uint},151:{name:"cluster",value:Qi.uint},21343:{name:"number",value:Qi.uint},235:{name:"codecState",value:Qi.uint}}},240:{name:"relativePosition",value:Qi.uint}}}}}}},423732329:{name:"attachments",container:{24999:{name:"attachedFiles",multiple:!0,container:{18046:{name:"description",value:Qi.string},18030:{name:"name",value:Qi.string},18016:{name:"mimeType",value:Qi.string},18012:{name:"data",value:Qi.binary},18094:{name:"uid",value:Qi.uid}}}}},272869232:{name:"chapters",container:{17849:{name:"editionEntry",container:{182:{name:"chapterAtom",container:{29636:{name:"uid",value:Qi.uid},145:{name:"timeStart",value:Qi.uint},146:{name:"timeEnd",value:Qi.uid},152:{name:"hidden",value:Qi.bool},17816:{name:"enabled",value:Qi.uid},143:{name:"track",container:{137:{name:"trackNumber",value:Qi.uid},128:{name:"display",container:{133:{name:"string",value:Qi.string},17276:{name:"language ",value:Qi.string},17278:{name:"country ",value:Qi.string}}}}}}}}}}},307544935:{name:"tags",container:{29555:{name:"tag",multiple:!0,container:{25536:{name:"target",container:{25541:{name:"tagTrackUID",value:Qi.uid},25540:{name:"tagChapterUID",value:Qi.uint},25542:{name:"tagAttachmentUID",value:Qi.uid},25546:{name:"targetType",value:Qi.string},26826:{name:"targetTypeValue",value:Qi.uint},25545:{name:"tagEditionUID",value:Qi.uid}}},26568:{name:"simpleTags",multiple:!0,container:{17827:{name:"name",value:Qi.string},17543:{name:"string",value:Qi.string},17541:{name:"binary",value:Qi.binary},17530:{name:"language",value:Qi.string},17531:{name:"languageIETF",value:Qi.string},17540:{name:"default",value:Qi.bool}}}}}}}}}}},tn=ke("music-metadata:parser:ebml");var an;!function(e){e[e.ReadNext=0]="ReadNext",e[e.IgnoreElement=2]="IgnoreElement",e[e.SkipSiblings=3]="SkipSiblings",e[e.TerminateParsing=4]="TerminateParsing",e[e.SkipElement=5]="SkipElement"}(an||(an={}));class nn{constructor(e){this.tokenizer=e,this.padding=0,this.parserMap=new Map,this.ebmlMaxIDLength=4,this.ebmlMaxSizeLength=8,this.parserMap.set(Qi.uint,(e=>this.readUint(e))),this.parserMap.set(Qi.string,(e=>this.readString(e))),this.parserMap.set(Qi.binary,(e=>this.readBuffer(e))),this.parserMap.set(Qi.uid,(async e=>this.readBuffer(e))),this.parserMap.set(Qi.bool,(e=>this.readFlag(e))),this.parserMap.set(Qi.float,(e=>this.readFloat(e)))}async iterate(e,t,a){return this.parseContainer(sn(e),t,a)}async parseContainer(e,t,a){const i={};for(;this.tokenizer.position<t;){let r;const s=this.tokenizer.position;try{r=await this.readElement()}catch(e){if(e instanceof n)break;throw e}const o=e.container[r.id];if(o)switch(a.startNext(o)){case an.ReadNext:if(r.id,tn(`Read element: name=${on(o)}{id=0x${r.id.toString(16)}, container=${!!o.container}} at position=${s}`),o.container){const e=await this.parseContainer(o,r.len>=0?this.tokenizer.position+r.len:-1,a);o.multiple?(i[o.name]||(i[o.name]=[]),i[o.name].push(e)):i[o.name]=e,await a.elementValue(o,e,s)}else{const e=this.parserMap.get(o.value);if("function"==typeof e){const t=await e(r);i[o.name]=t,await a.elementValue(o,t,s)}}break;case an.SkipElement:tn(`Go to next element: name=${on(o)}, element.id=0x${r.id}, container=${!!o.container} at position=${s}`);break;case an.IgnoreElement:tn(`Ignore element: name=${on(o)}, element.id=0x${r.id}, container=${!!o.container} at position=${s}`),await this.tokenizer.ignore(r.len);break;case an.SkipSiblings:tn(`Ignore remaining container, at: name=${on(o)}, element.id=0x${r.id}, container=${!!o.container} at position=${s}`),await this.tokenizer.ignore(t-this.tokenizer.position);break;case an.TerminateParsing:return tn(`Terminate parsing at element: name=${on(o)}, element.id=0x${r.id}, container=${!!o.container} at position=${s}`),i}else 236===r.id?(this.padding+=r.len,await this.tokenizer.ignore(r.len)):(tn(`parseEbml: parent=${on(e)}, unknown child: id=${r.id.toString(16)} at position=${s}`),this.padding+=r.len,await this.tokenizer.ignore(r.len))}return i}async readVintData(e){const t=await this.tokenizer.peekNumber(p);let a=128,i=1;for(;!(t&a);){if(i>e)throw new Error("VINT value exceeding maximum size");++i,a>>=1}const n=new Uint8Array(i);return await this.tokenizer.readBuffer(n),n}async readElement(){const e=await this.readVintData(this.ebmlMaxIDLength),t=await this.readVintData(this.ebmlMaxSizeLength);return t[0]^=128>>t.length-1,{id:rn(e,e.length),len:rn(t,t.length)}}async readFloat(e){switch(e.len){case 0:return 0;case 4:return this.tokenizer.readNumber(_);case 8:case 10:return this.tokenizer.readNumber(B);default:throw new Error(`Invalid IEEE-754 float length: ${e.len}`)}}async readFlag(e){return 1===await this.readUint(e)}async readUint(e){return rn(await this.readBuffer(e),e.len)}async readString(e){return(await this.tokenizer.readToken(new j(e.len,"utf-8"))).replace(/\x00.*$/g,"")}async readBuffer(e){const t=new Uint8Array(e.len);return await this.tokenizer.readBuffer(t),t}}function rn(e,t){return Number(function(e,t){const a=new Uint8Array(8),i=e.subarray(0,t);try{return a.set(i,8-t),F.get(a,0)}catch(e){return BigInt(-1)}}(e,t))}function sn(e){return e.container&&Object.keys(e.container).map((t=>{const a=e.container[t];return a.id=Number.parseInt(t),a})).forEach((t=>{t.parent=e,sn(t)})),e}function on(e){let t="";return e.parent&&"dtd"!==e.parent.name&&(t+=`${on(e.parent)}/`),t+e.name}const cn=ke("music-metadata:parser:matroska");class ln extends it{constructor(){super(...arguments),this.seekHeadOffset=0,this.flagUseIndexToSkipClusters=!1}init(e,t,a){return super.init(e,t,a),this.flagUseIndexToSkipClusters=a.mkvUseIndex??!1,this}async parse(){const e=this.tokenizer.fileInfo.size??Number.MAX_SAFE_INTEGER,t=new nn(this.tokenizer);cn("Initializing DTD end MatroskaIterator"),await t.iterate(en,e,{startNext:e=>{switch(e.id){case 475249515:return cn(`Skip element: name=${e.name}, id=0x${e.id.toString(16)}`),an.IgnoreElement;case 524531317:if(this.flagUseIndexToSkipClusters&&this.seekHead){const e=this.seekHead.seek.find((e=>e.position+this.seekHeadOffset>this.tokenizer.position));if(e){const t=e.position+this.seekHeadOffset-this.tokenizer.position;return cn(`Use index to go to next position, ignoring ${t} bytes`),this.tokenizer.ignore(t),an.SkipElement}}return an.IgnoreElement;default:return an.ReadNext}},elementValue:async(e,t,a)=>{switch(cn(`Received: name=${e.name}, value=${t}`),e.id){case 17026:this.metadata.setFormat("container",`EBML/${t}`);break;case 290298740:this.seekHead=t,this.seekHeadOffset=a;break;case 357149030:{const e=t,a=e.timecodeScale?e.timecodeScale:1e6;if("number"==typeof e.duration){const t=e.duration*a/1e9;await this.addTag("segment:title",e.title),this.metadata.setFormat("duration",Number(t))}}break;case 374648427:{const e=t;if(e?.entries){e.entries.forEach((e=>{const t={codecName:e.codecID.replace("A_","").replace("V_",""),codecSettings:e.codecSettings,flagDefault:e.flagDefault,flagLacing:e.flagLacing,flagEnabled:e.flagEnabled,language:e.language,name:e.name,type:e.trackType,audio:e.audio,video:e.video};this.metadata.addStreamInfo(t)}));const t=e.entries.filter((e=>e.trackType===ue.audio)).reduce(((e,t)=>e?t.flagDefault&&!e.flagDefault||t.trackNumber<e.trackNumber?t:e:t),null);t&&(this.metadata.setFormat("codec",t.codecID.replace("A_","")),this.metadata.setFormat("sampleRate",t.audio.samplingFrequency),this.metadata.setFormat("numberOfChannels",t.audio.channels))}}break;case 307544935:{const e=t;await Promise.all(e.tag.map((async e=>{const t=e.target,a=t?.targetTypeValue?me[t.targetTypeValue]:t?.targetType?t.targetType:"track";await Promise.all(e.simpleTags.map((async e=>{const t=e.string?e.string:e.binary;await this.addTag(`${a}:${e.name}`,t)})))})))}break;case 423732329:{const e=t;await Promise.all(e.attachedFiles.filter((e=>e.mimeType.startsWith("image/"))).map((e=>this.addTag("picture",{data:e.data,format:e.mimeType,description:e.description,name:e.name}))))}}}})}async addTag(e,t){await this.metadata.addTag("matroska",e,t)}}const mn=ke("music-metadata:parser:factory");function un(e){if(e)switch(function(e){const t=e.lastIndexOf(".");return-1===t?"":e.slice(t)}(e).toLocaleLowerCase()||e){case".mp2":case".mp3":case".m2a":case".aac":return"mpeg";case".ape":return"apev2";case".mp4":case".m4a":case".m4b":case".m4pa":case".m4v":case".m4r":case".3gp":return"mp4";case".wma":case".wmv":case".asf":return"asf";case".flac":return"flac";case".ogg":case".ogv":case".oga":case".ogm":case".ogx":case".opus":case".spx":return"ogg";case".aif":case".aiff":case".aifc":return"aiff";case".wav":case".bwf":return"riff";case".wv":case".wvp":return"wavpack";case".mpc":return"musepack";case".dsf":return"dsf";case".dff":return"dsdiff";case".mka":case".mkv":case".mk3d":case".mks":case".webm":return"matroska"}}function dn(e){let t;if(!e)return;try{t=function(e){const t=fe.parse(e),a=(0,ge.qg)(t.type);return{type:a.type,subtype:a.subtype,suffix:a.suffix,parameters:t.parameters}}(e)}catch(t){return void mn(`Invalid HTTP Content-Type header value: ${e}`)}const a=0===t.subtype.indexOf("x-")?t.subtype.substring(2):t.subtype;switch(t.type){case"audio":switch(a){case"mp3":case"mpeg":return"mpeg";case"aac":case"aacp":return"adts";case"flac":return"flac";case"ape":case"monkeys-audio":return"apev2";case"mp4":case"m4a":return"mp4";case"ogg":case"opus":case"speex":return"ogg";case"ms-wma":case"ms-wmv":case"ms-asf":return"asf";case"aiff":case"aif":case"aifc":return"aiff";case"vnd.wave":case"wav":case"wave":return"riff";case"wavpack":return"wavpack";case"musepack":return"musepack";case"matroska":case"webm":return"matroska";case"dsf":return"dsf"}break;case"video":switch(a){case"ms-asf":case"ms-wmv":return"asf";case"m4v":case"mp4":return"mp4";case"ogg":return"ogg";case"matroska":case"webm":return"matroska"}break;case"application":switch(a){case"vnd.ms-asf":return"asf";case"ogg":return"ogg"}}}class hn{constructor(e){this.uint8Array=e,this.fileSize=e.length}async randomRead(e,t,a,i){return e.set(this.uint8Array.subarray(i,i+a),t),a}}const pn="LYRICS200";async function fn(e,t={}){const a={mimeType:e.type,size:e.size};return e instanceof File&&(a.path=e.name),gn(e.stream(),a,t)}function gn(e,t,a={}){return bn(m(e,{fileInfo:"string"==typeof t?{mimeType:t}:t}),a)}async function kn(e,t,a={}){const i=new hn(e);return await vn(i,a),bn(u(e,{fileInfo:"string"==typeof t?{mimeType:t}:t}),a)}function bn(e,t){return async function(e,t){const{mimeType:a,path:i,url:n}=e.fileInfo,r=dn(a)||un(i)||un(n);return r||mn(`No parser found for MIME-type / extension: ${a}`),async function(e,t,a){if(!t){mn("Guess parser on content...");const a=new Uint8Array(4100);if(await e.peekBuffer(a,{mayBeLess:!0}),e.fileInfo.path&&(t=un(e.fileInfo.path)),!t){const e=await oe(a);if(!e)throw new Error("Failed to determine audio format");if(mn(`Guessed file type is mime=${e.mime}, extension=${e.ext}`),!(t=dn(e.mime)))throw new Error(`Guessed MIME-type not supported: ${e.mime}`)}}const i=await async function(e){switch(e){case"aiff":return new Mt;case"adts":case"mpeg":return new si;case"apev2":return new gt;case"asf":return new ra;case"dsf":return new Ki;case"dsdiff":return new Ji;case"flac":return new fa;case"mp4":return new qa;case"musepack":return new wi;case"ogg":return new zi;case"riff":return new Bi;case"wavpack":return new Gi;case"matroska":return new ln;default:throw new Error(`Unknown parser type: ${e}`)}}(t),n=new at(a);return await i.init(n,e,a??{}).parse(),n.toCommonMetadata()}(e,r,t)}(e,t)}function wn(e){const t={};for(const{id:a,value:i}of e)t[a]||(t[a]=[]),t[a].push(i);return t}function Tn(e){return void 0===e?0:1+Math.round(4*e)}function yn(e){return e?e.reduce(((e,t)=>t.name&&t.name.toLowerCase()in["front","cover","cover (front)"]?t:e)):null}async function vn(e,t={}){let a=e.fileSize;await async function(e){if(e.fileSize>=128){const t=new Uint8Array(3);return await e.randomRead(t,0,t.length,e.fileSize-128),"TAG"===new TextDecoder("latin1").decode(t)}return!1}(e)&&(a-=128,a-=await async function(e){if(e.fileSize>=143){const t=new Uint8Array(15);await e.randomRead(t,0,t.length,e.fileSize-143);const a=new TextDecoder("latin1").decode(t);if(a.slice(6)===pn)return Number.parseInt(a.slice(0,6),10)+15}return 0}(e)),t.apeHeader=await gt.findApeFooterOffset(e,a)}}},t={};function a(i){var n=t[i];if(void 0!==n)return n.exports;var r=t[i]={exports:{}};return e[i].call(r.exports,r,r.exports,a),r.exports}a.d=(e,t)=>{for(var i in t)a.o(t,i)&&!a.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:t[i]})},a.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),a.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},a(88)})();